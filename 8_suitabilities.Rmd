---
title: "Suitabilities"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---


! Koeta laskea uusi extrasato käyttäen perpix arvoja - sitten ei tartte maskata top99% arvoja pois
 --> tuskin vaikuttaa lopputulokseen mutta silti oikeaoppisempaa
 --> jos hankala, tee sen jälkeen kun olet saanut tuloksia



# Tutki luotuja rastereita --- tehty tässä skriptissä ja tallennettu
Rasteri siis näyttää kuinka suuri osuus solusta on kussakin kategoriassa
"fraction of cells where SI over 10" --> large area
"fraction of cells where SI over 75" --> small area

```{r}
# get rasters we created earlier

# Chunk 2
r_SIbased_unrestricted_cropland_fraction <-
  here("Data", "Intermediate_input", "Fraction_of_5arcmin_cell_where_SI_ge_threshold.tif") %>%
  rast()

r_SIbased_unrestricted_cropland_ha_perpix <-
  here("Data", "Intermediate_input", "unrestricted_amount_of_cropland_therecouldbe_whenSI_ge_threshold_ha_perpix.tif") %>% 
  rast()


# Chunk 3
r_SIbased_restricted_max_cropland_fraction <-
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_fraction_NAto0 <-
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold_NAto0.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_ha_perpix <-
  here("Data", "Intermediate_input","max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_ha_perpix_NAto0 <-
  here("Data", "Intermediate_input",
       "max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix_NAto0.tif") %>%
  rast()


# Chunk 4
r_potential_cropland_expansion_ha_perpix <-
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_ha_perpix.tif") %>% 
  rast()

r_potential_cropland_expansion_croplandmask_ha_perpix <-
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_ha_perpix.tif") %>% 
  rast()

r_potential_cropland_expansion_outside_croplands_ha_perpix <-
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_ha_perpix.tif") %>% 
  rast()


r_potential_cropland_expansion_fraction <-
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_fraction.tif") %>% 
  rast()

r_potential_cropland_expansion_croplandmask_fraction <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_fraction.tif") %>% 
  rast()

r_potential_cropland_expansion_outside_croplands_fraction <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_fraction.tif") %>% 
  rast()


# Chunk 5
r_cropland_expansion_percent <-
  here("Data", "Intermediate_input", "r_cropland_expansion_percent.tif") %>%
  rast()

r_cropland_expansion_percent_croplandmask <-
  here("Data", "Intermediate_input", "r_cropland_expansion_percent_croplandmask.tif") %>%
  rast()

r_cropland_expansion_percent_outside_croplands <-
  here("Data", "Intermediate_input","r_cropland_expansion_percent_outside_croplands.tif") %>%
  rast()



# Chunk 6
r_grazingland_reduction_percent <-
  here("Data", "Intermediate_input",
       "r_grazingland_reduction_percent.tif") %>% 
  rast()

r_grazingland_reduction_percent_croplandmask <-
  here("Data", "Intermediate_input","r_grazingland_reduction_percent_croplandmask.tif") %>% 
  rast()

r_grazingland_reduction_percent_outside_croplands <-
  here("Data", "Intermediate_input","r_grazingland_reduction_percent_outside_croplands.tif") %>% 
  rast()



# Chunk 7
r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix <-
  here("Data", "Intermediate_input","r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix.tif") %>% 
  rast()

r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix <-
  here("Data", "Intermediate_input",
       "r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix.tif") %>% 
  rast()

r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix <-
  here("Data", "Intermediate_input",
       "r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix.tif") %>% 
  rast()

r_protein_decrease_basedOnSI_grazers_mt_perpix <-
  here("Data", "Intermediate_input","r_protein_decrease_basedOnSI_grazers_mt_perpix.tif") %>% 
  rast()

r_optimized_grazing_protein_kg_perpix <- 
  here("Data", "Intermediate_input","r_optimized_grazing_protein_kg_perpix.tif") %>% 
  rast()

r_optimised_combined_protein_yield_kg_perpix <- 
  here("Data", "Intermediate_input", "r_optimised_combined_protein_yield_kg_perpix.tif") %>%
  rast()

r_optimized_combined_protein_yield_larger_percent <- 
  here("Data", "Intermediate_input", "r_optimized_combined_protein_yield_larger_percent.tif") %>%
  rast()

r_optimised_protein_crops_mt_perpix <- 
  here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix.tif") %>%
  rast()


# 
# 
# r_optimized_protein_yield_whendairy_combined_kg_perpix <-
#   here("Data", "Intermediate_input",
#        "r_optimized_protein_yield_whendairy_combined_kg_perpix.tif") %>%
#   rast()
# 
# r_optimized_protein_yield_larger_percent <-
#   here("Data", "Intermediate_input","r_optimized_protein_yield_larger_percent.tif") %>%
#   rast()
# 




##############
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1)

create_dynamic_index_map <- function(myraster, layer_num, main_title, 
                                     diff_breakvals = c(-Inf, 10, 20, 60, 80, 100, Inf),
                                     diff_breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")) {
  
  plt_dynamic_map <- 
    create_index_map(r_index = myraster[[layer_num]], 
                     tocrs = "ESRI:54030",
                     index_main_title = sprintf(main_title, layer_num),
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = diff_breakvals,
                     breaknames = diff_breaknames)
  return(plt_dynamic_map)
}


# Create a vector of threshold values from 0 to 99
threshold_values <- 0:99

# to make thigs even easier
#template_rast_5arcmin_cellsize <- cellSize(template_rast_5arcmin, unit = "ha")

```






# Chunk1 Calculate total agricultural land area (grazing land (gl) and cropland (cl))
Grazing land gl + cropland cl


```{r}
# Crop production raster
  ## convert NA to 0 to make upcoming calculations easier
r_physical_areas_crops_sum_ha_perpix_NAto0 <- 
  classify(r_physical_areas_crops_sum_ha_perpix, cbind(NA,0))



# Define a color palette for the plots
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1) 
```


# Chunk 2 Examine Zabel 2022 SI data

In this chunk, we are analyzing the Zabel 2022 SI data, specifically looking at version 3.0, overall suitability for the years 1980-2009 with current irrigation areas applied (only for food crops 1-17). The goal is to classify, aggregate, and resample the raster based on a threshold value.


```{r}
# Load SI data (requires .hdr file with the same name in the folder)
SI_30arcsec <- 
  here("Data", "Input", "Zabel22_SI", 
       "overall_suitability_subset_1to17_hist1980_2009_current_irr_areas_applied.bil") %>% 
  rast()
plot(SI_30arcsec)

# Aggregate and resample the SI data to 5 arcmin resolution
SI_5arcmin <- aggregate(SI_30arcsec, fact = 10) %>% 
  resample(., template_rast_5arcmin)
names(SI_5arcmin) <- "overall_suitability_subset1to17"
plot(SI_5arcmin)

# writeRaster(SI_5arcmin, filename = here("Data", "Input", "Zabel22_SI",
#                    "SI_5arcmin_overall_suitability_subset1to17_hist1980_2009_current_irr_areas_applied.tif"),
#             overwrite = T)







# Example showing what the next function does
# SI_over75 <- SI_30arcsec
# SI_over75[SI_over75 < 75] <- 0 # plot and see
# SI_over75[SI_over75 >= 75] <- 1 # plot and see
# SI_over75_fraction <- aggregate(SI_over75, fact = 10, na.rm = T) %>% 
#   resample(., template_rast_5arcmin)
# 
# global((SI_over75_fraction * template_rast_5arcmin_cellsize), "sum", na.rm = T)/1e6 # 895.09 --> classes differ by one

# function that produces raster that show how large fraction of a cell belongs to a spesific SI class

# Define a function to classify, aggregate, and resample the raster based on a threshold
f_classify_and_aggregate_resample <- function(threshold) {
  # Create a reclassification matrix with the given threshold
  rclmat <- matrix(c(threshold, Inf, 1), ncol = 3, byrow = TRUE)
  
  # Classify the raster using the reclassification matrix
  classified_raster <- classify(SI_30arcsec, rclmat, include.lowest = TRUE, others = 0)
  
  # Aggregate the classified raster by a factor of 10
  aggregated_raster <- aggregate(classified_raster, fact = 10, na.rm = TRUE)
  
  # Resample the aggregated raster using the template raster (5 arcmin resolution)
  resampled_raster <- resample(aggregated_raster, template_rast_5arcmin)
  
  # Return the resampled raster
  return(resampled_raster)
}

# Create a vector of threshold values from 0 to 99
threshold_values <- 0:99

# Apply the function for each threshold value and store the results in a list
result_list_SI_function <- 
  lapply(threshold_values, f_classify_and_aggregate_resample) # 1.5 hours

# Create a raster stack from the result list

r_SIbased_unrestricted_cropland_fraction <- rast(result_list_SI_function) 
names(r_SIbased_unrestricted_cropland_fraction) <- paste0("FracOfCell_whenSI_ge", threshold_values)




writeRaster(r_SIbased_unrestricted_cropland_fraction,
            here("Data", "Intermediate_input", "Fraction_of_5arcmin_cell_where_SI_ge_threshold.tif"),
            overwrite = T)


# ------------------------- the same in ha
r_SIbased_unrestricted_cropland_ha_perpix <-
  r_SIbased_unrestricted_cropland_fraction *
  cellSize(r_SIbased_unrestricted_cropland_fraction[[1]], unit = "ha")  



writeRaster(r_SIbased_unrestricted_cropland_ha_perpix,
            here("Data", "Intermediate_input", "unrestricted_amount_of_cropland_therecouldbe_whenSI_ge_threshold_ha_perpix.tif"),
            overwrite = T)

```





# Chunk 3: Investigate how much more cropland could be available based on SI

In this chunk, we analyze how much more cropland area could be available within the different Suitability Index (SI) classes, under the assumption that the combined share of grazing lands and croplands within a cell must remain constant.

Mandatory assumption:
r_SIbased_restricted_max_cropland_fraction <= r_fraction_gl + r_fraction_cl 
r_SIbased_restricted_max_cropland_fraction <= r_fraction_gl_cl_total_0toNA

"To avoid the expansion of agricultural land we assumed that the combined share of grazing lands and croplands within a cell must remain constant. For instance, if a cell initially contains 40% grazing lands and 20% croplands, only 60% of the land area can be allocated for agricultural purposes (e.g., 50% crops and 10% grazing lands, if that is what the suitability indices suggest)."

```{r}
# example
# r_SIbased_restricted_max_cropland_fraction1 <- 
#   ifel(r_SIbased_unrestricted_cropland_fraction[[1]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SIbased_unrestricted_cropland_fraction[[1]])


# do this for all the rasters
# Function to apply the ifel() operation on each raster layer
  # if unrestricted SI_fraction > current agricultural land fraction, return current agr land fraction (gl+cl fraction)
  # if it is the same or smaller, return the unrestricted SI_fraction
  # however, if unrestricted SI_fraction = NA, then return NA as well. This is because we only explore AgrLandMax with this function (how much cropland area could be expanded) and it cannot expande to areas where unrestricted SI = NA. 
  # Without this NA addition AgrLandMAx could be e.g. 16ha when unrestricted SI is NaN
f_limit_agrland <- function(raster_layer) {
  # Create a mask for NA and NaN values in the raster_layer
  na_mask <- is.na(raster_layer) | is.nan(raster_layer)
  
  # Apply the ifel() function to limit the values
  limited_agrland <- ifel(test = raster_layer > r_fraction_gl_cl_total, 
                          yes = r_fraction_gl_cl_total,
                          no = raster_layer)
  
  # Set the NA and NaN values in the original raster_layer to NA in the limited_agrland raster
  limited_agrland[na_mask] <- NA
  
  return(limited_agrland)
}


# f_limit_agrland <- function(raster_layer) {
#   ifel(raster_layer > r_fraction_gl_cl_total, # could be r_fraction_gl_cl_total_0toNA but this ok too
#        r_fraction_gl_cl_total,
#        raster_layer)
# }

# alternative (modify)
# f_limit_agrland <- function(i) {
#   ifel(r_SIbased_unrestricted_cropland_fraction[[i]] > r_fraction_gl_cl_total, 
#        r_fraction_gl_cl_total, 
#        r_SIbased_unrestricted_cropland_fraction[[i]])
# }



# Apply the function to all 100 raster layers in r_SIbased_unrestricted_cropland_fraction
tic()
r_SIbased_restricted_max_cropland_fraction<- 
  lapply(r_SIbased_unrestricted_cropland_fraction, f_limit_agrland) %>% 
  rast()
toc() # 50min

# Apply the function to all 100 raster layers in r_SIbased_unrestricted_cropland_fraction
# r_SIbased_restricted_max_cropland_fraction <- lapply(threshold_values, f_limit_agrland) %>% 
#   rast() # takes 30min if r_SIbased_unrestricted_cropland_fraction is not in RAM
names(r_SIbased_restricted_max_cropland_fraction) <- paste0("MaxFracOfCell_ge", threshold_values) 




# 
writeRaster(r_SIbased_restricted_max_cropland_fraction,
            here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold.tif"),
            overwrite = T)




r_SIbased_restricted_max_cropland_fraction[[5]] %>% plot()

# convert NA to 0 to make upcoming calculations easier --- check if this is needed
r_SIbased_restricted_max_cropland_fraction_NAto0 <- 
  classify(r_SIbased_restricted_max_cropland_fraction, cbind(NA,0), filename =
             here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold_NAto0.tif"),
           overwrite = T)



  # alternative function
# f_fraction_agrland_max_i <- function(i) {
#   r_SIbased_restricted_max_cropland_fraction_i <- 
#   ifel(r_SIbased_unrestricted_cropland_fraction[[i]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SIbased_unrestricted_cropland_fraction[[i]])
#   return(r_SIbased_restricted_max_cropland_fraction_i)
# }
# 
# r_SIbased_restricted_max_cropland_fraction_i <- lapply(threshold_values, f_fraction_agrland_max_i)
# names(r_SIbased_restricted_max_cropland_fraction_i) <- paste0("MaxFracOfCellOvr", threshold_values)

r_SIbased_unrestricted_cropland_fraction[[10]] %>% plot()
r_SIbased_restricted_max_cropland_fraction[[10]] %>% plot()

r_SIbased_unrestricted_cropland_fraction[[75]] %>% plot()
r_SIbased_restricted_max_cropland_fraction[[75]] %>% plot()






# ---------------------------------------- HECTARES
  # Calculate how much this potential cropland area would be in hectares  
 # saadaanko laskettua summa joka eri luokalle? Eli kuinka paljon voisi olla sellaista croplandia, jonka SI on 10, kuinka paljon sellaista jonka SI 20 jne
  # cellsize with one layer

r_SIbased_restricted_max_cropland_ha_perpix <-
  r_SIbased_restricted_max_cropland_fraction *
  cellSize(r_SIbased_restricted_max_cropland_fraction[[1]], unit = "ha") # Cellsize constant 

writeRaster(r_SIbased_restricted_max_cropland_ha_perpix, filename =
              here("Data", "Intermediate_input","max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix.tif"),
            overwrite = T)

r_SIbased_restricted_max_cropland_ha_perpix_NAto0 <- 
  classify(r_SIbased_restricted_max_cropland_ha_perpix, cbind(NA,0), filename =
             here("Data", "Intermediate_input",
                  "max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix_NAto0.tif"),
           overwrite = T) 




# Example demonstrating the output of the function f_limit_agrland
testiext <- ext(26.7, 26.9, 61.6, 63.6)
#testiext <- ext(26.7, 26.9, 51.6, 53.6) # use this if you want to see what happens when there is more land based on SI 
ex_tibble <- tibble(
  SIbased_unrestricted_cropland_ha_perpix = (crop(r_SIbased_unrestricted_cropland_ha_perpix[[10]], testiext) %>% values() %>% as.numeric()),
  glcl_haPerpix = (crop((r_fraction_gl_cl_total * cellSize(r_fraction_gl_cl_total, unit = "ha")), testiext) %>% values() %>% as.numeric()),
  SIbased_restricted_cropland_ha_perpix = (crop(r_SIbased_restricted_max_cropland_ha_perpix[[10]], testiext) %>% values() %>% as.numeric()))
ex_tibble




```






# Chunk 4 Potential cropland expansion in current production areas and beyond 

r_potential_cropland_expansion_ha_perpix 
-  rasteri kuvaa potentiaalista viljelymaan laajentumista hehtaareina jokaiselle pikselille laskettuna maksimaalisen viljelysmaan ja nykyisen viljelysmaan välisenä erona.


r_potential_cropland_expansion_fraction 
 -rasteri kuvaa potentiaalista viljelymaan laajentumista suhteessa nykyiseen viljelysmaan osuuteen (fraktioina). Laskettu maksimaalinen viljelysmaan - nykyisen viljelysmaan välisenä erona.


```{r}
# Calculate how much more cropland there could be in cells (croplands already use a lot of very suitable  land). Thus cropland area could be expanded by this many hectares at most (per pixel)
r_potential_cropland_expansion_ha_perpix  <-
  r_SIbased_restricted_max_cropland_ha_perpix_NAto0  - r_physical_areas_crops_sum_ha_perpix_NAto0 

# land mask (not completely mandatory but all the oceans are 0 if we dont do this)
r_potential_cropland_expansion_ha_perpix <- 
  mask(r_potential_cropland_expansion_ha_perpix, r_fraction_gl_cl_total_0toNA )

  # create reclassification matrix#
# rclmat_neg_to_zeros <- matrix(c(-Inf, 0, 0), ncol = 3, byrow = TRUE)  # mp MA ---- convert negative to 0 instead -- or do not convert at all!
  # convert negative values to zeros as we are only interested on how much cl could increase and we are not saying that current crop production concentrates on wrong areas -- in this article only potential increment are studied

# r_potential_cropland_expansion_ha_perpix <-
#   classify(r_potential_cropland_expansion_ha_perpix , ################# kannattaa miettiä jättäiskö neg arvot kuitenkin tänne -- näyttäis missä kandee vähentää cl
#            rclmat_neg_to_zeros, right = TRUE)

# same as the slower option (5x more time)
# r_potential_cropland_expansion_ha_perpix _positive2 <- r_potential_cropland_expansion_ha_perpix 
# r_potential_cropland_expansion_ha_perpix _positive2[r_potential_cropland_expansion_ha_perpix _positive2 < 0] <- NA


# --------------------------------------------------------------- hectares (mask) 
# Cropland expansion on cells where there is cropland
r_potential_cropland_expansion_croplandmask_ha_perpix <-
  mask(r_potential_cropland_expansion_ha_perpix, 
       r_physical_areas_crops_sum_ha_perpix)

# Cropland expansion on cells where SPAM crops are not growing
r_potential_cropland_expansion_outside_croplands_ha_perpix  <-
  mask(r_potential_cropland_expansion_ha_perpix, 
       r_physical_areas_crops_sum_ha_perpix, inverse = T)



writeRaster(r_potential_cropland_expansion_ha_perpix, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_ha_perpix.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_croplandmask_ha_perpix, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_ha_perpix.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_outside_croplands_ha_perpix, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_ha_perpix.tif"),
            overwrite =T)



# ----------------------------------------------------- fractions (was ha above)
# Etsi fraction jossa voitais tuottaa lisää. Eli potentiaalinen - nykyinen ala. 
# r_SIbased_restricted_max_cropland_fraction_NAto0 vai r_SIbased_restricted_max_cropland_fraction?
r_potential_cropland_expansion_fraction  <-
  r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0 # jos pos voitaisiin tuottaa lisää. Jos neg nyt tuotetaan jo enemmän kuin SI puitteissa ehkä kannattaisi
  
r_potential_cropland_expansion_fraction <- 
  mask(r_potential_cropland_expansion_fraction, r_fraction_gl_cl_total_0toNA)



  # convert negative to zeros
  # note! When SI + + this potential fraction - - 
# r_potential_cropland_expansion_fraction <-
#   classify(r_potential_cropland_expansion_fraction,
#            rclmat_neg_to_zeros, right = FALSE) # ---- what if we dont del these yet?

  # mask to croplands to illustrate (and to calculage global sums)
r_potential_cropland_expansion_croplandmask_fraction <-
  mask(r_potential_cropland_expansion_fraction,
       r_physical_areas_crops_sum_ha_perpix)

r_potential_cropland_expansion_outside_croplands_fraction <-
  mask(r_potential_cropland_expansion_fraction,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)



writeRaster(r_potential_cropland_expansion_fraction, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_fraction.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_croplandmask_fraction, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_fraction.tif"),
            overwrite =T)

writeRaster(r_potential_cropland_expansion_outside_croplands_fraction, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_fraction.tif"),
            overwrite =T)


```





# Chunk 5 Potential for increased agricultural production and cropland expansion

r_cropland_expansion_percent <-
  100 * r_potential_cropland_expansion_fraction / 
  r_fraction_cl_NAto0 ---- should this be 0toNA instead? to avoid Inf vals..
 

```{r}
# ------------------------------------ How much cropland could increase in %?
  # Calculate how much more croplands there could be in a cell - express in %
  # e.g 100 * (0.45-0.30)/0.30 = 50% 
  # reads as: In a cell there could be 50% more cropland area compared to current crop production area
  # note that r_potential_cropland_expansion_fraction = r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0

r_cropland_expansion_percent <- 
  100 * r_potential_cropland_expansion_fraction / 
  r_fraction_cl_NAto0 # yield Inf valueS when there is no cl


r_cropland_expansion_percent_croplandmask <- 
  mask(r_cropland_expansion_percent,
       r_physical_areas_crops_sum_ha_perpix)


r_cropland_expansion_percent_outside_croplands <- 
  mask(r_cropland_expansion_percent,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)
# r_potential_cropland_expansion_ratio <- r_potential_cropland_expansion_fraction / r_fraction_cl_NAto0 


writeRaster(r_cropland_expansion_percent,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent.tif"), overwrite = T)

writeRaster(r_cropland_expansion_percent_croplandmask,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent_croplandmask.tif"), overwrite = T)

writeRaster(r_cropland_expansion_percent_outside_croplands,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent_outside_croplands.tif"), overwrite = T)



# ------------------------------------------------------------------------- plot

# Cropland expansion when areas where SI ≥ %d would be converted from grazing lands to croplands.\nNegative if current cropland area > it should be based on SI "
# !!!! ehkä nimi voisi olla "Changes in cropland areas depending on how..."

(plt_cropland_expansion33 <- 
    create_dynamic_index_map(myraster = r_cropland_expansion_percent,
                             layer_num = 33,
                             main_title = "Cropland expansion depending on how strict we are with land suitability 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



(plt_cropland_expansion75 <- 
    create_dynamic_index_map(myraster = r_cropland_expansion_percent,
                             layer_num = 75,
                             main_title = "Cropland expansion depending on how strict we are with land suitability 75",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))








# croplandmask -- miksi näyttää että on enemmän alaa kun maskaa croplandmaskin?
(plt_cropland_expansion_croplandmask33 <-
    create_dynamic_index_map(myraster = r_cropland_expansion_percent_croplandmask,
                             layer_num = 33,
                             main_title = "Cropland expansion depending on how strict we are with land suitability - croplandmask 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



(plt_cropland_expansion_outside_croplands33 <-
    create_dynamic_index_map(myraster = r_cropland_expansion_percent_outside_croplands,
                             layer_num = 33,
                             main_title = "Cropland expansion depending on how strict we are with land suitability - outside croplands 33",
                             diff_breakvals = c(-Inf, -50, -10, 0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))






```




# Chunk 6: Impact of cropland expansion on grazing land and protein production

If high suitability areas are allocated for crop cultivation, these areas will be taken away from some other land use. Are these areas currently used as grazing land? How much less protein would be produced from grazing lands if the full potential of high suitability areas is utilized for crop cultivation?



```{r}
# Calculate the fraction of grazing land decline by subtracting the current cropland fraction from the maximum allowable cropland fraction (done above)
# r_potential_grazingland_reduction_fraction <- r_potential_cropland_expansion_fraction # only pos vals
# 
# 
# # Mask the grazing land declines to only areas with grazing land -- why?
#   # global sum of this  is the same with r_potential_cropland_expansion_fraction
#   # also plot is similar - just NA vals is different
# r_potential_grazingland_reduction_fraction_glmask <- 
#   mask(r_potential_grazingland_reduction_fraction,
#        r_fraction_gl_0toNA)
# 
# 
# # plot(r_potential_cropland_expansion_fraction$MaxFracOfCellOvr75) # koko maailma ja meret
# # plot(r_potential_grazingland_reduction_fraction_glmask$MaxFracOfCellOvr75) # vain gl maa-alueet
# 
# 
# 
# # ------------------------------------------------------------------ in hactares
# r_potential_grazingland_reduction_ha_perpix <-
#   r_potential_grazingland_reduction_fraction * 
#   cellSize(r_potential_grazingland_reduction_fraction[[1]], unit ="ha")
# 
# r_potential_grazingland_reduction_croplandmask_ha_perpix <-
#   mask(r_potential_grazingland_reduction_ha_perpix,
#        r_physical_areas_crops_sum_ha_perpix)
# 
# r_potential_grazingland_reduction_outside_croplands_ha_perpix <-
#     mask(r_potential_grazingland_reduction_ha_perpix,
#        r_physical_areas_crops_sum_ha_perpix, inverse = T)
# 


# -------------------------------- How much grazing lands could be reduced in %?
  # Calculate how much less grazing lands there should be in a cell - express in %
  # e.g 100 * (0.45-0.30)/0.40 = 37.5%
  # reads as: In a cell there could be 37.5% less gl area compared to current gl area
  # note that r_potential_cropland_expansion_fraction = r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0

r_grazingland_reduction_percent <- 
  100 *  r_potential_cropland_expansion_fraction/ # which iis the same as r_potential_grazingland_reduction_fraction
  r_fraction_gl # no need for NAto0 as then these would be outside gl areas


r_grazingland_reduction_percent_croplandmask <- 
  mask(r_grazingland_reduction_percent,
       r_physical_areas_crops_sum_ha_perpix)


r_grazingland_reduction_percent_outside_croplands <- 
  mask(r_grazingland_reduction_percent,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)




writeRaster(r_grazingland_reduction_percent,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent.tif"), overwrite = T)

writeRaster(r_grazingland_reduction_percent_croplandmask,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent_croplandmask.tif"), overwrite = T)

writeRaster(r_grazingland_reduction_percent_outside_croplands,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent_outside_croplands.tif"), overwrite = T)







# -------------------------------------------------Plot (this is now in figures)
# ex plot -- raster was r_how_many_percent_gl_should_decline_0toNA but then it masks out many important gl areas

(plt_grazingland_reduction33 <- 
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent,
                             layer_num = 33,
                             main_title = "Grazing land reduction depending on how strict we are with land suitability 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))





# croplandmask -- miksi näyttää että on enemmän alaa kun maskaa croplandmaskin?

(plt_grazingland_reduction75 <- 
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent,
                             layer_num = 75,
                             main_title = "Grazing land reduction depending on how strict we are with land suitability 75",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))




(plt_grazingland_reduction_croplandmask33 <-
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent_croplandmask,
                             layer_num = 33,
                             main_title = "Grazing land reduction depending on how strict we are with land suitability - croplandmask 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



(plt_grazingland_reduction_outside_croplands33 <-
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent_outside_croplands,
                             layer_num = 33,
                             main_title = "Grazing land reduction depending on how strict we are with land suitability  - outside croplands 33",
                             diff_breakvals = c(-Inf, -50, -10, 0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))








```


# Chunk 7: How much the efficiency changes?

Original protein from livestock and crops  = r_protein_combined_kg_perpix   ---> this set the base level
Optimized protein from livestock and crops = 
  increased protein from crops - decreased protein from livestock (different species) =
  new optimized protein yield of crops - new optimized protein yield of livestock
  
Then,
100 * (Optimized_prot - Original_prot) / Original_prot
tells how much more could be produced in %

- Consider areas where grazing land (gl can be converted to cl)
- Consider areas outside current cl areas


Example calculations:
Eläimet käyttävät 40% solusta ja tuottavat proteiinia solussa alun perin noin 35 kg/ha. Solun koko 8100ha. Eläimet tuottavat siis alun perin 113400 kg/pix
Kuten yllä, kasvit käyttävät 30% solusta, mutta SI mukaan voisivat käyttää 45%. Näin ollen 15% solun koosta pitäisi ottaa pois eläimiltä ja siirtää kasveille.

Viljojen uusi sato on siis alkuperäinen sato * (0.30 + (0.45-0.30))/0.30 ja 
eläinproteiinin uusi sato  alkuperäinen sato * (0.40 - (0.45-0.30))/0.40, jossa
(0.45-0.30) = fraction_gl_decrease

```{r}
# ------------------------------------------------------ optimized livestock

# eläinprotskun määrä voi ainoastaan vähentyä niillä alueilla, joilla on nykyään grazing landia  mutta ei croplandia
  # Jos cl ei käännetä gl, proteiinin määrä pysyy ennallaan (decrease = 0)
  # Explore first how much AGB based protein could decrease in current gl areas where crops could expand
################################################################################
r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix <- # eli cl alueiden ulkopuolella --- = gl alueilla -- tämä on tiedossa
  (r_protein_from_065xAGB_kg_ha$current_herd_str/1000) *
  cellSize(r_protein_from_065xAGB_kg_ha$current_herd_str, unit = "ha") *
  r_potential_cropland_expansion_outside_croplands_fraction # [0,1] as no current cl outside cl


# check this
# test1 <- global(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix, "sum", na.rm=T)/1e6
# test1 <- round(test1, 1) # from 4.2 mmt to 0 (cannot decrease below zero on grazing lands)
################################################################################



# Then the trickier part: how much AGB prot can decrease in curret cropland areas?
  # jos pikselissä cl ja gl proteiini tiedossa, vähennys helppo laskea
  # jos pikselissä cl tiedossa mutta gl perusteinen protsku EI tiedossa, pitää käyttää regressiota

################################################################################
r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix <-
  (r_protein_from_065xAGB_kg_ha$current_herd_str / 1000) *
  cellSize(r_protein_from_065xAGB_kg_ha$current_herd_str, unit = "ha") *
  
  mask(r_potential_cropland_expansion_croplandmask_fraction,
       r_protein_from_065xAGB_kg_ha$current_herd_str)

# check this
# test2 <- global(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix, "sum", na.rm=T)/1e6
# test2 <- round(test2, 1) # from 6.8 to -2.8
################################################################################


################################################################################
r_fraction_cl_where_amount_ofAGBprot_not_known <- 
  mask(r_fraction_cl_0toNA,
       r_protein_from_065xAGB_kg_ha$current_herd_str, 
       inverse = T) # näille alueille pitää laskea AGB proteiini regression avulla


r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix <-
  (r_predicted_AGB_based_protein_yield_on_cl_where_agb_prot_yield_not_known_kg_ha/1000) *
  cellSize(r_predicted_AGB_based_protein_yield_on_cl_where_agb_prot_yield_not_known_kg_ha, unit = "ha") *
  
  mask(r_potential_cropland_expansion_croplandmask_fraction,
       r_fraction_cl_where_amount_ofAGBprot_not_known)

#check this
# test3 <- global(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix, "sum",na.rm=T)/1e6
# test3 <- round(test3, 1)
# View(test3)

################################################################################

# Combine 
r_protein_decrease_basedOnSI_grazers_mt_perpix <-
  classify(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix, cbind(NA,0))+
  classify(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix ,cbind(NA,0)) +
  classify(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix, cbind(NA,0))

r_protein_decrease_basedOnSI_grazers_mt_perpix <-
  mask(r_protein_decrease_basedOnSI_grazers_mt_perpix, 
       r_fraction_gl_cl_total_0toNA)
# mostly zero (median = 0) but decrease < 0 when SI high, which means that animal protein increases

#check this
# test4 <-
#   global(r_protein_decrease_basedOnSI_grazers_mt_perpix, "sum", na.rm=T)/1e6
# test4 <- round(test4, 1)
# View(test4)




# gl area can decrease only in areas where there is some gl. Therefore mask to areas where there is gl 
# r_optimized_dairy_protein_yield_kg_perpix <- # check the a4 notebook for this
#   ((r_fraction_gl_0toNA - r_potential_cropland_expansion_fraction ) / # was r_potential_grazingland_reduction_fraction_glmask
#      r_fraction_gl_0toNA) * # if this row gets value = 1, then no changes
#   r_protein_from_065xAGB_kg_perpix$dairy
# 
# 
# r_optimized_dairy_protein_yield_kg_perpix # !!!!!!!!!!!!!! tarkista tämä --> jos gl kasvaa nii paljonko uusi sato näillä aluella? Sama sato kuin pikselin keskimääräinen sato? Näin tehty nyt


## Convert negative values to zeros
# r_optimized_dairy_protein_yield_kg_perpix <-
#   classify(r_optimized_dairy_protein_yield_kg_perpix, ####################### maybe need to be removed?
#            rclmat_neg_to_zeros, right = TRUE)

############################## new
  # this is now done based on yields per hectare 

# onko tämä väärin --> selvitä minkä verran AGB prot voisi kasvaa cl alueilla jotka voitaisiin valjastaa gl käyttöön kun SI on riittävän pieni -- eli pitää tehdä samalla tavalla kuin crops kanssa
# r_grazing_protein_decrease_basedOnSI_kg_perpix <-
#   r_protein_from_065xAGB_kg_ha$current_herd_str  * 
#   cellSize(r_protein_from_065xAGB_kg_ha$current_herd_str, unit = "ha") *
#   r_potential_cropland_expansion_fraction
# 
# names(r_grazing_protein_decrease_basedOnSI_kg_perpix) <- 
#   paste0("prot_kgpix_SI", threshold_values)


# optimised animal protein production = original protein raster - raster showing how much animal prot should decrease (increses if there are negative values in r_grazing_protein_decrease_basedOnSI_kg_perpix)
  # = r_protein_from_065xAGB_kg_perpix$current_herd_str  - r_grazing_protein_decrease_basedOnSI_kg_perpix 
r_optimized_grazing_protein_kg_perpix <-
  classify(r_protein_from_065xAGB_kg_perpix$current_herd_str, cbind(NA,0)) - 
  (r_protein_decrease_basedOnSI_grazers_mt_perpix*1000) # -(-) = +

names(r_optimized_grazing_protein_kg_perpix) <- 
  paste0("prot_kgpix_SI", threshold_values)


  # check
r_optimized_grazing_protein_kg_perpix[[5]] %>% 
  plot(., main = "When SI>5 vals 'd be used for crops, there'd be A LOT of cl and little gl")
r_optimized_grazing_protein_kg_perpix[[95]] %>% 
  plot(., main = "When SI>95 vals 'd be used for crops, there'd be much less cl to convert and thus no gl dec")
r_protein_from_065xAGB_kg_perpix$current_herd_str %>% 
  plot(., main = "Original protein production raster (current herd)")


#check this
test5 <- global(r_optimized_grazing_protein_kg_perpix, "sum", na.rm=T)/1e9
test5 <- round(test5, 1)
View(test5)



writeRaster(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix.tif"),
            overwrite =T)


writeRaster(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix.tif"),
            overwrite =T)



writeRaster(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix.tif"),
            overwrite =T)


writeRaster(r_protein_decrease_basedOnSI_grazers_mt_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_protein_decrease_basedOnSI_grazers_mt_perpix.tif"),
            overwrite =T)



writeRaster(r_optimized_grazing_protein_kg_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_optimized_grazing_protein_kg_perpix.tif"),
            overwrite =T)


# ------------------------------------------------------ optimized crops
# cl area can increase in areas outside current cl areas. 
# these areas can be found as follows: if r_fraction_cl_NAto0 == 0 but r_fraction_gl_declines_masked_to_gl > 0, there can be new cl.
# We assume that crop yield on those areas can be predicted using linear regression where crop protein yield is explained with SI.


# test2 - calculate new "extra" protein yield on croplands in case only areas with SI >= 75 can be used
# r_extra_protein_crops_test2_croplands_75 <-
#   f_raster_without_outliers(r_prot_allcrops_sum_kg_ha) * # 21 - 4235 kg per ha
#   cellSize(r_prot_allcrops_sum_kg_ha, unit = "ha")*
#   r_potential_cropland_expansion_croplandmask_fraction[[75]] # -1 to 1
# 
# global(r_extra_protein_crops_test2_croplands_75, "sum", na.rm=T)/1e9 # -102 mmt	
# test 2 mukaan siis sato pienenee noin 102mmt eli 274 - 102 = 172 mmt olisi uusi sato 
# tämä uusi sato on noin 63% alkuperäisestä proteiinisadosta
# kun SI >= 75, cl ala pienenee 975 - 450 Mha = 525, mikä on noin 54% alkuperäisestä alasta
# ihan järkeenkäypä luku: ala pienenee suhteessa enemmän kuin proteiinisato, koska SI high alueet tuottavat paljon protskua






# Tee per layeri?
# f_optimized_protein_yield_crops <- function(layer_index) {
#   
#   r_optimized_protein_yield_crops_mt_perpix_layer <- 
#     ifel(test = r_fraction_cl_NAto0 == 0 & r_potential_cropland_expansion_fraction[[layer_index]] > 0, # if there is possibility to expand cl on gl areas (# pitääkö tämän ekan olla nimenomaan nolla vai ennemmin niin, jos ei ole suurempi kuin nolla?)
#          yes = ((r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha/ 1000) *
#                   cellSize(r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha, unit = "ha")*
#                   r_potential_cropland_expansion_outside_croplands_fraction[[layer_index]]), # multiply with approximated yield 
#          
#          no = (((r_fraction_cl_NAto0 + r_potential_cropland_expansion_fraction[[layer_index]]) / 
#                  r_fraction_cl_NAto0) * r_prot_allcrops_sum_mt_perpix))
#   
#   return(r_optimized_protein_yield_crops_mt_perpix_layer)
# }
# 
# 
# 
# 
# 
# # kok10 <- f_optimized_protein_yield_crops(10)
# # kok99 <- f_optimized_protein_yield_crops(99)
# # 
# # global(kok10, "sum", na.rm = T)/1e6
# # global(kok99, "sum", na.rm = T)/1e6
# 
# # Apply the function for each layer in r_fraction_gl_declines_masked_to_gl
# result_list_optimized_protein_yield_crops <- 
#   lapply(1:nlyr(r_potential_cropland_expansion_fraction),
#          f_optimized_protein_yield_crops)
# 
# # Create a raster stack from the result list
# r_optimized_protein_yield_crops_mt_perpix <- rast(result_list_optimized_protein_yield_crops)



# f_new_protein_yield_crops_mt_perpix <- function(layer_index) {
#   
#   r_protein_yield_increase_crops_mt_perpix_layer <- 
#     
#     ifel(test = r_fraction_cl_NAto0 == 0 & r_potential_cropland_expansion_fraction[[layer_index]] > 0, # if there is possibility to expand cl on gl areas (# pitääkö tämän ekan olla nimenomaan nolla vai ennemmin niin, jos ei ole suurempi kuin nolla?)
#          yes = ((r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha/ 1000) *
#                   cellSize(r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha, unit = "ha")*
#                   r_potential_cropland_expansion_outside_croplands_fraction[[layer_index]]), # multiply with approximated yield 
#          
#          no =   (f_raster_without_outliers(r_prot_allcrops_sum_kg_ha) * # 21 - 4235 kg per ha
#            cellSize(r_prot_allcrops_sum_kg_ha, unit = "ha")*
#            r_potential_cropland_expansion_croplandmask_fraction[[layer_index]] / 
#            1000))
#   
#   return(r_protein_yield_increase_crops_mt_perpix_layer)
# }
# 
# 
# result_list_protein_yield_increase_basedOnSI <- 
#   lapply(1:nlyr(r_potential_cropland_expansion_fraction), 
#          f_new_protein_yield_crops_mt_perpix)
# 
# r_protein_yield_increase_basedOnSI_mt_perpix <- 
#   rast(result_list_protein_yield_increase_basedOnSI)


r_protein_increase_basedOnSI_crops_outside_cl_mt_perpix <-
  (r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha/ 1000) *
     cellSize(r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha, unit = "ha")*
     r_potential_cropland_expansion_outside_croplands_fraction



r_protein_increase_basedOnSI_crops_croplandmask_mt_perpix <-
  r_prot_allcrops_sum_kg_ha *
  cellSize(r_prot_allcrops_sum_kg_ha, unit = "ha") *
  r_potential_cropland_expansion_croplandmask_fraction / # -1 to 1
  1000


# convert NA to 0 and combine 
r_protein_increase_basedOnSI_crops_mt_perpix <-
  classify(r_protein_increase_basedOnSI_crops_croplandmask_mt_perpix, cbind(NA,0)) +
  classify(r_protein_increase_basedOnSI_crops_outside_cl_mt_perpix, cbind(NA,0))
 # 520.1s






# df_SI <- df_SI %>% 
#   mutate(Protein_increase_basedOnSI_crops_mmt =
#            pull(global(r_protein_increase_basedOnSI_crops, "sum", na.rm=T)/1e6))
# 
# df_SI <- df_SI %>% 
#   mutate(Protein_increase_basedOnSI_outside_cl_mmt =
#            pull(global(r_protein_increase_basedOnSI_crops_outside_cl_mt_perpix, "sum", na.rm=T)/1e6))








# ------------------------------------ compare original yield to optimized yield
# r_original_protein_yield_whendairy_combined_kg_perpix <- 
#   classify(r_protein_combined_kg_perpix$`when Dairy cattle`, cbind(NA,0)) +
#   1000 * classify(r_prot_allcrops_sum_mt_perpix, cbind(NA,0))


# optimised yield crops
  # optimoitu sato on vanha sato + mahdollinen lisäsato (joka voi olla neg)
  # = r_prot_allcrops_sum_mt_perpix + r_protein_increase_basedOnSI_crops
r_optimised_protein_crops_mt_perpix <-
  classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0)) +
  r_protein_increase_basedOnSI_crops_mt_perpix

names(r_optimised_protein_crops_mt_perpix) <-   
    paste0("cropProt_mtpix_SI", threshold_values)


writeRaster(r_optimised_protein_crops_mt_perpix,
            here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix.tif"),
            overwrite = T)



# optimised combined yield (maybe give names?)
r_optimised_combined_protein_yield_kg_perpix <-
   classify(r_optimized_grazing_protein_kg_perpix, cbind(NA,0)) +
   1000*r_optimised_protein_crops_mt_perpix




r_optimized_combined_protein_yield_larger_percent <-
  100*(r_optimised_combined_protein_yield_kg_perpix - r_protein_combined_kg_perpix)/
  r_protein_combined_kg_perpix




# 
writeRaster(r_optimised_combined_protein_yield_kg_perpix,
            filename = here("Data", "Intermediate_input",
                            "r_optimised_combined_protein_yield_kg_perpix.tif"),
            overwrite= T)

writeRaster(r_optimized_combined_protein_yield_larger_percent,
            filename = here("Data", "Intermediate_input",
                            "r_optimized_combined_protein_yield_larger_percent.tif"),
            overwrite= T)








# # test plot ------ change no change class to something else
(plt_r_optimized_protein_yield_larger75 <-
      create_index_map(r_index = r_optimized_combined_protein_yield_larger_percent[[75]],
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised combined protein production compared to original combined protein production \n when SI >= 75",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, -50, 0, 20, 50, 100, Inf),
                     breaknames = c("-100 to -50", "-50 to -0",  "0 to 20", "20-50", "50-100", ">100")))






(plt_r_optimized_protein_yield_larger33 <-
      create_index_map(r_index = r_optimized_combined_protein_yield_larger_percent[[33]],
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised combined protein production compared to original combined protein production \n when SI >= 33",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, -50, 0, 20, 50, 100, Inf),
                     breaknames = c("-100 to -50", "-50 to -0",  "0 to 20", "20-50", "50-100", ">100")))






```

# Calculate global sums

```{r}
# note gl, cl and gl+cl areas are the same regardless if NAto0 or 0toNA rasters are used instead
  # chunks 2-3
df_SI <-
  tibble(
    SI_class = threshold_values,
    
    Current_grazingland_area_total_Mha = 
           pull(global((r_fraction_gl * cellSize(r_fraction_gl, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    Current_cropland_area_total_Mha = 
           pull(global((r_fraction_cl * cellSize(r_fraction_cl, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    Current_agricultural_total_area_Mha = 
           pull(global((r_fraction_gl_cl_total * cellSize(r_fraction_gl_cl_total, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    
    SI_based_unrestricted_cropland_Mha = 
      pull(global(r_SIbased_unrestricted_cropland_ha_perpix, "sum", na.rm=T)/1e6),
    
    SI_based_restricted_max_cropland_Mha = 
      pull(global(r_SIbased_restricted_max_cropland_ha_perpix, fun = "sum", na.rm = T)/1e6)) 




# cropland expansions Chunk 4
df_SI <- df_SI %>% 
  mutate(potential_cropland_expansion_Mha = 
           pull(global(r_potential_cropland_expansion_ha_perpix, 
                       fun = "sum", na.rm = T)/1e6),
         potential_cropland_expansion_outside_cl_Mha = 
           pull(global(r_potential_cropland_expansion_outside_croplands_ha_perpix,
                       fun = "sum", na.rm = T)/1e6 ),
         potential_cropland_expansion_cl_mask_Mha = 
           pull(global(r_potential_cropland_expansion_croplandmask_ha_perpix,
                       fun = "sum", na.rm = T)/1e6))

# Chunks 5-6 deak with percents -- no need to add them to this df



# Chunk 7 protein

  # animal based protein from AGB (add different masks here?)
df_SI <- df_SI %>% 
  mutate(Protein_from_AGB_original_mmt = 
           pull(global(r_protein_from_065xAGB_kg_perpix$current_herd_str , "sum", na.rm=T)/1e9),
         Protein_from_AGB_decrease_mmt =
           pull(global(r_protein_decrease_basedOnSI_grazers_mt_perpix, "sum", na.rm=T)/1e6),
         Protein_from_AGB_optimised_mmt = 
           pull(global(r_optimized_grazing_protein_kg_perpix, "sum", na.rm = T)/1e9))


  # crop protein (add masks here?)
df_SI <- df_SI %>% 
  mutate(Original_crop_protein_production_mmt = 
           pull(global(r_prot_allcrops_sum_mt_perpix, "sum", na.rm=T)/1e6),
         
         Optimised_crop_protein_mmt = 
           pull(global(r_optimised_protein_crops_mt_perpix, "sum", na.rm =T)/1e6))



# Optimised combined protein
df_SI <- df_SI %>% 
  mutate(Optimised_combined_protein_mmt = 
           pull(global(r_optimised_combined_protein_yield_kg_perpix,
                       "sum", na.rm =T)/1e9))




# Save df data
write.csv(df_SI,
          here("Data", "Output", "Total_sums_cropland_expansion_and_optimised_protein_production.csv"))

library(openxlsx) 
write.xlsx(df_SI, 
           here("Data", "Output", "Total_sums_cropland_expansion_and_optimised_protein_production.xlsx"),
           rowNames = FALSE)
```




# Ggplot

```{r}
df_rounded <- round(df_SI, 1)
# Suodata sarakkeet, joiden nimessä on "Mha"

Mha_columns <- grep("Mha", colnames(df_SI), value = TRUE)
prot_columns <- grep("(?i)protein", colnames(df_SI), value = TRUE)


# Muuta df_SI:n pitkäksi muodoksi
df_SI_long_Mha <- df_SI %>%
  dplyr::select(SI_class, all_of(Mha_columns)) %>%
  # dplyr::select(-c(potential_grazingland_reduction_Mha,
  #                  potential_grazingland_reduction_cl_mask_Mha,
  #                  potential_grazingland_reduction_outside_cl_Mha   )) %>% 
  pivot_longer(cols = -SI_class, names_to = "Variable", values_to = "Value")


df_SI_long_protein <- df_SI %>%
  dplyr::select(SI_class, all_of(prot_columns))  %>% 
  pivot_longer(cols = -SI_class, names_to = "Variable", values_to = "Value")


# HECTARES
plt_hectares_line <-
  ggplot(df_SI_long_Mha %>% filter(SI_class>0), aes(x = SI_class, y = Value, color = Variable)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0, 100, 5), name = "SI Class") +
  scale_y_continuous(name = "Million of ha") +
  labs(title = "Comparison of production areas in different SI classes",
       subtitle = "Agricultural land available for crop production at SI threshold") +
  theme_classic() #+ theme(legend.position = "bottom")

plt_hectares_line

# PROTEIN
plt_protein_line <- 
  ggplot(df_SI_long_protein %>% filter(SI_class>0), aes(x = SI_class, y = Value, color = Variable)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0, 100, 5), name = "SI Class") +
  scale_y_continuous(name = "Protein, million tons") +
  labs(title = "Comparison of protein production capacity in different SI classes",
       subtitle = "Total protein production at SI threshold") +
  theme_classic() # + theme(legend.position = "bottom") # Siirrä legenda kuvaajan alle

plt_protein_line # about 4x more protein, if we convert all gl that are suitable for crop production, to cl





# combine
# library(cowplot)
# # Yhdistä kaksi kuvaajaa
# combined_plot <- plot_grid(plt_hectares_line, plt_protein_line, ncol = 2, labels = c("A", "B"), align = "hv")
# # Tulosta yhdistetty kuvaaja
# combined_plot



ggsave(plt_hectares_line, filename = here("Figures", "Linegraph_potential_cl_area_hectares.png"))
ggsave(plt_protein_line, filename = here("Figures", "Linegraph_potential_protein_production.png"))
# ggsave(combined_plot, filename = here("Figures", "Linegraph_combined_productions.pdf"))

```




# SAVE RD

```{r}
#save.image(file='suitability_script_new_method.RData')
#save.image(file='suitability_script_neg_not_removed.RData')

#save.image(file='suitability_script.RData')
#load(file='suitability_script.RData')
#load(file='suitability_script_neg_not_removed.RData')
```

# Other global sums (old)

```{r}

# add this elsewhere     agrLandMax_fraction_mean = pull(global(classify(r_SIbased_restricted_max_cropland_fraction, cbind(0,NA)), fun = "mean", na.rm = T)/1e6)

# joku häikkä, koska agrLandMax_Mha on pienempi kuin gl+cl ala? -- ei välttis haittaa koska
# 1) gl+cl sisältävät paljon pikseleitä, joilla SI = 0 (tai 1 tai 2)
# 2) näin ollen nykyinen viljelyala voi hyvinkin olla suurempi kuin SI mukainen ala
# 3) lisäksi SI = overall suitability FOR CROPS ja meillä on mukana eläimet -- tietenkin meidän cl+gl ala on siksi suurempi


# ----------------------------------Global sums -- 975.4735 Mha of cl originally
# add these to different df
         # cl_PotExp_fraction_mean = 
         #   pull(global(r_potential_cropland_expansion_fraction,
         #               "mean", na.rm = T)),
         # cl_PotExp_fraction_mean_croplandMask =
         #   pull(global(r_potential_cropland_expansion_croplandmask_fraction,
         #               "mean", na.rm = T)),
         # cl_PotExp_fraction_mean_outside_cl =
         #   pull(global(r_potential_cropland_expansion_outside_croplands_fraction,
         #               "mean", na.rm = T))








# global sums -- mostly fractions here as percent yield Inf vals -- convert 0 to NA when calculating global mean fractions?
# df_SI <- df_SI %>% 
#   mutate(gl_PotRed_fraction_mean  = 
#            pull(global(r_potential_grazingland_reduction_fraction, "mean", na.rm = T)),
#          gl_PotRed_fraction_mean_glmask = 
#            pull(global(r_potential_grazingland_reduction_fraction_glmask, "mean", na.rm = T)))





# f_mean_cropland_expansion_percent <- function(raster_layer) {
#   
#   # Replace Inf values with NA
#   raster_layer[is.infinite(raster_layer)] <- NA
#   # Find outliers 
#   out_values <- quantile(values(raster_layer), probs = 0.99, na.rm = T)
#   # Remove outliers from raster using classify
#   rclmat_remove_outliers <- matrix(c(out_values, Inf, NA), ncol = 3, byrow = TRUE)
#   raster_no_outliers <- classify(raster_layer, rclmat_remove_outliers, right = FALSE)
#   # Calculate the mean expansion percentage
#   mean_expansion_percent <- global(raster_no_outliers, fun = "mean", na.rm = T)
#   return(mean_expansion_percent)
# }
# 
# 
# # Apply the function to all raster layers in r_cropland_expansion_percent
# mylist_average_exp_percent <- 
#   lapply(r_cropland_expansion_percent, f_mean_cropland_expansion_percent) # 30min
# 
# df_SI <- df_SI %>% 
#   mutate(tibble(cl_PotExp_mean_percent = unlist(mylist_average_exp_percent)))
```


