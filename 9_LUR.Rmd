---
title: "LUR"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---


Present the results using LUR approach developed by Hannah van Zanten:
https://link.springer.com/article/10.1007/s11367-015-0944-1


# Get protein digestibility data

This is needed to calculate LUR.

We conducted a preliminary literature review to determine the digestibility values of various food items. In doing so, we found digestibility values for most of the SPAM crops and all of the meat items. Subsequently, we calculated average digestibility values for both SPAM food crops and meat items. However, we were unable to find the digestibility values for the SPAM items "Yams", "Roots, Other", "Bananas", and "Plantains".

For these items, we used a single average value derived from the mean digestibility values of the 27 other SPAM food crops. This was considered a reasonable approximation given the lack of available data for these specific crops. The comprehensive table of protein digestibility values used in our analysis, including the references from which the information was derived, can be found in the Appendix

```{r}
# Read the excel file into a data frame
digest_raw <- readxl::read_excel(here("Data", "Input", "other", "Protein_digestibility.xlsx"))
digest_raw$Protein_digestibility_mean_percent <-
  as.numeric(digest_raw$Protein_digestibility_mean_percent)


digest_raw <- digest_raw %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 1))) 

# Separate animal related items into a separate table
animal_items <- 
  dplyr::filter(digest_raw, Item %in% c("Cattle meat", "Sheep and goat meat", "Cattle milk")) %>% 
  dplyr::select(Item, Protein_digestibility_mean_percent)



# Separate plant items into a separate table
plant_items <- 
  dplyr::filter(digest_raw, !grepl("meat", Item, ignore.case = TRUE)) %>%
  dplyr::select(Item, SPAM_name, Protein_digestibility_mean_percent)




# Save the sources in a separate table
ref <- digest_raw %>%
  dplyr::select(Item, Source, Notes)



# ---------------------------------------------------- calculate averages
livestockProt_digestibility <- mean(animal_items$Protein_digestibility_mean_percent, na.rm = TRUE)
plant_digestibility <- mean(plant_items$Protein_digestibility_mean_percent, na.rm = TRUE)

livestockProt_digestibility # 94
plant_digestibility # 84
```



# LUR with predicted yields = LUR in ALL GRAZING LAND scenario?

Tässä siis tiedossa eläinten tuottama protskusato JA kasvien tuottama protskusato.
Kasvien protskusato tiedossa nykyisiltä croplandeilta sekä alueilta joilla gl voidaan muuntaa cl
Eläinten protskusato tiedossa gl alueila sekä niiltä cl alueilta, joilla oli aiemmin vain cl

--> mutta sisältääkö tämä ne alueet, joissa esim nyt 20%gl ja 30%cl, mutta joista tarvitaan skenaario jossa 50% solusta gl? Halutaan siis ALL GL skenaario
  -> tiedetään alun perin kuinka monta ha tarvitaan tuottamaan 1kg proteiinia. Tämä tulee suoraan FCR kautta. Muuttuuko tämä mihinkään jos solusta on käytetty suurempi osa elukoille? Vastaus: Ei koska nyt laskettu biomassasta joka on joku lkm per ha

```{r}
# tutkitaan existing + olemassaolevia satoja ja lasketaan niiden perusteella LUR 

  # LO
LO_existing_plus_predicted_areas <- 
  1 / r_agb_prot_existing_plus_new_areas_kg_ha # no digestibility needed
  # convert NA to 0 to make multiplication easier
LO_existing_plus_predicted_areas_NAto0 <-
  classify(LO_existing_plus_predicted_areas, cbind(NA, 0))


# all the other data frim intermediate inputs
r_agb_prot_existing_plus_new_areas_kg_ha
r_crop_prot_existing_plus_new_areas_kg_ha
LO_existing_plus_predicted_areas_NAto0


  # HDP
HDP_predicted <- 
  r_crop_prot_existing_plus_new_areas_kg_ha * plant_digestibility
HDP_predicted_NAto0 <- classify(HDP_predicted, cbind(NA,0))
  
  # "how much human digestible protein in 1 kg of animal protein
digestibleAnimalProtein <- 1 * livestockProt_digestibility  


  # LUR
LUR_predicted <- 
  (LO_existing_plus_predicted_areas_NAto0 * HDP_predicted_NAto0) / 
  digestibleAnimalProtein

LUR_predicted <- mask(LUR_predicted, r_fraction_gl_cl_total_0toNA)


############################################################## mask
  # mixed: areas where >= 10% gl and also >= 10% gl
LUR_predicted_wheremixed <- 
  mask(LUR_predicted, r_gl_cl_share_mixed)

  # on areas where 1 < SI < 10
LUR_predicted_SIbetween1to10mask <- 
  mask(LUR_predicted, SI_5arcmin_range_1to10)


# Stack
LUR_predicted_nlyr3 <-
  c(LUR_predicted,
    LUR_predicted_wheremixed,
    LUR_predicted_SIbetween1to10mask)
names(LUR_predicted_nlyr3) <- 
  c("LUR pred", "LUR pred mix", "LUR pred SI1to10")


# Plot

create_index_map(r_index = LUR_predicted, 
                     tocrs = "ESRI:54030",
                     index_main_title = "LUR using predicted protein yields and land demand for animals and crops",
                     index_label = "[LUR]",
                     colorpal = pal_lur,
                     breakvals = c(0, 1, 10, 100,  Inf),
                     breaknames = c("< 1", "1-10","10-100",">100"))




writeRaster(LUR_predicted_nlyr3, 
            here("Data", "Intermediate_input",
                                "LUR_predicted.tif"),
            overwrite = T)





# test median LUR
df_LUR_predicted<- 
  terra::as.data.frame(LUR_predicted_nlyr3, xy = T)

df_LUR_predicted <- df_LUR_predicted %>% 
  dplyr::select(-x,-y)

median(df_LUR_predicted$`LUR pred`, na.rm = T)


df_LUR_predicted_medians <- 
  map_df(df_LUR_predicted, ~ data.frame(median = median(., na.rm = TRUE)))

df_LUR_predicted_medians 
# Median LUR 35
# Median LUR on mixed production areas 55
# Median LUR on areas where SI between 1to10 88
```



# LUR in scenario where cropland CANNOT decrease

```{r}
# HDP
r_optimised_protein_crops_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix_positive.tif") %>%
  rast()


# Convert to kg per ha --> 
r_optimised_protein_crops_kg_ha_positive <-
  (r_optimised_protein_crops_mt_perpix_positive * 1000) /
  (cellSize(r_optimised_protein_crops_mt_perpix_positive[[1]], unit = "ha") * 
     r_SIbased_restricted_max_cropland_fraction)

# convert negative values to zeros
r_optimised_protein_crops_kg_ha_positive <-
  terra::ifel(r_optimised_protein_crops_kg_ha_positive < 0,
              0,
              r_optimised_protein_crops_kg_ha_positive)


# convert Inf values to zeros (Inf values if r_SIbased_restricted_max_cropland_fraction_NAto0 = 0)
r_optimised_protein_crops_kg_ha_positive <- 
  classify(r_optimised_protein_crops_kg_ha_positive, cbind(Inf, 0))

HDP_SI_based_positive <- r_optimised_protein_crops_kg_ha_positive * plant_digestibility



# ---------------------------------------------------------------------- LUR _positive
LUR_SI_based_positive <- 
  (LO_existing_plus_predicted_areas_NAto0 * HDP_SI_based_positive) / 
  digestibleAnimalProtein


# now croplands are NA if SI increases. Those NA cells in agricultural land areas should get value 0 as LUR = 0 if crops cannot be produced
LUR_SI_based_NAto0_positive <- 
  classify(LUR_SI_based_positive, cbind(NA,0))
  # mask to procution areas
LUR_SI_based_NAto0_positive <- 
  mask(LUR_SI_based_NAto0_positive, r_fraction_gl_cl_total_0toNA)


writeRaster(LUR_SI_based_NAto0_positive,
            here("Data", "Intermediate_input", "LUR_SI_based_NAto0_positive.tif"),
            overwrite = T)


################################### get the file
LUR_SI_based_NAto0_positive <-
  here("Data", "Intermediate_input", "LUR_SI_based_NAto0_positive.tif") %>% 
  rast()

names(LUR_SI_based_NAto0_positive) <- paste0("LUR_SI_gte", threshold_values)
```

# plots for LUR scenario where cropland cannot decrease

```{r}
df_LUR_SI_based_NAto0_positive <- 
  terra::as.data.frame(LUR_SI_based_NAto0_positive, xy = T)

head(df_LUR_SI_based_NAto0_positive)
names(df_LUR_SI_based_NAto0_positive)

df_LUR_SI_based_NAto0_noXY_positive <- df_LUR_SI_based_NAto0_positive %>% 
  dplyr::select(-x,-y)

df_LUR_SI_based_NAto0_noXY_medians_positive <- 
  map_df(df_LUR_SI_based_NAto0_noXY_positive, ~ data.frame(median = median(., na.rm = TRUE)))

df_LUR_SI_based_NAto0_noXY_medians_positive
df_LUR_SI_based_NAto0_noXY_medians_positive$median %>% plot() 
# save this data
df_LUR_SI_based_NAto0_noXY_medians_positive <-
  tibble(SI = 0:99,
         LUR_median = df_LUR_SI_based_NAto0_noXY_medians_positive$median)

write.csv(df_LUR_SI_based_NAto0_noXY_medians_positive,
          here("Data", "Output", "LUR_medians_different_SI_thresholds.csv"))

(plt_LUR10_positive <- 
  create_index_map(r_index = LUR_SI_based_NAto0_positive[[10]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>10 areas could be converted to croplands CL CANNOT DEC",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))



(plt_LUR33_positive <- 
  create_index_map(r_index = LUR_SI_based_NAto0_positive[[33]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>33 areas could be converted to croplands CL CANNOT DEC",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))

(plt_LUR75_positive <- 
  create_index_map(r_index = LUR_SI_based_NAto0_positive[[75]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>75 areas could be converted to croplands CL CANNOT DEC",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))


(plt_LUR98_positive <- 
  create_index_map(r_index = LUR_SI_based_NAto0_positive[[98]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>98 areas could be converted to croplands CL CANNOT DEC",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))


plts_lur_positive <-
  tmap_arrange(plt_LUR10_positive, plt_LUR33_positive, 
               plt_LUR75_positive, plt_LUR98_positive, 
               ncol = 2)
plts_lur_positive



tmap_save(plts_lur_positive, 
          filename = here("Supplementary_materials", "LUR_indifThresholds_4mapspositive.pdf"))
```

