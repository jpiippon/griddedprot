---
title: 'Comparisons: grazing livestock and crops'
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---



# Get data
- saved to folder Intermediate inputs

```{r}
# Crop production raster
# r_global_prod_crops_mt <- here("Data", "Intermediate_input","production_raster_of_21_spamcrops.tif") %>%
#   rast() # WHEA RICE   upd 14.2.2023
# 
# r_protein_from_AGB_kg_ha <- here("Data", "Intermediate_input","r_protein_from_AGB_kg_ha.tif")%>% rast() # upd 14.2.2023


# # per ha
# r_prot_allcrops_sum_kg_ha <- here("Delete", "r_prot_allcrops_sum_kg_ha.tif") %>% rast()
# r_animalprot_fromAGB_kg_ha <- here("Delete", "r_animalprot_fromAGB_kg_ha.tif") %>% rast()
```


# Calculate total protein currently produced in cell
 --> not per ha

```{r}
# ---------------------------------------------------- calculate per pixel 
r_protein_combined_kg_perpix_when_dairy <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_AGB_kg_perpix$dairy), 
           fun = sum, na.rm = T) # must use app as gl and cl not overlapping. Alternatively:
# r_protein_combined_kg_perpix_when_dairy2 <-
#   1000 * classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0)) +
#   classify( r_protein_from_AGB_kg_perpix$dairy, cbind(NA, 0))


r_protein_combined_kg_perpix_when_beef <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_AGB_kg_perpix$beef), 
           fun = sum, na.rm = T)

r_protein_combined_kg_perpix_when_sheepgoats <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_AGB_kg_perpix$sheep_and_goats), 
           fun = sum, na.rm = T)


r_protein_combined_kg_perpix <-
  c(r_protein_combined_kg_perpix_when_dairy,
    r_protein_combined_kg_perpix_when_beef,
    r_protein_combined_kg_perpix_when_sheepgoats)
names(r_protein_combined_kg_perpix) <- c("when Dairy cattle", "when Beef cattle", "when Sheep and goats")






   ## per ha ----- not best way to do this
# r_protein_combined_kg_ha_when_dairy <- 
#   app(c(r_prot_allcrops_sum_kg_ha, 
#         r_protein_from_AGB_kg_ha$dairy), # stack rasters, was average
#            fun = sum, na.rm = T) # why not  r_prot_allcrops_sum_kg_ha + r_protein_from_AGB_kg_ha$dairy ---> because NA values (areas now overlapping)
# 
# 
# r_protein_combined_kg_ha_when_beef <- 
#   app(c(r_prot_allcrops_sum_kg_ha, 
#         r_protein_from_AGB_kg_ha$beef), 
#            fun = sum, na.rm = T)
# 
# 
# 
# r_protein_combined_kg_ha_when_sheepgoats <- 
#   app(c(r_prot_allcrops_sum_kg_ha, 
#         r_protein_from_AGB_kg_ha$sheep_and_goats), 
#            fun = sum, na.rm = T)
# 
# 
# r_protein_combined_kg_ha <-
#   c(r_protein_combined_kg_ha_when_dairy,
#     r_protein_combined_kg_ha_when_beef,
#     r_protein_combined_kg_ha_when_sheepgoats)
# names(r_protein_combined_kg_ha) <- c("when Dairy cattle", "when Beef cattle", "when Sheep and goats")
# 
# plot(r_protein_combined_kg_ha, range = c(0,600), main = "Combined protein per ha")
# plot(r_protein_from_AGB_kg_ha$dairy, main = "dairy prot")






# share of the total protein that originates from crops -- updated so that calculated from perpix values
  ## first convert NA to 0
r_prot_allcrops_sum_kg_perpix_NAto0 <- classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0))
r_share_of_total_protein_crops <- 100* (r_prot_allcrops_sum_kg_perpix_NAto0 / r_protein_combined_kg_perpix) # old calculated per ha
plot(r_share_of_total_protein_crops)


# share of the total protein that originates from livestock
  ## first convert NA to 0
r_protein_from_AGB_kg_perpix_NAto0 <- classify(r_protein_from_AGB_kg_perpix, cbind(NA, 0))
r_share_of_total_protein_livestock <- 100* (r_protein_from_AGB_kg_perpix_NAto0 / r_protein_combined_kg_perpix)
plot(r_share_of_total_protein_livestock)


 ## test
mean(r_share_of_total_protein_livestock + r_share_of_total_protein_crops) # should be 100
```


# Livestock contribution to total protein

- mask to croplands
- mask to areas where SI < 10

```{r}
  ## cropland mask (share of livestock masked to croplands to show that on cropland areas livestock produce only a little)
r_share_of_total_protein_livestock_croplandmask <-
  mask(r_share_of_total_protein_livestock, 
       r_global_production_crops_sum_mt)

plot(r_share_of_total_protein_livestock_croplandmask)


  ## SI below 10 mask AND croplandmask
SI_5arcmin <- here("Data", "Input", "from_harddrive", "SI_v3.0_5arcmin.tif") %>% 
  rast()

SI_5arcmin_below10 <- SI_5arcmin
SI_5arcmin_below10[SI_5arcmin_below10 >= 10] <- NA
plot(SI_5arcmin_below10, main = "SI below 10")

SI_5arcmin_below10_croplandmask <-
  mask(SI_5arcmin_below10, r_global_production_crops_sum_mt)
plot(SI_5arcmin_below10_croplandmask, main = "SI below 10 on croplands")

r_share_of_total_protein_livestock_SIbelow10mask_croplandmask <-
  mask(r_share_of_total_protein_livestock, SI_5arcmin_below10_croplandmask)
names(r_share_of_total_protein_livestock_SIbelow10mask_croplandmask) <-
  names(r_share_of_total_protein_livestock)
plot(r_share_of_total_protein_livestock_SIbelow10mask_croplandmask, 
     main = "share of liv of tot protein on croplands where si < 10")
```




# global sums --- trimming -- create function for that

```{r}
## livestock protein on croplands
r_protein_from_AGB_kg_perpix_croplandmask <-
  mask(r_protein_from_AGB_kg_perpix, 
       r_global_production_crops_sum_mt)
plot(r_protein_from_AGB_kg_perpix_croplandmask)

## livestock protein on croplands where SI < 10
r_protein_from_AGB_kg_perpix_SIbelow10mask_croplandmask <-
  mask(r_protein_from_AGB_kg_perpix, 
       SI_5arcmin_below10_croplandmask)

plot(r_protein_from_AGB_kg_perpix_SIbelow10mask_croplandmask)


  ## sums
global(r_protein_from_AGB_kg_perpix_croplandmask, fun = "sum", na.rm = T)/1e9 # dairy 29 mmt, beef 7, sheepgoat 7 average 9
global(r_protein_from_AGB_kg_perpix_SIbelow10mask_croplandmask, fun = "sum", na.rm = T)/1e9 # dairy 1.6mmt, beef 0.4, sheepgoat 0.4 average 0.5


```


# kcal --- do same thing