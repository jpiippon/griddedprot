---
title: "Suitabilities when cropland cannot decrease"
output: html_document
date: "2023-07-31"
---

Suitabilities when cropland cannot decrease

# Chunk 1: Get data 
Running this takes time, might be easier to save the intermediate data and then get it (done in this chunk)

```{r}
# First function for plotting dynamic maps
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1)

create_dynamic_index_map <- function(myraster, layer_num, main_title, 
                                     diff_breakvals = c(-Inf, 10, 20, 60, 80, 100, Inf),
                                     diff_breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")) {
  
  plt_dynamic_map <- 
    create_index_map(r_index = myraster[[layer_num]], 
                     tocrs = "ESRI:54030",
                     index_main_title = sprintf(main_title, layer_num),
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = diff_breakvals,
                     breaknames = diff_breaknames)
  return(plt_dynamic_map)
}


# Create a vector of threshold values from 0 to 99
threshold_values <- 0:99


# Chunk 2
r_physical_areas_crops_sum_ha_perpix_NAto0 <- 
  classify(r_physical_areas_crops_sum_ha_perpix, cbind(NA,0))

r_SIbased_unrestricted_cropland_fraction <-
  here("Data", "Intermediate_input", "Fraction_of_5arcmin_cell_where_SI_ge_threshold.tif") %>%
  rast()

r_SIbased_unrestricted_cropland_ha_perpix <-
  here("Data", "Intermediate_input", "unrestricted_amount_of_cropland_therecouldbe_whenSI_ge_threshold_ha_perpix.tif") %>% 
  rast()


# Chunk 3
r_SIbased_restricted_max_cropland_fraction <-
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_fraction_NAto0 <-
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold_NAto0.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_ha_perpix <-
  here("Data", "Intermediate_input","max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix.tif") %>%
  rast()

r_SIbased_restricted_max_cropland_ha_perpix_NAto0 <-
  here("Data", "Intermediate_input",
       "max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix_NAto0.tif") %>%
  rast()

# Chunk 4.1
r_potential_cropland_expansion_ha_perpix_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_ha_perpix_positive.tif") %>%
  rast()

r_potential_cropland_expansion_croplandmask_ha_perpix_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_ha_perpix_positive.tif") %>%
  rast()

r_potential_cropland_expansion_outside_croplands_ha_perpix_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_ha_perpix_positive.tif") %>%
  rast()


r_potential_cropland_expansion_fraction_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_fraction_positive.tif") %>%
  rast()

r_potential_cropland_expansion_croplandmask_fraction_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_fraction_positive.tif") %>%
  rast()

r_potential_cropland_expansion_outside_croplands_fraction_positive <- 
  here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_fraction_positive.tif") %>%
  rast()

# Chunk 5.1
r_cropland_expansion_percent_positive <- 
  here("Data", "Intermediate_input", "r_cropland_expansion_percent_positive.tif") %>%
  rast()

r_cropland_expansion_percent_croplandmask_positive <- 
  here("Data", "Intermediate_input", "r_cropland_expansion_percent_croplandmask_positive.tif") %>%
  rast()

r_cropland_expansion_percent_outside_croplands_positive <- 
  here("Data", "Intermediate_input", "r_cropland_expansion_percent_outside_croplands_positive.tif") %>%
  rast()

# Chunk 6.1
r_grazingland_reduction_percent_positive <- 
  here("Data", "Intermediate_input", "r_grazingland_reduction_percent_positive.tif") %>%
  rast()

r_grazingland_reduction_percent_croplandmask_positive <- 
  here("Data", "Intermediate_input", "r_grazingland_reduction_percent_croplandmask_positive.tif") %>%
  rast()

r_grazingland_reduction_percent_outside_croplands_positive <- 
  here("Data", "Intermediate_input", "r_grazingland_reduction_percent_outside_croplands_positive.tif") %>%
  rast()


# Chunk 7.1
r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive.tif") %>%
  rast()

r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive.tif") %>%
  rast()

r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive.tif") %>%
  rast()

r_protein_decrease_basedOnSI_grazers_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_protein_decrease_basedOnSI_grazers_mt_perpix_positive.tif") %>%
  rast()



r_optimized_grazing_protein_kg_perpix_positive <- 
  here("Data", "Intermediate_input", "r_optimized_grazing_protein_kg_perpix_positive.tif") %>%
  rast()

r_optimised_protein_crops_mt_perpix_positive <- 
  here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix_positive.tif") %>%
  rast()

r_optimised_combined_protein_yield_kg_perpix_positive <- 
  here("Data", "Intermediate_input", "r_optimised_combined_protein_yield_kg_perpix_positive.tif") %>%
  rast()

r_optimized_combined_protein_yield_larger_percent_positive <- 
  here("Data", "Intermediate_input", "r_optimized_combined_protein_yield_larger_percent_positive.tif") %>%
  rast()


```



# Chunk2 Examine Zabel 2022 SI data

In this chunk, we are analyzing the Zabel 2022 SI data, specifically looking at version 3.0, overall suitability for the years 1980-2009 with current irrigation areas applied (only for food crops 1-17). The goal is to classify, aggregate, and resample the raster based on a threshold value.

Also alculate total agricultural land area 
Grazing land gl + cropland cl

```{r}
# Crop production raster
  ## convert NA to 0 to make upcoming calculations easier
r_physical_areas_crops_sum_ha_perpix_NAto0 <- 
  classify(r_physical_areas_crops_sum_ha_perpix, cbind(NA,0))


# Load SI data (requires .hdr file with the same name in the folder)
SI_30arcsec <- 
  here("Data", "Input", "Zabel22_SI", 
       "overall_suitability_subset_1to17_hist1980_2009_current_irr_areas_applied.bil") %>% 
  rast()
plot(SI_30arcsec)

# Aggregate and resample the SI data to 5 arcmin resolution
SI_5arcmin <- aggregate(SI_30arcsec, fact = 10) %>% 
  resample(., template_rast_5arcmin)
names(SI_5arcmin) <- "overall_suitability_subset1to17"
plot(SI_5arcmin)


writeRaster(SI_5arcmin, filename = here("Data", "Input", "Zabel22_SI",
                   "SI_5arcmin_overall_suitability_subset1to17_hist1980_2009_current_irr_areas_applied.tif"),
            overwrite = T)



# Example showing what the next function does
# SI_over75 <- SI_30arcsec
# SI_over75[SI_over75 < 75] <- 0 # plot and see
# SI_over75[SI_over75 >= 75] <- 1 # plot and see
# SI_over75_fraction <- aggregate(SI_over75, fact = 10, na.rm = T) %>% 
#   resample(., template_rast_5arcmin)
# 
# global((SI_over75_fraction * template_rast_5arcmin_cellsize), "sum", na.rm = T)/1e6 # 895.09 --> classes differ by one

# function that produces raster that show how large fraction of a cell belongs to a spesific SI class

# Define a function to classify, aggregate, and resample the raster based on a threshold
f_classify_and_aggregate_resample <- function(threshold) {
  # Create a reclassification matrix with the given threshold
  rclmat <- matrix(c(threshold, Inf, 1), ncol = 3, byrow = TRUE)
  
  # Classify the raster using the reclassification matrix
  classified_raster <- classify(SI_30arcsec, rclmat, include.lowest = TRUE, others = 0)
  
  # Aggregate the classified raster by a factor of 10
  aggregated_raster <- aggregate(classified_raster, fact = 10, na.rm = TRUE)
  
  # Resample the aggregated raster using the template raster (5 arcmin resolution)
  resampled_raster <- resample(aggregated_raster, template_rast_5arcmin)
  
  # Return the resampled raster
  return(resampled_raster)
}

# Create a vector of threshold values from 0 to 99
threshold_values <- 0:99

# Apply the function for each threshold value and store the results in a list
result_list_SI_function <- 
  lapply(threshold_values, 
         f_classify_and_aggregate_resample) # 1.5 hours

# Create a raster stack from the result list

r_SIbased_unrestricted_cropland_fraction <- rast(result_list_SI_function) 
names(r_SIbased_unrestricted_cropland_fraction) <- paste0("FracOfCell_whenSI_ge", threshold_values)




writeRaster(r_SIbased_unrestricted_cropland_fraction,
            here("Data", "Intermediate_input", "Fraction_of_5arcmin_cell_where_SI_ge_threshold.tif"),
            overwrite = T)


# ------------------------- the same in ha
r_SIbased_unrestricted_cropland_ha_perpix <-
  r_SIbased_unrestricted_cropland_fraction *
  cellSize(r_SIbased_unrestricted_cropland_fraction[[1]], unit = "ha")  



writeRaster(r_SIbased_unrestricted_cropland_ha_perpix,
            here("Data", "Intermediate_input", "unrestricted_amount_of_cropland_therecouldbe_whenSI_ge_threshold_ha_perpix.tif"),
            overwrite = T)

```



# Chunk 3: Investigate how much more cropland could be available based on SI

In this chunk, we analyze how much more cropland area could be available within the different Suitability Index (SI) classes, under the assumption that the combined share of grazing lands and croplands within a cell must remain constant.

Mandatory assumption:
r_SIbased_restricted_max_cropland_fraction <= r_fraction_gl + r_fraction_cl 
r_SIbased_restricted_max_cropland_fraction <= r_fraction_gl_cl_total_0toNA

"To avoid the expansion of agricultural land we assumed that the combined share of grazing lands and croplands within a cell must remain constant. For instance, if a cell initially contains 40% grazing lands and 20% croplands, only 60% of the land area can be allocated for agricultural purposes (e.g., 50% crops and 10% grazing lands, if that is what the suitability indices suggest)."

```{r}
# example
# r_SIbased_restricted_max_cropland_fraction1 <- 
#   ifel(r_SIbased_unrestricted_cropland_fraction[[1]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SIbased_unrestricted_cropland_fraction[[1]])


# do this for all the rasters
# Function to apply the ifel() operation on each raster layer
  # if unrestricted SI_fraction > current agricultural land fraction, return current agr land fraction (gl+cl fraction)
  # if it is the same or smaller, return the unrestricted SI_fraction
  # however, if unrestricted SI_fraction = NA, then return NA as well. This is because we only explore AgrLandMax with this function (how much cropland area could be expanded) and it cannot expande to areas where unrestricted SI = NA. 
  # Without this NA addition AgrLandMAx could be e.g. 16ha when unrestricted SI is NaN
f_limit_agrland <- function(raster_layer) {
  # Create a mask for NA and NaN values in the raster_layer
  na_mask <- is.na(raster_layer) | is.nan(raster_layer)
  
  # Apply the ifel() function to limit the values
  limited_agrland <- ifel(test = raster_layer > r_fraction_gl_cl_total, 
                          yes = r_fraction_gl_cl_total,
                          no = raster_layer)
  
  # Set the NA and NaN values in the original raster_layer to NA in the limited_agrland raster
  limited_agrland[na_mask] <- NA
  
  return(limited_agrland)
}


# f_limit_agrland <- function(raster_layer) {
#   ifel(raster_layer > r_fraction_gl_cl_total, # could be r_fraction_gl_cl_total_0toNA but this ok too
#        r_fraction_gl_cl_total,
#        raster_layer)
# }

# alternative (modify)
# f_limit_agrland <- function(i) {
#   ifel(r_SIbased_unrestricted_cropland_fraction[[i]] > r_fraction_gl_cl_total, 
#        r_fraction_gl_cl_total, 
#        r_SIbased_unrestricted_cropland_fraction[[i]])
# }



# Apply the function to all 100 raster layers in r_SIbased_unrestricted_cropland_fraction
tic()
r_SIbased_restricted_max_cropland_fraction<- 
  lapply(r_SIbased_unrestricted_cropland_fraction, 
         f_limit_agrland) %>% 
  rast()
toc() # 50min

# Apply the function to all 100 raster layers in r_SIbased_unrestricted_cropland_fraction
# r_SIbased_restricted_max_cropland_fraction <- lapply(threshold_values, f_limit_agrland) %>% 
#   rast() # takes 30min if r_SIbased_unrestricted_cropland_fraction is not in RAM
names(r_SIbased_restricted_max_cropland_fraction) <- 
  paste0("MaxFracOfCell_ge", threshold_values) 




# 
writeRaster(r_SIbased_restricted_max_cropland_fraction,
            here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold.tif"),
            overwrite = T)




r_SIbased_restricted_max_cropland_fraction[[5]] %>% plot()

# convert NA to 0 to make upcoming calculations easier --- check if this is needed
r_SIbased_restricted_max_cropland_fraction_NAto0 <- 
  classify(r_SIbased_restricted_max_cropland_fraction, cbind(NA,0), filename =
             here("Data", "Intermediate_input", "Fraction_of_cropland_max_when_SI_ge_threshold_NAto0.tif"),
           overwrite = T)



  # alternative function
# f_fraction_agrland_max_i <- function(i) {
#   r_SIbased_restricted_max_cropland_fraction_i <- 
#   ifel(r_SIbased_unrestricted_cropland_fraction[[i]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SIbased_unrestricted_cropland_fraction[[i]])
#   return(r_SIbased_restricted_max_cropland_fraction_i)
# }
# 
# r_SIbased_restricted_max_cropland_fraction_i <- lapply(threshold_values, f_fraction_agrland_max_i)
# names(r_SIbased_restricted_max_cropland_fraction_i) <- paste0("MaxFracOfCellOvr", threshold_values)

r_SIbased_unrestricted_cropland_fraction[[10]] %>% plot()
r_SIbased_restricted_max_cropland_fraction[[10]] %>% plot()

r_SIbased_unrestricted_cropland_fraction[[75]] %>% plot()
r_SIbased_restricted_max_cropland_fraction[[75]] %>% plot()






# ---------------------------------------- HECTARES
  # Calculate how much this potential cropland area would be in hectares  
 # saadaanko laskettua summa joka eri luokalle? Eli kuinka paljon voisi olla sellaista croplandia, jonka SI on 10, kuinka paljon sellaista jonka SI 20 jne
  # cellsize with one layer

r_SIbased_restricted_max_cropland_ha_perpix <-
  r_SIbased_restricted_max_cropland_fraction *
  cellSize(r_SIbased_restricted_max_cropland_fraction[[1]], unit = "ha") # Cellsize constant 

writeRaster(r_SIbased_restricted_max_cropland_ha_perpix, filename =
              here("Data", "Intermediate_input","max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix.tif"),
            overwrite = T)

r_SIbased_restricted_max_cropland_ha_perpix_NAto0 <- 
  classify(r_SIbased_restricted_max_cropland_ha_perpix, cbind(NA,0), filename =
             here("Data", "Intermediate_input",
                  "max_amount_of_cropland_therecouldbe_whenSIgeThreshold_ha_perpix_NAto0.tif"),
           overwrite = T) 




# Example demonstrating the output of the function f_limit_agrland
testiext <- ext(26.7, 26.9, 61.6, 63.6)
#testiext <- ext(26.7, 26.9, 51.6, 53.6) # use this if you want to see what happens when there is more land based on SI 
ex_tibble <- tibble(
  SIbased_unrestricted_cropland_ha_perpix = (crop(r_SIbased_unrestricted_cropland_ha_perpix[[10]], testiext) %>% values() %>% as.numeric()),
  glcl_haPerpix = (crop((r_fraction_gl_cl_total * cellSize(r_fraction_gl_cl_total, unit = "ha")), testiext) %>% values() %>% as.numeric()),
  SIbased_restricted_cropland_ha_perpix = (crop(r_SIbased_restricted_max_cropland_ha_perpix[[10]], testiext) %>% values() %>% as.numeric()))
ex_tibble




```





# Chunk 4 Potential cropland expansion - cl cannot dec

```{r}
# Calculate how much more cropland there could be in cells (croplands already use a lot of very suitable  land). Thus cropland area could be expanded by this many hectares at most (per pixel)
r_potential_cropland_expansion_ha_perpix  <-
  r_SIbased_restricted_max_cropland_ha_perpix_NAto0  - r_physical_areas_crops_sum_ha_perpix_NAto0 


# land mask (not completely mandatory but all the oceans are 0 if we dont do this)
r_potential_cropland_expansion_ha_perpix <- 
  mask(r_potential_cropland_expansion_ha_perpix, r_fraction_gl_cl_total_0toNA )

r_potential_cropland_expansion_ha_perpix[[33]] %>% plot()


 
  # convert negative values to zeros as we are only interested on how much cl could increase and we are not saying that current crop production concentrates on wrong areas -- in this article only potential increment is studied
  # alternative create reclassification matrix#
# rclmat_neg_to_zeros <- 
#   matrix(c(-Inf, 0, 0), 
#          ncol = 3, byrow = TRUE) 
# 
# r_potential_cropland_expansion_ha_perpix_positive <-
#   classify(r_potential_cropland_expansion_ha_perpix , 
#            rclmat_neg_to_zeros, 
#            right = TRUE)

r_potential_cropland_expansion_ha_perpix_positive <-
  terra::ifel(r_potential_cropland_expansion_ha_perpix < 0,
              0,
              r_potential_cropland_expansion_ha_perpix)


r_potential_cropland_expansion_ha_perpix_positive[[33]] %>% plot()

# same as the slower option (5x more time)
# r_potential_cropland_expansion_ha_perpix _positive2 <- r_potential_cropland_expansion_ha_perpix 
# r_potential_cropland_expansion_ha_perpix _positive2[r_potential_cropland_expansion_ha_perpix _positive2 < 0] <- NA



# Cropland expansion on cells where there is cropland
r_potential_cropland_expansion_croplandmask_ha_perpix_positive <-
  mask(r_potential_cropland_expansion_ha_perpix_positive, 
       r_physical_areas_crops_sum_ha_perpix)

# Cropland expansion on cells where SPAM crops are not growing
r_potential_cropland_expansion_outside_croplands_ha_perpix_positive  <-
  mask(r_potential_cropland_expansion_ha_perpix_positive, 
       r_physical_areas_crops_sum_ha_perpix, inverse = T)



writeRaster(r_potential_cropland_expansion_ha_perpix_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_ha_perpix_positive.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_croplandmask_ha_perpix_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_ha_perpix_positive.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_outside_croplands_ha_perpix_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_ha_perpix_positive.tif"),
            overwrite =T)






# ----------------------------------------------------- fractions (was ha above)
# Etsi fraction jossa voitais tuottaa lisää. Eli potentiaalinen - nykyinen ala. 
# r_SIbased_restricted_max_cropland_fraction_NAto0 vai r_SIbased_restricted_max_cropland_fraction?
r_potential_cropland_expansion_fraction  <-
  r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0 # jos pos voitaisiin tuottaa lisää. Jos neg nyt tuotetaan jo enemmän kuin SI puitteissa ehkä kannattaisi
  
r_potential_cropland_expansion_fraction <- 
  mask(r_potential_cropland_expansion_fraction, r_fraction_gl_cl_total_0toNA)



  # convert negative to zeros
  # note! When SI + + this potential fraction - - 
r_potential_cropland_expansion_fraction_positive <-
  terra::ifel(r_potential_cropland_expansion_fraction < 0,
              0,
              r_potential_cropland_expansion_fraction)

# r_potential_cropland_expansion_fraction_positive <-
#   classify(r_potential_cropland_expansion_fraction,
#            rclmat_neg_to_zeros, right = TRUE) # ---- what if we dont del these yet?

  # mask to croplands to illustrate (and to calculage global sums)
r_potential_cropland_expansion_croplandmask_fraction_positive <-
  mask(r_potential_cropland_expansion_fraction_positive,
       r_physical_areas_crops_sum_ha_perpix)

r_potential_cropland_expansion_outside_croplands_fraction_positive <-
  mask(r_potential_cropland_expansion_fraction_positive,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)



writeRaster(r_potential_cropland_expansion_fraction_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_fraction_positive.tif"),
            overwrite =T)


writeRaster(r_potential_cropland_expansion_croplandmask_fraction_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_croplandmask_fraction_positive.tif"),
            overwrite =T)

writeRaster(r_potential_cropland_expansion_outside_croplands_fraction_positive, filename = 
              here("Data", "Intermediate_input", "r_potential_cropland_expansion_outside_croplands_fraction_positive.tif"),
            overwrite =T)

```



# Chunk 5 Potential for increased agricultural production and cropland expansion -- cl cannot decrease!

```{r}

# ------------------------------------ How much cropland could increase in %?
  # Calculate how much more croplands there could be in a cell - express in %
  # e.g 100 * (0.45-0.30)/0.30 = 50% 
  # reads as: In a cell there could be 50% more cropland area compared to current crop production area
  # note that r_potential_cropland_expansion_fraction_positive = r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0

r_cropland_expansion_percent_positive <- 
  100 * r_potential_cropland_expansion_fraction_positive / 
  r_fraction_cl_NAto0 # yield Inf valueS when there is no cl


r_cropland_expansion_percent_croplandmask_positive <- 
  mask(r_cropland_expansion_percent_positive,
       r_physical_areas_crops_sum_ha_perpix)


r_cropland_expansion_percent_outside_croplands_positive <- 
  mask(r_cropland_expansion_percent_positive,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)
# r_potential_cropland_expansion_ratio <- r_potential_cropland_expansion_fraction_positive / r_fraction_cl_NAto0 


writeRaster(r_cropland_expansion_percent_positive,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent_positive.tif"), overwrite = T)

writeRaster(r_cropland_expansion_percent_croplandmask_positive,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent_croplandmask_positive.tif"), overwrite = T)

writeRaster(r_cropland_expansion_percent_outside_croplands_positive,
            filename = here("Data", "Intermediate_input",
                            "r_cropland_expansion_percent_outside_croplands_positive.tif"), overwrite = T)



# ------------------------------------------------------------------------- plot

# Cropland expansion when areas where SI ≥ %d would be converted from grazing lands to croplands.\nNegative if current cropland area > it should be based on SI "
# !!!! ehkä nimi voisi olla "Changes in cropland areas depending on how..."

(plt_cropland_expansion33_positive <- 
    create_dynamic_index_map(myraster = r_cropland_expansion_percent_positive,
                             layer_num = 33,
                             main_title = "Cropland expansion POS depending on how strict we are with land suitability 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))






# croplandmask -- miksi näyttää että on enemmän alaa kun maskaa croplandmaskin?
(plt_cropland_expansion_croplandmask33_positive <-
    create_dynamic_index_map(myraster = r_cropland_expansion_percent_croplandmask_positive,
                             layer_num = 33,
                             main_title = "Cropland expansion POS depending on how strict we are with land suitability - croplandmask 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



```


#  Chunk 6: Impact of cropland expansion on grazing land and protein production -- cl cannot decrease!

```{r}

# -------------------------------- How much grazing lands could be reduced in %?
  # Calculate how much less grazing lands there should be in a cell - express in %
  # e.g 100 * (0.45-0.30)/0.40 = 37.5%
  # reads as: In a cell there could be 37.5% less gl area compared to current gl area
  # note that r_potential_cropland_expansion_fraction = r_SIbased_restricted_max_cropland_fraction_NAto0 - r_fraction_cl_NAto0

r_grazingland_reduction_percent_positive <- 
  100 *  r_potential_cropland_expansion_fraction_positive / # which iis the same as r_potential_grazingland_reduction_fraction
  r_fraction_gl # no need for NAto0 as then these would be outside gl areas


r_grazingland_reduction_percent_croplandmask_positive <- 
  mask(r_grazingland_reduction_percent_positive,
       r_physical_areas_crops_sum_ha_perpix)


r_grazingland_reduction_percent_outside_croplands_positive <- 
  mask(r_grazingland_reduction_percent_positive,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)




writeRaster(r_grazingland_reduction_percent_positive,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent_positive.tif"), overwrite = T)

writeRaster(r_grazingland_reduction_percent_croplandmask_positive,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent_croplandmask_positive.tif"), overwrite = T)

writeRaster(r_grazingland_reduction_percent_outside_croplands_positive,
            filename = here("Data", "Intermediate_input",
                            "r_grazingland_reduction_percent_outside_croplands_positive.tif"), overwrite = T)


(plt_grazingland_reduction75 <- 
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent_positive,
                             layer_num = 75,
                             main_title = "Grazing land reduction POS depending on how strict we are with land suitability 75",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))




(plt_grazingland_reduction_croplandmask33 <-
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent_croplandmask_positive,
                             layer_num = 33,
                             main_title = "Grazing land reduction POS depending on how strict we are with land suitability - croplandmask 33",
                             diff_breakvals = c(-Inf, -50, -10,0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



(plt_grazingland_reduction_outside_croplands33 <-
    create_dynamic_index_map(myraster = r_grazingland_reduction_percent_outside_croplands_positive,
                             layer_num = 33,
                             main_title = "Grazing land reduction POS depending on how strict we are with land suitability  - outside croplands 33",
                             diff_breakvals = c(-Inf, -50, -10, 0, 10, 50, 80, Inf),
                             diff_breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "0 to 10", "10 to 50","50 to 80", "more than 80")))



```



# Chunk 7: How much the efficiency changes? -- cl cannot decrease!

```{r}
  # Explore first how much AGB based protein could decrease in current gl areas where crops could expand
################################################################################
r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive <- # eli cl alueiden ulkopuolella --- = gl alueilla -- tämä on tiedossa
  (r_protein_from_AGB_kg_ha$current_herd_str/1000) *
  cellSize(r_protein_from_AGB_kg_ha$current_herd_str, unit = "ha") *
  r_potential_cropland_expansion_outside_croplands_fraction_positive # [0,1] as no current cl outside cl

# check this
test1 <- global(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive, "sum", na.rm=T)/1e6
test1 <- round(test1, 1) # from 4.2 mmt to 0 (cannot decrease below zero on grazing lands)




# Then the trickier part: how much AGB prot can decrease in curret cropland areas?
  # jos pikselissä cl ja gl proteiini tiedossa, vähennys helppo laskea
  # jos pikselissä cl tiedossa mutta gl perusteinen protsku EI tiedossa, pitää käyttää regressiota

################################################################################
r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive <-
  (r_protein_from_AGB_kg_ha$current_herd_str / 1000) *
  cellSize(r_protein_from_AGB_kg_ha$current_herd_str, unit = "ha") *
  
  mask(r_potential_cropland_expansion_croplandmask_fraction_positive,
       r_protein_from_AGB_kg_ha$current_herd_str)

# check this
test2 <- global(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive, 
                "sum", na.rm=T)/1e6
test2 <- round(test2, 1) # from 6.8 to -2.8
################################################################################


################################################################################
r_fraction_cl_where_amount_ofAGBprot_not_known <- 
  mask(r_fraction_cl_0toNA,
       r_protein_from_AGB_kg_ha$current_herd_str, 
       inverse = T) # näille alueille pitää laskea AGB proteiini regression avulla


r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive <-
  (r_predicted_AGB_based_protein_yield_kg_ha/1000) *
  cellSize(r_predicted_AGB_based_protein_yield_kg_ha, unit = "ha") * # this can be also unmasked raster
  
  mask(r_potential_cropland_expansion_croplandmask_fraction_positive,
       r_fraction_cl_where_amount_ofAGBprot_not_known)

#check this
test3 <- global(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive, "sum",na.rm=T)/1e6
test3 <- round(test3, 1)

################################################################################


# Combine 
r_protein_decrease_basedOnSI_grazers_mt_perpix_positive <-
  classify(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive, cbind(NA,0))+
  classify(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive ,cbind(NA,0)) +
  classify(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive, cbind(NA,0))

r_protein_decrease_basedOnSI_grazers_mt_perpix_positive <-
  mask(r_protein_decrease_basedOnSI_grazers_mt_perpix_positive, 
       r_fraction_gl_cl_total_0toNA)
# mostly zero (median = 0) but decrease < 0 when SI high, which means that animal protein increases

#check this
test4 <-
  global(r_protein_decrease_basedOnSI_grazers_mt_perpix_positive, "sum", na.rm=T)/1e6
test4 <- round(test4, 1)
test4


# optimised animal protein production = original protein raster - raster showing how much animal prot should decrease (cannot increase in this scenario)
  # = r_protein_from_AGB_kg_perpix$current_herd_str  - r_grazing_protein_decrease_basedOnSI_kg_perpix 
r_optimized_grazing_protein_kg_perpix_positive <-
  classify(r_protein_from_AGB_kg_perpix$current_herd_str, cbind(NA,0)) - 
  (r_protein_decrease_basedOnSI_grazers_mt_perpix_positive*1000) # -(-) = +

names(r_optimized_grazing_protein_kg_perpix_positive) <- 
  paste0("prot_kgpix_SI", threshold_values)


  # check
r_optimized_grazing_protein_kg_perpix_positive[[5]] %>% 
  plot(., main = "When SI>5 vals 'd be used for crops, there'd be A LOT of cl and little gl")
r_optimized_grazing_protein_kg_perpix_positive[[95]] %>% 
  plot(., main = "When SI>95 vals 'd be used for crops, there'd be much less cl to convert and thus no gl dec")
r_protein_from_AGB_kg_perpix$current_herd_str %>% 
  plot(., main = "Original protein production raster (current herd)")


#check this
test5 <- global(r_optimized_grazing_protein_kg_perpix_positive, "sum", na.rm=T)/1e9
test5 <- round(test5, 1)




# Save
writeRaster(r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_outside_cl_mt_perpix_positive.tif"),
            overwrite =T)


writeRaster(r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_on_pixels_where_clANDgl_protein_known_mt_perpix_positive.tif"),
            overwrite =T)



writeRaster(r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_protein_fromAGB_decrease_basedOnSI_on_cl_pixels_where_gl_protein_NOTknown_mt_perpix_positive.tif"),
            overwrite =T)


writeRaster(r_protein_decrease_basedOnSI_grazers_mt_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_protein_decrease_basedOnSI_grazers_mt_perpix_positive.tif"),
            overwrite =T)



writeRaster(r_optimized_grazing_protein_kg_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_optimized_grazing_protein_kg_perpix_positive.tif"),
            overwrite =T)



######################################################################## Crops

r_protein_increase_basedOnSI_crops_outside_cl_mt_perpix_positive <-
  (r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha/ 1000) *
     cellSize(r_predicted_protein_yield_outside_cl_but_in_gl_areas_kg_ha, unit = "ha")*
     r_potential_cropland_expansion_outside_croplands_fraction_positive



r_protein_increase_basedOnSI_crops_croplandmask_mt_perpix_positive <-
  r_prot_allcrops_sum_kg_ha *
  cellSize(r_prot_allcrops_sum_kg_ha, unit = "ha") *
  r_potential_cropland_expansion_croplandmask_fraction_positive / # -1 to 1
  1000


# convert NA to 0 and combine 
r_protein_increase_basedOnSI_crops_mt_perpix_positive <-
  classify(r_protein_increase_basedOnSI_crops_croplandmask_mt_perpix_positive, cbind(NA,0)) +
  classify(r_protein_increase_basedOnSI_crops_outside_cl_mt_perpix_positive, cbind(NA,0))
 # 520.1s

# optimised yield crops
  # optimoitu sato on vanha sato + mahdollinen lisäsato (joka EI voi olla neg)
  # = r_prot_allcrops_sum_mt_perpix + r_protein_increase_basedOnSI_crops
r_optimised_protein_crops_mt_perpix_positive <-
  classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0)) +
  r_protein_increase_basedOnSI_crops_mt_perpix_positive

names(r_optimised_protein_crops_mt_perpix_positive) <-   
    paste0("cropProt_mtpix_SI", threshold_values)


writeRaster(r_optimised_protein_crops_mt_perpix_positive,
            here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix_positive.tif"),
            overwrite = T)





# optimised combined yield (maybe give names?)
r_optimised_combined_protein_yield_kg_perpix_positive <-
   classify(r_optimized_grazing_protein_kg_perpix_positive, cbind(NA,0)) +
   1000*r_optimised_protein_crops_mt_perpix_positive




r_optimized_combined_protein_yield_larger_percent_positive <-
  100*(r_optimised_combined_protein_yield_kg_perpix_positive - r_protein_combined_kg_perpix)/
  r_protein_combined_kg_perpix




# 
writeRaster(r_optimised_combined_protein_yield_kg_perpix_positive,
            filename = here("Data", "Intermediate_input",
                            "r_optimised_combined_protein_yield_kg_perpix_positive.tif"),
            overwrite= T)

writeRaster(r_optimized_combined_protein_yield_larger_percent_positive,
            filename = here("Data", "Intermediate_input",
                            "r_optimized_combined_protein_yield_larger_percent_positive.tif"),
            overwrite= T)








# # test plot ------ change no change class to something else
(plt_r_optimized_protein_yield_larger75_positive <-
      create_index_map(r_index = r_optimized_combined_protein_yield_larger_percent_positive[[75]],
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised POS combined protein production compared to original combined protein production \n when SI >= 75",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, -50, 0, 20, 50, 100, Inf),
                     breaknames = c("-100 to -50", "-50 to -0",  "0 to 20", "20-50", "50-100", ">100")))






(plt_r_optimized_protein_yield_larger33_positive <-
      create_index_map(r_index = r_optimized_combined_protein_yield_larger_percent_positive[[33]],
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised POS combined protein production compared to original combined protein production \n when SI >= 33",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, -50, 0, 20, 50, 100, Inf),
                     breaknames = c("-100 to -50", "-50 to -0",  "0 to 20", "20-50", "50-100", ">100")))



```


# Chunk 8 Calculate global sums

```{r}
# note gl, cl and gl+cl areas are the same regardless if NAto0 or 0toNA rasters are used instead
  # chunks 2-3
df_SI_positive <-
  tibble(
    SI_class = threshold_values,
    
    Current_grazingland_area_total_Mha = 
           pull(global((r_fraction_gl * cellSize(r_fraction_gl, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    Current_cropland_area_total_Mha = 
           pull(global((r_fraction_cl * cellSize(r_fraction_cl, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    Current_agricultural_total_area_Mha = 
           pull(global((r_fraction_gl_cl_total * cellSize(r_fraction_gl_cl_total, unit = "ha")),
                       "sum", na.rm = T)/1e6),
    
    SI_based_unrestricted_cropland_Mha = 
      pull(global(r_SIbased_unrestricted_cropland_ha_perpix, "sum", na.rm=T)/1e6),
    
    SI_based_restricted_max_cropland_Mha = 
      pull(global(r_SIbased_restricted_max_cropland_ha_perpix, fun = "sum", na.rm = T)/1e6)) 

# cropland expansions Chunk 4
df_SI_positive <- df_SI_positive %>% 
  mutate(potential_cropland_expansion_Mha = 
           pull(global(r_potential_cropland_expansion_ha_perpix_positive, 
                       fun = "sum", na.rm = T)/1e6),
         potential_cropland_expansion_outside_cl_Mha = 
           pull(global(r_potential_cropland_expansion_outside_croplands_ha_perpix_positive,
                       fun = "sum", na.rm = T)/1e6 ),
         potential_cropland_expansion_cl_mask_Mha = 
           pull(global(r_potential_cropland_expansion_croplandmask_ha_perpix_positive,
                       fun = "sum", na.rm = T)/1e6))

# Chunks 5-6 deal with percents -- no need to add them to this df



# Chunk 7 protein

  # animal based protein from AGB (add different masks here?)
df_SI_positive <- df_SI_positive %>% 
  mutate(Protein_from_AGB_original_mmt = 
           pull(global(r_protein_from_AGB_kg_perpix$current_herd_str , "sum", na.rm=T)/1e9),
         Protein_from_AGB_decrease_mmt =
           pull(global(r_protein_decrease_basedOnSI_grazers_mt_perpix_positive, "sum", na.rm=T)/1e6),
         Protein_from_AGB_optimised_mmt = 
           pull(global(r_optimized_grazing_protein_kg_perpix_positive, "sum", na.rm = T)/1e9))


  # crop protein (add masks here?)
df_SI_positive <- df_SI_positive %>% 
  mutate(Original_crop_protein_production_mmt = 
           pull(global(r_prot_allcrops_sum_mt_perpix, "sum", na.rm=T)/1e6),
         
         Optimised_crop_protein_mmt = 
           pull(global(r_optimised_protein_crops_mt_perpix_positive, "sum", na.rm =T)/1e6))



# Optimised combined protein
df_SI_positive <- df_SI_positive %>% 
  mutate(Optimised_combined_protein_mmt = 
           pull(global(r_optimised_combined_protein_yield_kg_perpix_positive,
                       "sum", na.rm =T)/1e9))




# Save df data
write.csv(df_SI_positive,
          here("Data", "Output", "Total_sums_cropland_expansion_and_optimised_protein_production_positive.csv"))

library(openxlsx) # install.packages("openxlsx")
write.xlsx(df_SI_positive, 
           here("Data", "Output", "Total_sums_cropland_expansion_and_optimised_protein_production_positive.xlsx"),
           rowNames = FALSE)

```


# Chunk 9 plot -- the final version of plot in figures

```{r}

df_rounded_positive <- round(df_SI_positive, 1) %>% 
  dplyr::select(-Protein_from_AGB_decrease_mmt)

df_rounded_positive <- df_rounded_positive %>% 
  rename("Current grazingland area" = "Current_grazingland_area_total_Mha",
         "Current cropland area" = "Current_cropland_area_total_Mha",
         "Current agricultural area" = "Current_agricultural_total_area_Mha",
         "SI based unrestricted cropland" = "SI_based_unrestricted_cropland_Mha",
         "SI based restricted cropland" = "SI_based_restricted_max_cropland_Mha",
         "Potential cropland expansion" = "potential_cropland_expansion_Mha",
         "Potential cropland expansion outside cropland" = "potential_cropland_expansion_outside_cl_Mha",
         "Potential cropland expansion on grid cell containing cropland" = "potential_cropland_expansion_cl_mask_Mha",
         "Original protein from AGB" = "Protein_from_AGB_original_mmt",
         "Optimised protein from AGB" = "Protein_from_AGB_optimised_mmt",
         "Original crop protein production" = "Original_crop_protein_production_mmt",
         "Optimised crop protein" = "Optimised_crop_protein_mmt",
         "Optimised combined protein" = "Optimised_combined_protein_mmt")

# Select columns
Mha_columns <- c("Current grazingland area", "Current cropland area", "Current agricultural area",
                 "SI based unrestricted cropland", "SI based restricted cropland",
                 "Potential cropland expansion", "Potential cropland expansion outside cropland",
                 "Potential cropland expansion on grid cell containing cropland")

prot_columns <- c("Original protein from AGB", "Optimised protein from AGB",
                  "Original crop protein production", "Optimised crop protein",
                  "Optimised combined protein")

# Muuta df_rounded:n pitkäksi muodoksi
df_SI_long_Mha_positive <- df_rounded_positive %>%
  dplyr::select(SI_class, all_of(Mha_columns)) %>%
  pivot_longer(cols = -SI_class, names_to = "Variable", values_to = "Value")

df_SI_long_protein_positive <- df_rounded_positive %>%
  dplyr::select(SI_class, all_of(prot_columns))  %>% 
  pivot_longer(cols = -SI_class, names_to = "Variable", values_to = "Value")




# Plot
plt_hectares_line_positive <- 
  ggplot(df_SI_long_Mha_positive %>% filter(SI_class > 0), 
         aes(x = SI_class, y = Value, color = Variable, 
             linetype = ifelse(Variable %in% c("Current grazingland area", "Current cropland area", "Current agricultural area"),
                               "dashed", "solid"))) +
  geom_line(linewidth = 0.7) +
  scale_x_continuous(breaks = seq(0, 100, 5), name = "SI class") +
  scale_y_continuous(name = "Area, million hectares") +
  labs(title = "",
       subtitle = "Agricultural land available for crop production based on SI threshold (CL cannot dec)") +
  scale_color_viridis_d() +
  scale_linetype_manual(values = c("dashed", "solid")) +
  theme_classic() +
  theme(text = element_text(size = 8),
        legend.position = "bottom",
        panel.spacing = unit(2, "lines"))

plt_hectares_line_positive


# Plot
plt_protein_line_positive <- 
  ggplot(df_SI_long_protein_positive %>% filter(SI_class > 0), 
         aes(x = SI_class, y = Value, color = Variable, 
             linetype = ifelse(Variable %in% c("Original protein from AGB", "Original crop protein production"),
                               "dashed", "solid"))) +
  geom_line(linewidth = 0.7) +
  scale_x_continuous(breaks = seq(0, 100, 5), name = "SI class") +
  scale_y_continuous(name = "Protein, million tons") +
  labs(title = "",
       subtitle = "Total protein production based on SI threshold") +
  scale_color_scico_d(palette = "lajolla") +
  scale_linetype_manual(values = c("dashed", "solid")) +
  theme_classic() +
  theme(text = element_text(size = 8),
        legend.position = "bottom",
        panel.spacing = unit(2, "lines"))

plt_protein_line_positive


# Combine the two updated plots
library(gridExtra)  # Load gridExtra library to use grid.arrange()
plt_combined_positive <- grid.arrange(plt_hectares_line_positive, plt_protein_line_positive, ncol = 2)
plt_combined_positive


# Saving plots
ggsave(plt_hectares_line_positive, filename = here("Figures","Linegraph_potential_cl_area_hectares_positive.pdf"))
ggsave(plt_protein_line_positive, filename = here("Figures", "Linegraph_potential_protein_production_positive.pdf"))
ggsave(plt_combined_positive, filename = here("Figures", "Linegraph_combined_100SIrasters_positive.pdf"))

```

# Chunk 10 More plots -- move to figures

```{r}
#  ----------------------------  cropland expansion 1, 33, 75
r_cropland_expansion_percent_lyr_SI_1_33_75_positive <- 
  subset(r_cropland_expansion_percent_positive, 
         c("MaxFracOfCell_ge1", "MaxFracOfCell_ge33", "MaxFracOfCell_ge75"))
names(r_cropland_expansion_percent_lyr_SI_1_33_75_positive) <-
  c("Cropland expansion when SI threshold ≥ 1", 
    "Cropland expansion when SI threshold ≥ 33",
    "Cropland expansion when SI threshold ≥ 75")

# convert NA to 0 and then mask to gl+cl areas
r_cropland_expansion_percent_lyr_SI_1_33_75_NAto0_positive <-
  classify(r_cropland_expansion_percent_lyr_SI_1_33_75_positive, cbind(NA,0))

r_cropland_expansion_percent_lyr_SI_1_33_75_NAto0_agrlandmask_positive <-
  mask(r_cropland_expansion_percent_lyr_SI_1_33_75_NAto0_positive,
       r_fraction_gl_cl_total_0toNA)

pal_cl_expansion <- scico(n = 8, palette = "nuuk",  direction = -1) # try different palette?


(plt_r_cropland_expansion_percent_lyr_SI_1_33_75_positive <-
  create_index_map(r_index = r_cropland_expansion_percent_lyr_SI_1_33_75_NAto0_agrlandmask_positive, 
                   tocrs = "ESRI:54030",
                   index_main_title = "POS", #Crop expansion potential based on suitability restrictions
                   index_label = "[%]",
                   colorpal = pal_cl_expansion,
                   colorNA = "NA",
                   breakvals = c(-Inf, -50, -10, -0.01, 0.01, 10, 50, 100, Inf),
                   breaknames = c("-100 to -50",  "-50 to -10", "-10 to 0", "no change", "0 to 10", "10 to 50", "50 to 100", "> 100")))




```

