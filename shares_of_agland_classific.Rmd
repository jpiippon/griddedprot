---
title: "Fractions"
output: html_document
date: "2023-08-02"
---

Etsitään alueet joissa 90% maatalousmaasta cl tai gl ja joissa molempia yli 10%

Kun tämä tehty, tutkitaan LUR avulla miten maankäytön pitäisi muuttua

```{r}
# Määritä alkuarvot
threshold_gl_or_cl_shareover <- 90
threshold_mixed_share_gte <- 10

# Grazing land osuus maatalousmaasta
r_gl_share_of_agrland <-  100 * r_fraction_gl_NAto0 / r_fraction_gl_cl_total_0toNA 
r_gl_share_of_agrland_over_threshold <- terra::ifel(r_gl_share_of_agrland <= threshold_gl_or_cl_shareover, NA, r_gl_share_of_agrland)


# Croplandin osuus maatalousmaasta
r_cl_share_of_agrland <-  100 * r_fraction_cl_NAto0 / r_fraction_gl_cl_total_0toNA 
r_cl_share_of_agrland_over_threshold <- terra::ifel(r_cl_share_of_agrland <= threshold_gl_or_cl_shareover, NA, r_cl_share_of_agrland)


# Mixed: threshold_mixed_share_gte% tai enemmän maatalousmaasta molempia
r_gl_mask_over_threshold_mixed <- terra::ifel(r_gl_share_of_agrland >= threshold_mixed_share_gte, 1, NA)
r_cl_mask_over_threshold_mixed <- terra::ifel(r_cl_share_of_agrland >= threshold_mixed_share_gte, 1, NA)

# Yhdistä maskit
r_mixed_mask <- r_gl_mask_over_threshold_mixed * r_cl_mask_over_threshold_mixed

# Määritä mixed-alueet
r_gl_cl_share_mixed <- terra::ifel(r_mixed_mask == 1, 1, NA)


plot(r_gl_share_of_agrland_over_threshold, main = paste("Grazing land share of agr land >", threshold_gl_or_cl_shareover, "%"))
plot(r_gl_cl_share_mixed, main = paste("Mixed system: At least", threshold_mixed_share_gte, "% both gl and cl"))
plot(r_cl_share_of_agrland_over_threshold, main = paste("Cropland share of agr land >", threshold_gl_or_cl_shareover, "%"))

# give new names
r_gl_share_of_agrland_over90 <- r_gl_share_of_agrland_over_threshold
r_cl_share_of_agrland_over90 <- r_cl_share_of_agrland_over_threshold









```

# Haetaan LUR -- tässä a) skenaario eli nykyinen, mutta laskettu näille 90% ja 10% alueille

```{r}
LUR_current <- LUR_i_current

LUR_SI_based_NAto0_positive <-
  here("Data", "Intermediate_input", "LUR_SI_based_NAto0_positive.tif") %>% 
  rast() # 100 arvoa
names(LUR_SI_based_NAto0_positive) <- paste0("LUR_SI_gte", threshold_values)

# -------------------------------------- Current LUR eri tuotantosysteemeissä

  # 90% tai enemmän cl ym vaihtoehdot
LUR_current_where90orover_cl <- mask(LUR_current, r_cl_share_of_agrland_over90)
LUR_current_where90orover_gl <- mask(LUR_current, r_gl_share_of_agrland_over90)
LUR_current_wheremixed_glcl <- mask(LUR_current, r_gl_cl_share_mixed)

LUR_current_4_productionareas <- 
  c(LUR_current, 
    LUR_current_where90orover_cl,
    LUR_current_where90orover_gl,
    LUR_current_wheremixed_glcl)
names(LUR_current_4_productionareas) <- 
  c("current LUR", "over 90% cl", "over 90% gl", "mixed: +10% cl and gl")



(plt_LUR_current <- # works when LUR layers have different names
  create_index_map(r_index = LUR_current_4_productionareas, 
                   tocrs = "ESRI:54030",
                   index_main_title = "Current LUR in diff production areas (dominated by crops/grazing or mixed)",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))
# Current LUR values masked to different produciton areas

```


# LUR skenaariossa b) -- kaikki maa-ala croplandiksi (ja taustaoloetus: cl cannot dec)

-- kaikki agr land cl oletus kannattaa ehkä tehdä predictin avulla ennemmin kuin SI_suitabilities avulla?
-- suunnilleen samanlaiset tulokset (testattu tän skriptin lopussa)

```{r}
# All to cropland (unmasked)
LUR_SI_based_NAto0_positive$LUR_SI_gte1 # kaikki maat joilla SI>0 sopivat croplandeiksi

# mask to different production areas ( >90% cl, mixed, >90% gl)
LUR_allSuitable_clwhere90orover_cl <- 
  mask(LUR_SI_based_NAto0_positive$LUR_SI_gte1, 
       r_cl_share_of_agrland_over90)
# näistä voisi edelleen antaa arvot -999 niille alueille joilla ei ole gl
LUR_allSuitable_cl_butonly_cl <-
  mask(LUR_allSuitable_clwhere90orover_cl, 
       r_cl_outside_gl) # tässä ne alueet joilla EI NYKYÄÄN ole laidunta --> onko tää ok? varmaan

LUR_allSuitable_cl_butonly_cl <- classify(LUR_allSuitable_cl_butonly_cl, cbind(0, -999))

LUR_allSuitable_clwhere90orover_cl <- 
  app(c(LUR_allSuitable_clwhere90orover_cl, LUR_allSuitable_cl_butonly_cl),
                     fun = "sum", na.rm=T)






LUR_allSuitable_clwhere90orover_gl<-
  mask(LUR_SI_based_NAto0_positive$LUR_SI_gte1 ,
       r_gl_share_of_agrland_over90)

LUR_allSuitable_clwhereMixed_glcl <-
  mask(LUR_SI_based_NAto0_positive$LUR_SI_gte1 ,
       r_gl_cl_share_mixed)

# LUR_scenario_all_cl_4maps <- 
#   c(LUR_SI_based_NAto0_positive$LUR_SI_gte1, 
#     LUR_allSuitable_clwhere90orover_cl, 
#     LUR_allSuitable_clwhere90orover_gl,
#     LUR_allSuitable_clwhereMixed_glcl)
# names(LUR_scenario_all_cl_4maps) <- 
#   c("LUR all land cl","over 90% cl", "over 90% gl", "mixed: +10% cl and gl")
# 

# (plt_LUR_scenario_all_cl <- # works when LUR layers have different names
#   create_index_map(r_index = LUR_scenario_all_cl_4maps, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "Scenario all agr.land to crops. LUR in different production areas (dominated by crops/grazing or mixed)",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 1, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))


LUR_scenario_ALLCL <- 
  c(LUR_SI_based_NAto0_positive$LUR_SI_gte1,
    LUR_allSuitable_clwhere90orover_cl,
    LUR_allSuitable_clwhereMixed_glcl,
    LUR_allSuitable_clwhere90orover_gl)

names(LUR_scenario_ALLCL) <- 
  c("Scenario all converted to cl",
    "All cl on areas whr +90% cl", 
    "All cl on areas whr mixed",
    "All cl on areas whr +90% gl")

# all together
LUR_current_plus_scenario_ALLCL <- 
  c(LUR_current, LUR_SI_based_NAto0_positive$LUR_SI_gte1,
    LUR_current_where90orover_cl, LUR_allSuitable_clwhere90orover_cl,
    LUR_current_wheremixed_glcl, LUR_allSuitable_clwhereMixed_glcl,
    LUR_current_where90orover_gl, LUR_allSuitable_clwhere90orover_gl)

names(LUR_current_plus_scenario_ALLCL) <- 
  c("Current", "Scenario all converted to cl",
    "Current whr +90% cl", "All cl on areas whr +90% cl", 
    "Current whr mixed", "All cl on areas whr mixed",
    "Current whr +90% gl", "All cl on areas whr +90% gl")

(plt_LUR_current_plus_scenario_ALLCL <-
    create_index_map(r_index = LUR_current_plus_scenario_ALLCL, # plots 2 cols if plotviewer ikkuna kapea
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR on different areas in different scenarios",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 1, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))

tmap_save(plt_LUR_current_plus_scenario_ALLCL,
            filename = here("Figures", "LUR", "LUR_current_plus_scenario_ALLCL.png"))






# ---------- testaa onko alueita, joilla SI>0 ja jotka ovat silti LUR <1 alueita
LUR_current_plus_scenario_ALLCL_whereSIover0 <- 
  mask(LUR_current_plus_scenario_ALLCL, 
       terra::ifel(SI_5arcmin == 0, NA, LUR_current_plus_scenario_ALLCL))

(plt_LUR_current_plus_scenario_ALLCL_whereSIover0 <-
    create_index_map(r_index = LUR_current_plus_scenario_ALLCL_whereSIover0, 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR on 'all cropland' scenario\n in dif systems masked to SI>1 areas",
                   index_label = "[LUR]",
                   colorpal = pal_lur_inc_grey,
                   breakvals = c(-999, 0, 2, 10, 100,  Inf),
                   breaknames = c("Not known, only crops", "0-1","1-10","10-100",">100")))

# tmap_save(plt_LUR_current_plus_scenario_ALLCL_whereSIover0,
#             filename = here("Figures", "LUR", "plt_LUR_current_plus_scenario_ALLCL_whereSIover0.png"))
```


# LUR skenaariossa kaikki agr land grazing landiksi (taustaoletus: cl CAN decrease)

--> juttele Mikan kanssa pitäiskö tää tehdä predictin avulla ja pitäisikö LUR olla 0 vai mitä

```{r}
LUR_when_land_only_suitable_for_grazing <- LUR_SI_based_NAto0$LUR_SI_gte99 # kaikki maa sopimatonta cl --- siispä vain gl ja LUR = 0 kaikkialla --> Onko LUR 0 koska periaatteessa verrataan siihen HDP määrään jota kyseiseltä maalta voitaisiin tuottaa --> mutta kun ei voida tuottaa yhtään jos ollaan noin vaativia SI suhteen
# toki alueilla, joilla vain cl, lur on NOT KNOWN -- pitäisi vaihtaa se tänne

#LUR_whereSI_over99_gl <- mask(LUR_SI_based_NAto0$LUR_SI_gte99,  

LUR_when_land_only_suitable_for_grazing_where90orover_cl <-
  mask(LUR_when_land_only_suitable_for_grazing, 
       r_cl_share_of_agrland_over90)


LUR_when_land_only_suitable_for_grazing_wheremixed <-
  mask(LUR_when_land_only_suitable_for_grazing, 
       r_gl_cl_share_mixed)

LUR_when_land_only_suitable_for_grazing_whereplus90_gl <-
  mask(LUR_when_land_only_suitable_for_grazing, 
       r_gl_share_of_agrland_over90)
```


# Punaisessa vihkossa oleva tapa: omat kartat -- skenaario (nämä jo yllä paitsi +90% gl)
1) >90% cl   
2) >10 cl, >10gl 
3) > 90% gl

```{r}
# -------------------------------------------- LUR: 1) +90% cl oletuksissa a)-c)
  # a) current
# LUR_current_where90orover_cl
#   # b) all agr.land where SI > 0 is cl (kaikki mahdollinen croplandia) --> tässä kai virhe koska keltaista maissivyöllä --- pitääkö laskea lm perusteella LO_i myös niille cl joilla ei nyt ole gl? ---> Joo, muutettu niin! --> ei näy harmaata II paneelissa koska agb_prot tiedetään nyt
# LUR_allSuitable_clwhere90orover_cl
#   # c) all agr.land where land is unsuitable (SI >99) is gl (kaikki mahdollinen grazing landia)
# LUR_when_land_only_suitable_for_grazing_where90orover_cl# taustaoletus: cl CAN decrease, jotta ollaan saatu oikea kuvio --> pitääkö maskata alueille joilla yli 90% croppia?
# 
# 
# 
# LUR_scen1 <- 
#   c(LUR_current_where90orover_cl,
#     LUR_allSuitable_clwhere90orover_cl,
#     LUR_when_land_only_suitable_for_grazing_where90orover_cl)
# names(LUR_scen1) <- c("Present", "All agr.land is cropland", "All agr.land is grazing land")
# 
# (plt_LUR_scen1 <-
#     create_index_map(r_index = LUR_scen1, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "LUR on areas where >90 is currently dominated by crops",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 2, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-2","2-10","10-100",">100")))
# 
# # Tulkinta: nykyskenaariossa kasvit >> eläimet, jos solussa on molempia
# # Jos kaikki soveltuva maa on cl, on edelleen alueita joilla ei kannata olla viljaa (Nämä osaksi SI==0 alueita? mutta myös soveltuvilla mailla alueita, joilla LUR < 1)
# # Jos kaikki maa on laitumena, LUR toki 0 koska kasvien tuottokyky nolla
# 
# # ? Miten yhdistäisi tämän kartan yhdeksi? Tarvitseeko edes? Onko järkevää näyttää vain present ja kaikki cl?
# 
# # testaa onko alueita, joilla SI>0 ja jotka ovat silti LUR <1 alueita
# kok <- mask(LUR_SI_based_NAto0_positive$LUR_SI_gte1, 
#             terra::ifel(SI_5arcmin == 0, NA, LUR_SI_based_NAto0_positive$LUR_SI_gte1))
# 
# create_index_map(r_index = kok, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "LUR when all is converted to cropland and when SI>0",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 2, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-2","2-10","10-100",">100"))
# 
# # add more than 90% cl mask
# create_index_map(r_index = mask(kok, r_cl_share_of_agrland_over90), 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "LUR when all is converted to cropland and when SI>0 ON AREAS WITH +90 CL",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 2, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-2","2-10","10-100",">100"))
# 
# 
# 
# 
# 
# 
# # -------------------------------------------- LUR: 2) mixed oletuksilla a)-c)
#   # a) current
# LUR_current_wheremixed_glcl
#   # b) all cl
# LUR_allSuitable_clwhereMixed_glcl 
#   # c) all gl
# LUR_when_land_only_suitable_for_grazing_wheremixed
# 
# 
# LUR_scen2 <- c(LUR_current_wheremixed_glcl, LUR_allSuitable_clwhereMixed_glcl, LUR_when_land_only_suitable_for_grazing_wheremixed)
# names(LUR_scen2) <- c("Present", "All agr.land is cropland", "All agr.land is grazing land")
# 
# (plt_LUR_scen2 <-
#     create_index_map(r_index = LUR_scen2, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "LUR on mixed areas where both crops&livestock uses +10 of agr.land",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 2, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-2","2-10","10-100",">100")))
# 
# 
# 
# 
# # -------------------------------------------- LUR: 3) yli 90% laitumena oletuksilla a)-c)
# LUR_scen3 <-
#   c(LUR_current_where90orover_gl, 
#     LUR_allSuitable_clwhere90orover_gl,  
#     LUR_when_land_only_suitable_for_grazing_whereplus90_gl)
# names(LUR_scen3) <- c("Present", "All agr.land is cropland", "All agr.land is grazing land")
# 
# (plt_LUR_scen3 <-
#     create_index_map(r_index = LUR_scen3, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "LUR on areas where >90 is currently dominated by grazing land",
#                    index_label = "[LUR]",
#                    colorpal = pal_lur_inc_grey,
#                    breakvals = c(-999, 0, 2, 10, 100,  Inf),
#                    breaknames = c("Not known, only crops", "0-2","2-10","10-100",">100")))
```


# Alternative 1: 
efficiency increases (see excel/word)

viimeisiä all gl maski kuvioita ei tarvita, koska niissä aina LUR = 0 --> onko muka? Periaatteessa tiedetään mikä kasvien sato olisi tällöin -- voidaan siis laskea LO kaikelle agr.landille mutta myös HDP kaikelle agr.landille, joten LUR saadaan kyllä laskettua <-- mutta edelleen, jos kaikki ala on gl niin onko HDP ollenkaan? 
Jos lasketaan predictin avulla AGB_prot ja SPAM_prot ja sitten LUR, se on samalla "all converted to cl" ja "all converted to gl"

huom, yllä maskattu SI < 0 alueille mutta tämä on eri, maskataan LUR > 1

```{r}
# Alternative 1:
  # mask scenario ALL CL to areas where LUR currently < 1.
  # then explore whether it changes to >1 or even >2 or even >20

# Function for this
f_return_ALLtoCL_wherecurrentLUR_within <- function(x1, x2) {
  # This function masks the raster LUR_scenario_ALLCL to retain 
  # values that are at least x1 but less than x2. All other values 
  # are set to NA.
  
  r_ALLtoCL_wherecurrentLUR_within <- 
    mask(LUR_scenario_ALLCL,
         terra::ifel(LUR_current >= x1 & LUR_current < x2, # If this condition is met
                     LUR_current, # Return this
                     NA)) # Otherwise return this
  
  return(r_ALLtoCL_wherecurrentLUR_within)
}

LUR_scenario_ALLCL_whereLURcurrent0to1 <- f_return_ALLtoCL_wherecurrentLUR_within(0,1)
LUR_scenario_ALLCL_whereLURcurrent1to2 <- f_return_ALLtoCL_wherecurrentLUR_within(1,2)
LUR_scenario_ALLCL_whereLURcurrent2to20 <- f_return_ALLtoCL_wherecurrentLUR_within(2,20)
LUR_scenario_ALLCL_whereLURcurrent20toInf <- f_return_ALLtoCL_wherecurrentLUR_within(2,Inf)

# ALLtoCL masked to areas where LUR_current < 1 (areas where gl more efficient)
create_index_map(r_index = LUR_scenario_ALLCL_whereLURcurrent0to1, 
                 tocrs = "ESRI:54030",
                 index_main_title = "LUR in scenario ALLtoCL in areas where original LUR was [0,1[",
                 index_label = "[LUR]",
                 colorpal = pal_lur,
                 breakvals = c(0, 1, 2, 20, Inf),
                 breaknames = c("GL more eff, eff remains", "eff + bit: cl more eff","eff ++", "eff +++ notably"))


# ALLtoCL masked to areas where LUR_current [1,2[ (areas where cl bit more efficient)
create_index_map(r_index = LUR_scenario_ALLCL_whereLURcurrent1to2, 
                 tocrs = "ESRI:54030",
                 index_main_title = "LUR in scenario ALLtoCL in areas where original LUR was [1,2[",
                 index_label = "[LUR]",
                 colorpal = pal_lur,
                 breakvals = c(0, 1, 2, 20, Inf),
                 breaknames = c("eff decreases", "remains the same","eff ++", "eff +++ notably"))

# Tulkinta: tehokkuus pääosin kasvaa merkittävästi, mutta huononee kuivilla alueilla, joilla muutenkin yli 90% maankäytöstä gl
# yhdistä lopulta nämä alternative 1 kuvat johonkin, joka näyttää missä tehokkuus paranee ja missä huononee

# ALLtoCL masked to areas where LUR_current [2,20[ 
create_index_map(r_index = LUR_scenario_ALLCL_whereLURcurrent2to20, 
                 tocrs = "ESRI:54030",
                 index_main_title = "LUR in scenario ALLtoCL in areas where original LUR was [2,20[",
                 index_label = "[LUR]",
                 colorpal = pal_lur,
                 breakvals = c(0, 1, 2, 20, Inf),
                 breaknames = c("eff decreases notably", "eff decreases","eff remains", "eff + notably"))

# ALLtoCL masked to areas where LUR_current [20,Inf[ (essentially greater than or equal to 20)
create_index_map(r_index = LUR_scenario_ALLCL_whereLURcurrent20toInf, 
                 tocrs = "ESRI:54030",
                 index_main_title = "LUR in scenario ALLtoCL in areas where original LUR was [20,Inf[",
                 index_label = "[LUR]",
                 colorpal = pal_lur,
                 breakvals = c(0, 1, 2, 20, Inf),
                 breaknames = c("eff decreases notably", "eff decreases notably","eff dec", "eff remains"))


```

# Recode

Tehdään nyt vain niin, että efficiencyy dec notably jos se muuttuu LUR < 1 eli jos gl more eff
Ei näytetä muutoksia jos LUR muutttuu >1 Lurrin sisällä (esim 20 to 15)


Kerätään vaihtoehdoista sellaiset tiedot, että voidaan sanoa
1) Beneficial to convert gl to cl
2) Beneficial to convert cl to gl
3) Remain as it is 

Pitää varmaan kategorisoida tätä varten jotenkin?
1) Kaikki joissa gl to cl saavat arvon 1, 2, 3 (1 = bit beneficial to convert, 2 = beneficial to convert, 3=very beneficial to convert)
2) kaikki cl to gl saavat arvon -1, -2 tai -3
3) Jos ei ole tarvetta muuttaa maankäyttöä, niin 0 VAI "tehokkuus ei muutu" = 0

VAI ENSIN näin: "Kun maankäyttö muutetaan nykyisestä "ALL TO CROPLAND", niin
1) Efficiency increases (1 = bit beneficial to convert, 2 = beneficial to convert, 3=very beneficial to convert)
2) Efficiency decreases (-1 = bit harmful to convert, 2 = harmful to convert, 3=very harmful to convert)
3) Efficiency remains somewhat same (0 no large impacts)

```{r}

# --------------------------------------------------------------------- recode
rcl_LUR_scenario_ALLCL_whereLURcurrent0to1 <- 
  c( # when we convert all agr.land, where LUR was < 1 to cropland, in these cells
  0, 1, 0, # efficiendy remains, i.e. grazing remains more efficient
  1, 2, 1, # efficiency increases slightly when converting to cropland
  2, 20, 1, # efficiency increases 
  20, Inf, 1 # efficiency increases notably 
  ) %>% 
  matrix(., ncol=3, byrow = T)

LUR_scenario_ALLCL_whereLURcurrent0to1_recoded <-
  classify(LUR_scenario_ALLCL_whereLURcurrent0to1,
  rcl_LUR_scenario_ALLCL_whereLURcurrent0to1,
  right = FALSE)


rcl_LUR_scenario_ALLCL_whereLURcurrent1to2 <-
  c( # when we convert regions where current LUR [1,2[ to "ALL to CROPS" and get new LUR values between range [x1, x2[, in these cells
    0, 1, -1, # efficiency decreases notably (dec so much that gl more efficient)
    1, 2, 0, # efficiency remains the same
    2, 20, 1, # efficiency increases 
    20, Inf, 1 # efficiency increases notably
  ) %>% 
  matrix(., ncol=3, byrow = T)

LUR_scenario_ALLCL_whereLURcurrent1to2_recoded <-
  classify(LUR_scenario_ALLCL_whereLURcurrent1to2,
  rcl_LUR_scenario_ALLCL_whereLURcurrent1to2,
  right = FALSE) 


# Recoding the rasters for the ranges [2,20[ 
rcl_LUR_scenario_ALLCL_whereLURcurrent2to20 <- 
  c(0, 1, -1,
    1, 2, 0, # maybe change to negative. Now 0 as changes within LUR>1 e.g. 2.9to2.1
    2, 20, 0,
    20, Inf, 1
  ) %>% 
  matrix(., ncol=3, byrow = T)

LUR_scenario_ALLCL_whereLURcurrent2to20_recoded <-
  classify(LUR_scenario_ALLCL_whereLURcurrent2to20,
  rcl_LUR_scenario_ALLCL_whereLURcurrent2to20,
  right = FALSE)

# Recoding the rasters for the ranges [20,Inf[ 
rcl_LUR_scenario_ALLCL_whereLURcurrent20toInf <- 
  c(0, 1, -1,
    1, 2, 0, #  # maybe change to negative. Now 0 as changes within LUR>1 e.g. 29to2.1
    2, 20, 0, # maybe change to negative. Now 0 as changes within LUR>1 e.g. 29to2.1
    20, Inf, 0 # 
  ) %>% 
  matrix(., ncol=3, byrow = T)

LUR_scenario_ALLCL_whereLURcurrent20toInf_recoded <-
  classify(LUR_scenario_ALLCL_whereLURcurrent20toInf,
  rcl_LUR_scenario_ALLCL_whereLURcurrent20toInf,
  right = FALSE)

```

# Combine recoded rasters

```{r}
# Käytetään app-funktiota soveltamaan safe_sum-funktiota rasterilistalle.
r_LUR_efficiencychanges1 <- sum(c(LUR_scenario_ALLCL_whereLURcurrent0to1_recoded[[1]], 
                                    LUR_scenario_ALLCL_whereLURcurrent1to2_recoded[[1]], 
                                    LUR_scenario_ALLCL_whereLURcurrent2to20_recoded[[1]], 
                                    LUR_scenario_ALLCL_whereLURcurrent20toInf_recoded[[1]]), 
                               na.rm=T)


r_LUR_efficiencychanges2 <- sum(c(LUR_scenario_ALLCL_whereLURcurrent0to1_recoded[[2]], 
                                    LUR_scenario_ALLCL_whereLURcurrent1to2_recoded[[2]], 
                                    LUR_scenario_ALLCL_whereLURcurrent2to20_recoded[[2]], 
                                    LUR_scenario_ALLCL_whereLURcurrent20toInf_recoded[[2]]), 
                               na.rm=T)


r_LUR_efficiencychanges3 <- sum(c(LUR_scenario_ALLCL_whereLURcurrent0to1_recoded[[3]], 
                                    LUR_scenario_ALLCL_whereLURcurrent1to2_recoded[[3]], 
                                    LUR_scenario_ALLCL_whereLURcurrent2to20_recoded[[3]], 
                                    LUR_scenario_ALLCL_whereLURcurrent20toInf_recoded[[3]]), 
                               na.rm=T)


r_LUR_efficiencychanges4 <- sum(c(LUR_scenario_ALLCL_whereLURcurrent0to1_recoded[[4]], 
                                    LUR_scenario_ALLCL_whereLURcurrent1to2_recoded[[4]], 
                                    LUR_scenario_ALLCL_whereLURcurrent2to20_recoded[[4]], 
                                    LUR_scenario_ALLCL_whereLURcurrent20toInf_recoded[[4]]), 
                               na.rm=T)


r_LUR_efficiencychanges <-
  c(r_LUR_efficiencychanges1,
    r_LUR_efficiencychanges2,
    r_LUR_efficiencychanges3,
    r_LUR_efficiencychanges4)

r_LUR_efficiencychanges <- 
  terra::ifel(r_LUR_efficiencychanges < -1, -1, r_LUR_efficiencychanges)

names(r_LUR_efficiencychanges) <- 
    c("Scenario all converted to cl",
    "All cl on areas whr +90% currently cl", 
    "All cl on areas whr currentlymixed",
    "All cl on areas whr currently +90% gl")

  


# Plotataan tulos
colorpal_updated <- c("firebrick3", "grey70", "dodgerblue3")

(plt_LUR_efficiency_changes <- 
  create_index_map(r_index = r_LUR_efficiencychanges,
                 tocrs = "ESRI:54030",
                 index_main_title = "Efficiency changes in different LUR scenarios",
                 index_label = "Efficiency Change",
                 colorpal = colorpal_updated,
                 breakvals = c(-Inf,-0.1, 0.1, Inf),
                 breaknames = c("Decreases to LUR<1", "Remains the same", "Increases")))


tmap_save(plt_LUR_efficiency_changes,
          filename =here("Figures", "LUR", "plt_LUR_efficiency_changes.png"))
 
 
```










