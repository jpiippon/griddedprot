---
title: 'Comparisons: grazing livestock and crops'
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---



# Get data
- saved to folder Intermediate inputs

```{r}
# Crop production areas
r_physical_areas_crops_sum_ha_perpix <-
  here("Data", "Intermediate_input","r_physical_areas_crops_sum_ha_perpix.tif") %>% 
  rast()



# Crop protein and energy
r_prot_allcrops_sum_mt_perpix <- here("Data", "Intermediate_input","protein_production_27crops_sum_mt_perpix.tif") %>%
  rast() # upd 30.3.2023

r_prot_allcrops_sum_kg_ha <- here("Data", "Intermediate_input","protein_production_27crops_sum_kg_ha.tif") %>%
  rast() # WHEA RICE   upd 27.3.2023


# Livestock protein and energy
r_protein_from_065xAGB_kg_perpix <- here("Data", "Intermediate_input","r_protein_from_065xAGB_kg_perpix.tif") %>% rast() # upd 5.4.2023

r_protein_from_065xAGB_kg_ha <- here("Data", "Intermediate_input","r_protein_from_065xAGB_kg_ha.tif") %>% rast() # upd 31.3.2023


r_kcal_from_065xAGB_MM_ha <- here("Data", "Intermediate_input","r_kcal_from_065xAGB_MM_ha.tif") %>%  rast() # upd 31.3.2023




# ------------------------------------------------- fractions
r_fraction_cl <- here("Data", "Intermediate_input","r_fraction_cl_with_27_spamcrops.tif") %>% rast()
r_fraction_cl_0toNA <- classify(r_fraction_cl, cbind(0,NA))
r_fraction_cl_NAto0 <- classify(r_fraction_cl, cbind(NA,0))

summary(r_fraction_cl) # min 0 max 1 NA's 91387 
summary(r_fraction_cl_0toNA) # min 0 max 1 NA's 91461  --> 74 NA more somewhere
summary(r_fraction_cl_NAto0) # min 0 max 1.004 NA's 0



r_fraction_gl <-  
  here("Data","Input","from_harddrive","fraction_of_cell_that_is_hyde_grazingland.tif") %>% rast()
r_fraction_gl_0toNA <- classify(r_fraction_gl, cbind(0,NA))
r_fraction_gl_NAto0 <- classify(r_fraction_gl, cbind(NA,0))


summary(r_fraction_gl) # min 0 max 1 NA's 76548 --> less Na cells than cl has 
summary(r_fraction_gl_0toNA) # min 0 max 1 NA's 85225
summary(r_fraction_gl_NAto0) # min 0 max 1.004 NA's 0


# ------------------------------------------------- SI
SI_5arcmin <- here("Data", "Input", "Zabel22_SI",
     "SI_5arcmin_overall_suitability_hist1980_2009_current_irr_areas_applied.tif") %>% 
  rast()


```


# Calculate total protein currently produced in cell 
Or maybe not currently but crops + animals anyway



```{r}
# ---------------------------------------------------- calculate per pixel 
r_protein_combined_kg_perpix_when_dairy <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_065xAGB_kg_perpix$dairy), 
           fun = sum, na.rm = T) # must use app as gl and cl not overlapping. Alternatively:
# r_protein_combined_kg_perpix_when_dairy2 <-
#   1000 * classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0)) +
#   classify( r_protein_from_AGB_kg_perpix$dairy, cbind(NA, 0))


r_protein_combined_kg_perpix_when_beef <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_065xAGB_kg_perpix$beef), 
           fun = sum, na.rm = T)

r_protein_combined_kg_perpix_when_sheepgoats <-
    app(c(1000 * r_prot_allcrops_sum_mt_perpix, r_protein_from_065xAGB_kg_perpix$sheep_and_goats), 
           fun = sum, na.rm = T)


r_protein_combined_kg_perpix <-
  c(r_protein_combined_kg_perpix_when_dairy,
    r_protein_combined_kg_perpix_when_beef,
    r_protein_combined_kg_perpix_when_sheepgoats)
names(r_protein_combined_kg_perpix) <- c("when Dairy cattle", "when Beef cattle", "when Sheep and goats")



summary(r_protein_from_065xAGB_kg_perpix)
summary(1000 * r_prot_allcrops_sum_mt_perpix)
summary(r_protein_combined_kg_perpix)


```


# Grazing livestock's share of total protein production on agricultural land

This map illustrates the percentage of protein produced by grazing livestock in relation to the combined protein production from both grazing livestock and the 27 SPAM food crops on agricultural land. It highlights the areas where grazing livestock plays a more significant role in contributing to the total protein production within agricultural systems.


```{r}

# share of the total protein that originates from livestock
  ## first convert NA to 0
r_protein_from_AGB_kg_perpix_NAto0 <- classify(r_protein_from_065xAGB_kg_perpix, cbind(NA, 0))
r_share_of_total_protein_livestock <- 100* (r_protein_from_AGB_kg_perpix_NAto0 / r_protein_combined_kg_perpix)
plot(r_share_of_total_protein_livestock, main = "Contribution of livestock to total protein production")


# share of the total protein that originates from crops 
  ## first convert NA to 0
# r_prot_allcrops_sum_kg_perpix_NAto0 <- 1000 * classify(r_prot_allcrops_sum_mt_perpix, cbind(NA, 0))
# r_share_of_total_protein_crops <- 100* (r_prot_allcrops_sum_kg_perpix_NAto0 / r_protein_combined_kg_perpix) 
# plot(r_share_of_total_protein_crops)
# 
#  ## test
# mean(r_share_of_total_protein_livestock + r_share_of_total_protein_crops) # should be 100





# --------------------------------------------------- same masked to cl
  ## cropland mask 
  ## share of livestock masked to croplands to show that on cropland areas livestock produce only a little
r_share_of_total_protein_livestock_croplandmask <-
  mask(r_share_of_total_protein_livestock, 
       r_fraction_cl_0toNA)

plot(r_share_of_total_protein_livestock_croplandmask, main = "Contribution of livestock to total protein production on croplands")




# ----------------------- further masked to cl where SI extremely low (below 10)

  ## SI below 10 mask AND croplandmask
SI_5arcmin_below10 <- SI_5arcmin
SI_5arcmin_below10[SI_5arcmin_below10 >= 10] <- NA
plot(SI_5arcmin_below10, main = "SI below 10")

SI_5arcmin_below10_croplandmask <- mask(SI_5arcmin_below10, r_fraction_cl_0toNA)
plot(SI_5arcmin_below10_croplandmask, main = "SI below 10 on croplands")

r_share_of_total_protein_livestock_SIbelow10mask_croplandmask <-
  mask(r_share_of_total_protein_livestock, SI_5arcmin_below10_croplandmask)

plot(r_share_of_total_protein_livestock_SIbelow10mask_croplandmask, 
     main = "Contribution of livestock to total protein production on croplands where SI < 10")



```











# global sums --- trimming -- create function for that

```{r}
## total combined protein on agricultural lands
  #  do not calculate total sums here from r_prot_allcrops_sum_mt_perpix with outliers function
  ## this r_protein_combined_kg_perpix includes nested layers( kind of) and outlier funktion does not work


f_global_sum_without_outliers(r_prot_allcrops_sum_mt_perpix*1000)/1e9  +
  f_global_sum_without_outliers(r_protein_from_065xAGB_kg_perpix$dairy) /1e9 # 266 when dairy

f_global_sum_without_outliers(r_prot_allcrops_sum_mt_perpix*1000)/1e9  +
  f_global_sum_without_outliers(r_protein_from_065xAGB_kg_perpix$beef) /1e9 # 246

f_global_sum_without_outliers(r_prot_allcrops_sum_mt_perpix*1000)/1e9  +
  f_global_sum_without_outliers(r_protein_from_065xAGB_kg_perpix$sheep_and_goats) /1e9 # 246


## livestock protein on croplands
r_protein_from_065xAGB_kg_perpix_croplandmask <-
  mask(r_protein_from_065xAGB_kg_perpix, 
       r_fraction_cl_0toNA)
plot(r_protein_from_065xAGB_kg_perpix_croplandmask)

## livestock protein on croplands where SI < 10
r_protein_from_065xAGB_kg_perpix_SIbelow10mask_croplandmask <-
  mask(r_protein_from_065xAGB_kg_perpix, 
       SI_5arcmin_below10_croplandmask)

plot(r_protein_from_065xAGB_kg_perpix_SIbelow10mask_croplandmask)





# ----------------------------------------------- global sums
f_global_sum_without_outliers(r_protein_from_065xAGB_kg_perpix_croplandmask)/1e9 #dairy 15, beef 4 sheepgoat 4
f_global_sum_without_outliers(r_protein_from_065xAGB_kg_perpix_SIbelow10mask_croplandmask)/1e9 #dairy 0.8, beef 0.2 sheepgoat 0.3


  ## sums without removing outliers
global(r_protein_from_065xAGB_kg_perpix_croplandmask, fun = "sum", na.rm = T)/1e9 # dairy 19 mmt, beef 5, sheepgoat 5
global(r_protein_from_065xAGB_kg_perpix_SIbelow10mask_croplandmask, fun = "sum", na.rm = T)/1e9 # dairy 1 mmt, beef 0.2, sheepgoat 0.3 average 0.5


```


# kcal --- do same thing for energy?


# test how livestock contribution to total protein looks when masked to low SI regions

```{r}
# SI_5arcmin_below10 <- SI_5arcmin
# SI_5arcmin_below15 <- SI_5arcmin
# SI_5arcmin_below20 <- SI_5arcmin
# SI_5arcmin_below33 <- SI_5arcmin
# 
# SI_5arcmin_below10[SI_5arcmin_below10 >= 10] <- NA
# SI_5arcmin_below15[SI_5arcmin_below15 >= 15] <- NA
# SI_5arcmin_below20[SI_5arcmin_below20 >= 20] <- NA
# SI_5arcmin_below33[SI_5arcmin_below33 >= 33] <- NA
# 
# SI_5arcmin_below10_croplandmask <- mask(SI_5arcmin_below10, r_global_production_crops_sum_mt)
# SI_5arcmin_below15_croplandmask <- mask(SI_5arcmin_below15, r_global_production_crops_sum_mt)
# SI_5arcmin_below20_croplandmask <- mask(SI_5arcmin_below20, r_global_production_crops_sum_mt)
# SI_5arcmin_below33_croplandmask <- mask(SI_5arcmin_below33, r_global_production_crops_sum_mt)
# 
# 
# r_share_of_total_protein_livestock_SIbelow10mask_croplandmask <-mask(r_share_of_total_protein_livestock, SI_5arcmin_below10_croplandmask)
# r_share_of_total_protein_livestock_SIbelow15mask_croplandmask <-mask(r_share_of_total_protein_livestock, SI_5arcmin_below15_croplandmask)
# r_share_of_total_protein_livestock_SIbelow20mask_croplandmask <-mask(r_share_of_total_protein_livestock, SI_5arcmin_below20_croplandmask)
# r_share_of_total_protein_livestock_SIbelow33mask_croplandmask <-mask(r_share_of_total_protein_livestock, SI_5arcmin_below33_croplandmask)
# 
# 
# 
# 
# 
# 
# (plt_shareoflivestock_of_total_protein_SIbelow10_croplandmask <- 
#     create_index_map(r_index = r_share_of_total_protein_livestock_SIbelow10mask_croplandmask, 
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Contribution of livestock to total protein production on croplands where SI < 10",
#                      index_label = "<---crops produce more           livestock produce more --->",
#                      colorpal = pal_share2,
#                      breakvals = c(0, 10, 20, 40, 60, 80, 100),
#                      breaknames = c("<10", "10-20", "20-40","40-60","60-80", ">80")))
# 
# 
# (plt_shareoflivestock_of_total_protein_SIbelow15_croplandmask <- 
#     create_index_map(r_index = r_share_of_total_protein_livestock_SIbelow15mask_croplandmask, 
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Contribution of livestock to total protein production on croplands where SI < 15",
#                      index_label = "<---crops produce more           livestock produce more --->",
#                      colorpal = pal_share2,
#                      breakvals = c(0, 10, 20, 40, 60, 80, 100),
#                      breaknames = c("<10", "10-20", "20-40","40-60","60-80", ">80")))
# 
# 
# (plt_shareoflivestock_of_total_protein_SIbelow20_croplandmask <- 
#     create_index_map(r_index = r_share_of_total_protein_livestock_SIbelow20mask_croplandmask, 
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Contribution of livestock to total protein production on croplands where SI < 20",
#                      index_label = "<---crops produce more           livestock produce more --->",
#                      colorpal = pal_share2,
#                      breakvals = c(0, 10, 20, 40, 60, 80, 100),
#                      breaknames = c("<10", "10-20", "20-40","40-60","60-80", ">80")))
# 
# 
# (plt_shareoflivestock_of_total_protein_SIbelow33_croplandmask <- 
#     create_index_map(r_index = r_share_of_total_protein_livestock_SIbelow33mask_croplandmask, 
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Contribution of livestock to total protein production on croplands where SI < 33",
#                      index_label = "<---crops produce more           livestock produce more --->",
#                      colorpal = pal_share2,
#                      breakvals = c(0, 10, 20, 40, 60, 80, 100),
#                      breaknames = c("<10", "10-20", "20-40","40-60","60-80", ">80")))
# 
# 
# 
# 
# 
# # --------------------------------------------------------- more efficient way to do this with function
# # Custom function to create masked raster
# create_masked_raster <- function(input_raster, threshold, mask_raster) {
#   temp_raster <- input_raster
#   temp_raster[temp_raster >= threshold] <- NA
#   output_raster <- mask(temp_raster, mask_raster)
#   return(output_raster)
# }
# 
# # Define thresholds
# thresholds <- c(10, 15, 20, 33)
# 
# # Use purrr::map to create a list of masked rasters
# masked_rasters <- map(thresholds, ~ create_masked_raster(SI_5arcmin, .x, r_global_production_crops_sum_mt))
# 
# # Use purrr::map to create a list of rasters with masked protein data
# r_share_of_total_protein_livestock_SIbelow_mask_croplandmask_list <- map(masked_rasters, ~ mask(r_share_of_total_protein_livestock, .x))
# 
# # Set the names of the raster lists
# names(masked_rasters) <- paste0("SI_5arcmin_below", thresholds, "_croplandmask")
# names(r_share_of_total_protein_livestock_SIbelow_mask_croplandmask_list) <- paste0("r_share_of_total_protein_livestock_SIbelow", thresholds, "mask_croplandmask")
# 
# # Combine the lists into a single named list
# output_list <- c(masked_rasters, r_share_of_total_protein_livestock_SIbelow_mask_croplandmask_list)
# 
# 
# 
# 
# # ------------ plot
# # Masked rasters for livestock protein share
# r_share_of_total_protein_livestock_SIbelow_mask_croplandmask_list <- map(masked_rasters, ~ mask(r_share_of_total_protein_livestock, .x))
# 
# # Define common parameters
# tocrs <- "ESRI:54030"
# index_label <- "<---crops produce more           livestock produce more --->"
# colorpal <- pal_share2
# breakvals <- c(0, 10, 20, 40, 60, 80, 100)
# breaknames <- c("<10", "10-20", "20-40", "40-60", "60-80", ">80")
# 
# # Create the index maps using map2
# index_maps <- map2(thresholds, r_share_of_total_protein_livestock_SIbelow_mask_croplandmask_list,
#                    ~ create_index_map(r_index = .y, 
#                                       tocrs = tocrs,
#                                       index_main_title = paste0("Contribution of livestock to total protein production on croplands where SI < ", .x),
#                                       index_label = index_label,
#                                       colorpal = colorpal,
#                                       breakvals = breakvals,
#                                       breaknames = breaknames))
# 
# # Set the names of the index_maps list
# names(index_maps) <- paste0("plt_shareoflivestock_of_total_protein_SIbelow", thresholds, "_croplandmask")
# 
# #index_maps[["plt_shareoflivestock_of_total_protein_SIbelow10_croplandmask"]]
# 
# index_maps
# 
# 
# 
# 






```

