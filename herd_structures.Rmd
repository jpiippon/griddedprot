---
title: "Herd structures"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---

! ongelma t채m채n datan kanssa: se ei ole avointa, eik채 koko tutkimusta voida siksi tehd채 uudelleen

# Data -gerd structures relying on grazing
! This doesn't represent total livestock populations!

```{r}
df_herd <- 
  read_excel(here("Data", "Input", "herrero",
                  "modified_animal_composition2000.xlsx"))

```

# Descriptive stats and plot

```{r}
# some stats
df_regional_averages <-
  df_herd %>% 
  group_by(Region) %>% 
  summarise(dairy_avg = round(mean(Dairy_cattle), 1),
            beef_avg = round(mean(Beef_cattle), 1),
            sheepgoat_avg = round(mean(Sheep_and_goats), 1))



#  stacked bar plot -- beef dominates
ggplot(df_regional_averages %>%
  pivot_longer(cols = c(beef_avg,dairy_avg, sheepgoat_avg),
               names_to = "Animal_type",
               values_to = "percentage"), 
       aes(x = Region, y = percentage, fill = Animal_type)) +
  geom_bar(stat = "identity") +
  labs(title = "Animal Distribution by Region",
       y = "Percentage",
       fill = "Animal Type") +
  theme_classic()


```


# Combine with geometries

```{r}
# to long format
df_herd_long <- df_herd %>%
  pivot_longer(cols = c(Dairy_cattle, Beef_cattle, Sheep_and_goats),
               names_to = "Animal_type",
               values_to = "share")


df_herd_long <- df_herd_long %>%
  mutate(fao_from_dfcountryname = countrycode(.$Country, origin = "country.name",  destination = "fao"))
## warns that some are missing. However, either fao_from_iso3eh or fao_from_SOVEREIGNT includes most


adm_10m_fao_id_simple_combined_with_herd_structures <-
  left_join(adm10_simple_faoadded, df_herd_long, 
             by = c("FAO_ID" = "fao_from_dfcountryname")) 




#------------------ Create HERD raster for specific Animal Category with function
f_HERD_raster <- function(animalcategory) {
  
  ## create reclassification matrix
  rcl_mat_countries_to_herd <-
  adm_10m_fao_id_simple_combined_with_herd_structures %>% 
  filter(Animal_type  == animalcategory) %>% 
  dplyr::select(FAO_ID, share) %>%
  st_drop_geometry() %>% 
  as.matrix(., ncol = 2)

  ## classify. Creates a raster that shows HERD values for different countries
  r_herd_in_f  <- cntry_raster %>%
    classify(rcl_mat_countries_to_herd, 
             others = NA)
               # df_herd_long %>% filter(Animal_type == animalcategory) %>% 
               # pull(share ) %>% mean()) # fill others with mean value
  
   # Apply the land mask
  r_herd_in_f <- r_herd_in_f * land_mask
  
  names(r_herd_in_f) <- paste0(animalcategory, "_share")

  return(r_herd_in_f)
}

f_HERD_raster("Dairy_cattle")


# get rasters for each animal categories
r_herd <- c(
  f_HERD_raster("Dairy_cattle"),
  f_HERD_raster("Beef_cattle"),
  f_HERD_raster("Sheep_and_goats")
)
names(r_herd) <- c("dairy_share", "beef_share", "sheep_and_goats_share")
sum(r_herd) # test that sums to 100%
plot(r_herd)



```
# Livestock-only grasslands -- probably can delete

Unfortunately, we cannot share data that divides grasslands to livestock-grazing grasslands. However, the documentation can be found from Robinson et al (2011) and data asked from authors. Here we use classes
LGY (Livestock only, hyper-arid),
LGA (Livestock only, arid and semi-arid),
LGH (Livestock only, humid and sub-humid) and 
LGT (Livestock only, temperate and tropical highland) 
to separate livestock-only systems from mixed (or industrial) production systems. Same as classes 1-4


```{r}
# glp <- here("Data", "Input", "herrero",
#             "ruminant_production_systems.tif") %>% 
#   rast()
# plot(glp)
# # Create a reclassification matrix for values 1-4
# rcl_mat_glp_1to4 <- matrix(c(1, 4, 1), ncol = 3, byrow = TRUE)
# 
# # Reclassify the raster using the reclassification matrix, set others to NA
# glp_modified_1to4 <- classify(glp, rcl_mat_glp_1to4, right = NA, others = NA)
# plot(glp_modified_1to4)
# 
# # Aggregate to 5 arcsec, crop and mask to the study area
# glp_5as <- aggregate(glp_modified_1to4, fact = 10, na.rm = TRUE)
# 
# 
# 
# # mask r_herd_ livestock to livestock grazing grasslands?
# r_herd_in_lg_regions <- 
#   mask(r_herd, glp_5as)
# 
# plot(r_herd_in_lg_regions)
# 
#  #  mask to our  grazing lands?
# r_herd_in_igbp6to10or16_regs <-
#   mask(r_herd, r_fraction_gl_0toNA_igbp6to10or16)
# plot(r_herd_in_igbp6to10or16_regs)
```


# Explore herd structures at regional level - not by country

```{r}
reg_wgs_rast <-
  reg_wgs %>% 
  mutate(regnumber = 1:nrow(.)) %>% 
  as(., "Spatial") %>% 
  vect() %>% 
  rasterize(., template_rast_5arcmin,  field = "regnumber")

plot(reg_wgs_rast)



df_regional_herd_shares <- 
  extract(r_herd, reg_wgs_vect, fun = "mean", na.rm = T) # reg_wgs_vect in packages script

df_regional_herd_shares <- df_regional_herd_shares %>% 
  mutate(subregion = reg_wgs_vect$Region_new,
         regnumber = 1:nrow(.))


df_regional_herd_shares <- 
  left_join(reg_wgs, df_regional_herd_shares, by = c("Region_new" = "subregion")) 
  

plot(df_regional_herd_shares)

r_regional_herd_shares_dairy <- df_regional_herd_shares %>% 
  as(., "Spatial") %>% 
  vect() %>% 
  rasterize(., template_rast_5arcmin,  field = "dairy_share")


r_regional_herd_shares_beef <- df_regional_herd_shares %>% 
  as(., "Spatial") %>% 
  vect() %>% 
  rasterize(., template_rast_5arcmin,  field = "beef_share")


r_regional_herd_shares_sheepandgoat <- df_regional_herd_shares %>% 
  as(., "Spatial") %>% 
  vect() %>% 
  rasterize(., template_rast_5arcmin,  field = "sheep_and_goats_share")


r_regional_herd_shares <- c(
  r_regional_herd_shares_dairy,
  r_regional_herd_shares_beef,
  r_regional_herd_shares_sheepandgoat
)

plot(r_regional_herd_shares)



```

# Plan how to calculate average protein originating from animals

If AGB in a cell is 800 kg and feed usages of dairy, beef and sheepandgoats are
20%, 50% and 30% respectively, FCR dairy = 200, FCR beef = 400 and FCR sheepgoat = 400,

then total produced protein is (0.2 * 800)/200 + (0.5 * 800)/400 + (0.3 * 800)/400

```{r}
r_agb_kg_perpix # allocate for different animals

r_agb_usage_dairy_kg_perpix <- r_herd$dairy_share * r_agb_kg_perpix
r_agb_usage_beef_kg_perpix <- r_herd$beef_share * r_agb_kg_perpix
r_agb_usage_sheepgoat_kg_perpix <- r_herd$sheep_and_goats_share* r_agb_kg_perpix


r_protein_from_065xAGB_kg_perpix_with_current_herd_composition <- 
  r_agb_usage_dairy_kg_perpix / r_fcr$fcr_dairy + 
  r_agb_usage_beef_kg_perpix / r_fcr$fcr_beef + 
  r_agb_usage_sheepgoat_kg_perpix / r_fcr$fcr_sheep_and_goat_meat

names(r_protein_from_065xAGB_kg_perpix_with_current_herd_composition) <-
  "prot_current_herd"
r_protein_from_065xAGB_kg_perpix_with_current_herd_composition


global(r_protein_from_065xAGB_kg_perpix_with_current_herd_composition,
       fun = "sum", na.rm = T)/1e9 # 18 mmt
```

