---
title: '"Processing data"'
author: "Johannes Piipponen"
date: "15 8 2022"
output: html_document
---


?? vaihda polygoni - ongelmia sudanissa joka tapauksessa



Packages etc loaded in separate file packages_etc_run_this_first.R

ALT + L collapse
ALT + Shift + L   expand




#  FAO data processing, crops and animals
- Select crops, calculate protein fraction and kcalPerKg for each crop and country
- Select meat species, convert meat protein to kcal 

Abbreviation fbs mean Food Balance Sheet

```{r}
# ---------------------------------------------------------- FAOSTAT download 
foodBalanceSheets_semiraw <-
  here("Data", "Input", "faostat", "foodBalanceSheets_E_All_Data_NOFLAG.csv") %>% 
  read.csv() %>% 
  dplyr::select(-Element.Code,-Unit ,-c(Y2011:Y2019)) # no need to update the data if we use only 2010?
  
# -------------------------------- is this needed?
  ## copy rows where Area == "Sudan" and use those for South Sudan (no vals anyway)
# south_sudan <- foodBalanceSheets_semiraw %>%
#   filter(Area == "Sudan") %>% # just to find rows to duplicate
#   mutate(Area.Code = 277, Area = "South Sudan")
# 
# foodBalanceSheets_semiraw <- 
#   rbind(foodBalanceSheets_semiraw, south_sudan) # still missing somalia..
# 
# 

 ## list of country names
# countryList <- here("Data", "Input", "faostat", "countryList.csv") %>% 
#   read.csv()

# # not sure if these cntry_shape and cntry_shape_meta are needed eventually
# cntry_shape <-  here("Data", "Input", "naturalearth", "adm0_NatEarth_all_ids.shp") %>%
#   read_sf()
# cntry_shape_meta <- cntry_shape %>%   st_drop_geometry()
# 
# cntry_raster2 <-
#   cntry_shape %>%
#   filter(fao_id %in% fbs_crops_wide$Area.Code) %>%
#   vect() %>%
#   rasterize(., template_rast_5arcmin, field = "fao_id") # is this needed?







# ---------------------------------------------------------- crops
my_itemlist_fao <- c(  # in mapspam webpage order
  "Wheat and products", "Rice and products","Maize and products",
  "Barley and products", "Millet and products", "Sorghum and products",
  "Cereals, Other", "Potatoes and products", "Sweet potatoes",
  "Yams", "Cassava and products", "Roots, Other",  
  "Beans", "Peas", "Pulses, Other and products",
  "Soyabeans","Groundnuts", "Coconuts - Incl Copra",
  "Bananas", "Plantains",  "Vegetables" # 21 crops -- no fruits!
)

my_elementlist_fao <- c(
  "Production","Food supply quantity (kg/capita/yr)",
  "Food supply (kcal/capita/day)", "Protein supply quantity (g/capita/day)"
  # "Fat supply quantity (g/capita/day)"  # add fat if needed
)




  

fbs_crops <- foodBalanceSheets_semiraw  %>% 
  filter(Item %in% my_itemlist_fao,
       Element %in% my_elementlist_fao)
# %>% 
#   mutate(Year = 2010) %>% #in 2010 there was no south sudan. Somalia missing too
#   rename(., Value = Y2010) %>%
# dplyr::select(Area.Code, Area, Item.Code, Item, Element, Year, Value)


 ## to wide format. Select only relevant variables
fbs_crops_wide <- fbs_crops %>% 
  pivot_wider(names_from = Element, values_from = Y2010) %>% 
  rename(prod_1000mt = "Production",
         supply.KgCapYr = "Food supply quantity (kg/capita/yr)",
         supply.KcalCapD = "Food supply (kcal/capita/day)",
         prot.gCapD = "Protein supply quantity (g/capita/day)") 

  ## add column where item names corresponds to mapsmap names
fbs_crops_wide <- fbs_crops_wide %>% 
  mutate(spamname = case_when(
    Item == "Wheat and products" ~ "whea",
    Item == "Rice and products"  ~ "rice",
    Item == "Barley and products" ~ "barl",
    Item == "Maize and products" ~ "maiz",
    Item == "Millet and products"  ~ "pmil", # not all of the millets in this
    Item == "Sorghum and products"  ~ "sorg",
    Item == "Cereals, Other"   ~ "ocer",
    Item == "Cassava and products"   ~ "cass",
    Item == "Potatoes and products" ~ "pota",
    Item == "Sweet potatoes"  ~ "swpo",
    Item == "Roots, Other"  ~ "orts",
    Item == "Beans"  ~ "bean",
    Item == "Peas"  ~ "chic", # not all peas in this
    Item == "Pulses, Other and products"  ~ "opul", # not all pulses in this
    Item == "Soyabeans"  ~ "soyb",
    Item == "Groundnuts"   ~ "grou",
    Item == "Coconuts - Incl Copra"  ~ "cnut",
    Item == "Vegetables"  ~ "vege",
    Item == "Bananas"  ~ "bana",
    Item == "Plantains"  ~ "plnt",
    Item == "Yams"  ~ "yams"
  ))




# ------------------------- Calculate fraction of protein and kcal in a product (conversion factor) 
  ## protein and kcal
fbs_crops_wide <- fbs_crops_wide %>% 
  mutate(protein_fraction = (prot.gCapD*365/1000) / supply.KgCapYr,
         kcalPerKg = (supply.KcalCapD*365)/ supply.KgCapYr)  %>% 
  mutate_all(function(x) ifelse(is.nan(x) | is.infinite(x), NA, x)) # remove cases where supply = 0 (cases that yield NA values)

# %>% 
  # mutate(protein_fraction = ifelse(protein_fraction == 0, NA, protein_fraction), # tartteeko tätä riviä tai seuraavaa?
  #        kcalPerKg =  ifelse(kcalPerKg == 0, NA, kcalPerKg))
#  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! check if Matias' kcal function is useful somewhere

 ## this is used when classifying data -- use cntry_raster instead?
# cntry_raster_compatible_with_faodata <-
#   adm_10m_fao_id_simple %>% 
#   filter(FAO_ID %in% fbs_crops_wide$Area.Code) %>% 
#   vect() %>% 
#   rasterize(., template_rast_5arcmin, field = "FAO_ID") 









# ----------------------------------------------------------------------
# ----------------------------------------------------------------------
# ---------------------------------------- FAOSTAT animal protein to kcal
fbs_animals <- foodBalanceSheets_semiraw %>% 
  filter(Item %in% c("Meat", "Bovine Meat", "Mutton & Goat Meat"),
         Element %in% my_elementlist_fao) 


 ## pivot wider
fbs_animals_wide <- fbs_animals %>% 
  pivot_wider(names_from = Element, values_from = Y2010) %>% 
  rename(prod_1000mt = "Production", # eg numbers in FIN equals Lukestat
         supply.KgCapYr = "Food supply quantity (kg/capita/yr)",
         supply.KcalCapD = "Food supply (kcal/capita/day)",
         prot.gCapD = "Protein supply quantity (g/capita/day)") %>% 
  ## how many kcal one kg of meat protein includes? Varies between species
  ## create variable protein to kcal ---------------------------------------------------- >> why needed? as it is faster than converting similarly as done for crops with kcalPerKg?
  mutate(one_kg_prot_to_kcal =  (supply.KcalCapD / prot.gCapD) * 1000) %>%
  dplyr::select(-Item.Code)



#------ ---------------------------------------- raster of prot_to_kcal ratio
  ## we must convert protein to kcal using conversion rations derived from FBS
  ## do this with function to get the output for different meat species
f_convert_animal_prot_to_kcal <- function(animalcategory) {
  
  ## select only fao id and animal cagegory (one of Meat, Bovine Meat or Mutton & Goat Meat)
  rcl_mat_countries_to_protcal <- fbs_animals_wide %>% 
    filter(Item == animalcategory) %>% 
    dplyr::select(Area.Code, one_kg_prot_to_kcal) %>% 
  ## convert to matrix (reclassification matrix needed inside classify() function)    
    as.matrix(., ncol = 2)
  
  ## classify
  r_oneKg_of_protein_to_kcal <-
    classify(cntry_raster, rcl_mat_countries_to_protcal)
  names(r_oneKg_of_protein_to_kcal) <- "one_kg_prot_to_kcal"
  return(r_oneKg_of_protein_to_kcal)
}

f_convert_animal_prot_to_kcal("Bovine Meat") %>% # needed also for other types of animals
  plot(., main = "What is the case with Sudan? Check also values for Taiwan, China, Somalia, Norway")

## possible to do with rasterize as well
# faoid_and_prot_to_kcal2 <- fbs_animals_wide %>% 
#   filter(Item == "Bovine Meat")   %>% 
#   ## combine with geometries
#   left_join(adm10_simple_faoadded, ., by = c("FAO_ID" = "Area.Code" )) %>% 
#   ## rasterize
#   st_as_sf %>% 
#   vect() %>% 
#   rasterize(., template_rast_5arcmin, field = "one_kg_prot_to_kcal",
#             background = 0)
```

# Fraction of crops and grassland area in 5arcmin cells

Below we calculate how much of the land area is covered by crops and pasturelands (our definition for pastureland described in the manuscript).

- Needed when calculating values perpixel
- Also when detecting areas where crops can grow but where grazing is also an option


```{r}
#---------------------------------- get physical areas for mapspam crops (in ha)
f_physical_area_km2 <- function(cropname_mapspam) {
  list.files(path = here("Data", "Input", "mapspam", "physical_area") ,
           pattern = paste0("_", toupper(cropname_mapspam), "_A"), 
           full.names = TRUE)  %>%  
  rast() / 100 # div by 100 to get ha --> km2
}
f_physical_area_km2("whea") 


  ## for all crops
mylist_selected_spamcrops <-  fbs_crops_wide$spamname %>% unique()
r_physical_areas_km2 <- lapply(mylist_selected_spamcrops, f_physical_area_km2) %>% 
  rast()# 21
names(r_physical_areas_km2) <- mylist_selected_spamcrops
  ## example plot
plot(r_physical_areas_km2$whea) 
r_physical_areas_km2[[c("whea", "rice"),]] %>% plot() 





  ## sum of these areas, read as "area of crop species in cell  combined"
r_physical_areas_crops_sum <- sum(r_physical_areas_km2, na.rm = T) # areas per grid cell. e.g in India lot of area covered by some crops
plot(r_physical_areas_crops_sum, main = "physical areas of 21 crops (A production, km2)")
global(r_physical_areas_crops_sum, fun = "sum", na.rm = T)/1e6 # 9 milj km2 total

  ## fraction of crops in 5arcmin cell
r_fraction_of_crops_in_cell <-
  r_physical_areas_crops_sum / cellSize(r_physical_areas_crops_sum, unit = "km")
names(r_fraction_of_crops_in_cell) <- "fraction_crops"

# plot. e.g in India a large share of land area is cultivated for crops 
plot(r_fraction_of_crops_in_cell, main = "fraction of 21 crops in 5arcmin cells") ##!! do proper plot out of this





# ------------------------------------- get areas suitable for animal production
# ---------------------------------------------- find relevant pasture area 
r_mcd_fraction <- 
  here("Data", "Input", "art2_in_E",  # includes also shrublands 
       "mcd_fraction_of_grassland_in_cell_where_pasture_2001_2020_5arcmin.tif") %>%  
  rast() 
plot(r_mcd_fraction, main = "fraction of grassland in 5arcmin cells, includes shrublands")
# Middle  Australia consider as shrubland -- not much npp there though

# plot(r_mcd_fraction + r_fraction_of_crops_in_cell) # na removed

# -------- mask r_fraction_of_crops_in_cell to pastureland areas
r_fraction_of_crops_in_cell_pasturemask <- r_fraction_of_crops_in_cell %>% 
  mask(., r_mcd_fraction, maskvalues =0 ) # IGBP class croplands is out after this


# -------------------------- mask fraction of grassland to crop production areas
 ## here only cropland areas that contain some pasture too
r_mcd_fraction_allocated_to_cropland <- 
  mask(r_mcd_fraction, r_fraction_of_crops_in_cell_pasturemask)
names(r_mcd_fraction_allocated_to_cropland) <- "fraction_pasture"
plot(r_mcd_fraction_allocated_to_cropland, main = "Fraction of pasture in crop production areas")


# convert to data frame and find pasture area to which we calculate protein production
# Now we are interested in protein production capacity in areas where both crops and animals are possible.
# Assumptions: to be able to compare protein production of crops and pastures in the same area, we assume that pasture area is less or equal than crop production area. For example, if potential pasture area in a pixel is 60% and detected cropland area 30%, we examine pasture production only in the area where crops are growing (30% of cell). Otherwise there might be more animal protein in a cell but this results just in larger area. 
df_fractions_of_crops_and_pasture <-
  c(r_fraction_of_crops_in_cell_pasturemask, r_mcd_fraction_allocated_to_cropland ) %>% 
  as.data.frame(., xy = T) %>% 
  as_tibble() %>% 
  mutate(fract_pasture_MAX_fract_crops = ifelse(
    fraction_pasture <= fraction_crops, # if pasture are is smaller than equal to crop area
    fraction_pasture, # choose pasture area (e.g 20% pasture, 40% crops --> both in 20% of cell)
    fraction_crops # otherwise choose crop production area (e.g. 50% pasture, 10% crops --> both in 10% of cell)
  ))

  ## add a column that shows how much more animal based protein could be produced in mapspam crop production areas. So, if  fraction_pasture (0.2) < fraction_crops (0.4) return 0 but e.g. if fraction_pasture = 0.6 and fraction_crops = 0.4 the "extra" protein from animals can be produced in area that equals 20% of cell. Later 0.2 * AGB * FCR
df_fractions_of_crops_and_pasture <- df_fractions_of_crops_and_pasture %>% 
  mutate(past_area_extraprot = ifelse(
    fraction_pasture >= fraction_crops, # if pasture area is larger (60%) or equal to crop area (20%),
    (fraction_pasture - fraction_crops), # choose the difference (extra protein crops cannot use: 40% of cell)
    0 # otherwise choose 0 (no extra animal protein) !! NOT COMPLETELY TRUE as these can be mutually exlusive: 20% pasture and 25% crops --> some of the pasture can still be outside crop production area. However, we cannot be sure and therefore we assume extra protein = 0 in this case
    ))



df_xy_fract_pasture_MAX_fract_crops <- 
  df_fractions_of_crops_and_pasture %>%
  dplyr::select(x, y, fract_pasture_MAX_fract_crops)

r_past_competing_with_crops_fraction <-
  rast(df_xy_fract_pasture_MAX_fract_crops, 
       type = "xyz", crs = "EPSG:4326")

  ## convert to raster
# r_past_competing_with_crops_fraction <-  
#   df_fractions_of_crops_and_pasture %>%
#   dplyr::select(x, y, fract_pasture_MAX_fract_crops) %>% 
#   rast(., type="xyz")

 ## resample to get complete ext and 0 0 origin
r_past_competing_with_crops_fraction <- 
  resample(r_past_competing_with_crops_fraction, template_rast_5arcmin) 

plot(r_past_competing_with_crops_fraction, main = "Fraction of pasturable areas in crop prod areas. Assuming pastureFrac cannot be > cropFrac")


r_pasture_fract_extraprot <-  df_fractions_of_crops_and_pasture %>%
  dplyr::select(x, y, past_area_extraprot) %>% 
  rast(., type="xyz") 

r_pasture_fract_extraprot <- 
  resample(r_pasture_fract_extraprot, template_rast_5arcmin)

plot(r_pasture_fract_extraprot, main = 
"Fraction of cell that could be used to produce pasture based protein in crop prod areas")
# writeRaster(r_past_competing_with_crops_fraction, filename = 
#               here("Data", "Intermediate_input", 
#                    "r_pasture_fract_competing_with_crops.tif"),
#             overwrite = T)
# 
# 
# writeRaster(r_pasture_fract_extraprot, filename = 
#               here("Data", "Intermediate_input", 
#                    "r_pasture_fract_extraprotein_from_cropprod_areas.tif"),
#             overwrite = T)






```


# Mapspam crop production to protein and kcal

```{r}
mylist_selected_spamcrops <- fbs_crops_wide$spamname %>%
  unique()# 21 crops: whea, rice ...


# ------------------------------------------- Get mapspam data
# list.files(path = here("Data", "Input", "mapspam", "global_prod") ,
#            pattern = paste0("P_", "WHEA", "_A"), full.names = TRUE)
# 
# list.files(path = here("Data", "Input", "mapspam", "physical_area") ,
#            pattern = paste0("A_", "WHEA", "_A"), full.names = TRUE)


  ## get the data for all 21 crops with function
f_global_prod_mt <- function(cropname_mapspam) {
  list.files(path = here("Data", "Input", "mapspam", "global_prod") ,
             pattern = paste0("P_", toupper(cropname_mapspam), "_A"),
             full.names = TRUE)  %>%
    rast()
}

f_global_prod_mt("whea") # returns raster, unit = mt

  ## 21 global production rasters in same stack
r_global_prod_mt<- lapply(mylist_selected_spamcrops, f_global_prod_mt) %>%
  rast()# 21 -- not all millets there for example
names(r_global_prod_mt) <- mylist_selected_spamcrops




#------------------------------------------------------- crop protein production
f_crop_protein_production_mt <- function(cropname_mapspam) {
  
  ## get protein fraction for spesific crop species
  faoid_and_prot_frac <-
    fbs_crops_wide %>%
    filter(spamname == cropname_mapspam) %>%
    dplyr::select(Area.Code, protein_fraction)
  
  ## reclassification matrix
  rcl_mat_countries_to_prot_frac <-
    matrix(c(faoid_and_prot_frac$Area.Code, 
             faoid_and_prot_frac$protein_fraction),
           ncol = 2)
  
  ## classify. Creates a raster with protein fraction
  r_fraction_prot  <- cntry_raster %>% 
    classify(rcl_mat_countries_to_prot_frac)
  
  ## protein production raster
  r_prot <- 
    f_global_prod_mt(cropname_mapspam) * r_fraction_prot
  names(r_prot) <- paste0(cropname_mapspam, "_prot")
  
  return(r_prot)
}

# eg wheat
f_crop_protein_production_mt("whea") %>% plot() # mean 80


################### lapply for all items -- 25 sec total
r_prot_allcrops_mt <- lapply(unique(fbs_crops_wide$spamname),
                          f_crop_protein_production_mt) %>% 
  rast() # different way to do this presented in old script that used crop and mask and merge 

 ##  sum: how much prot in cell total ! Double check that it is perpixel
r_prot_allcrops_sum_mt <- sum(r_prot_allcrops_mt, na.rm = T)

 ## resample to get complete ext and 0 0 origin
r_prot_allcrops_sum_mt <- 
  resample(r_prot_allcrops_sum_mt, template_rast_5arcmin) 

plot(r_prot_allcrops_sum_mt, 
     main = "21 crops sum of protein mt -no pastureland mask") # 3rd Qu = 314



#---------- create crop production raster which overlays with pastureland raster
# Now our MapSPAM crop raster includes also areas (e.g. US corn belt) that don't belong to pasturelands (IGBP class = 12 "Croplands: at least 60% of area is cultivated cropland.")
r_prot_allcrops_sum_mt_pasturemask <- r_prot_allcrops_sum_mt %>% 
  mask(., r_mcd_fraction, maskvalues = 0) # !!!!! this mask yields 0 for cornbelt areas


plot(r_prot_allcrops_sum_mt_pasturemask, main = 
       "21 crops sum of protein overlaying with pastures (mt)")




# ----------------------------------------------------- kcal production of crops
 ## same as above but convert production to kcal instead
f_crop_kcal_prod_MM <- function(cropname_mapspam) {

  ## get protein fraction for spesific crop species
  faoid_and_kcalPerKg <-
    fbs_crops_wide %>%
    filter(spamname == cropname_mapspam) %>%
    dplyr::select(Area.Code, kcalPerKg)

  ## reclassification matrix
  rcl_mat_countries_to_kcalPerKg <-
    matrix(c(faoid_and_kcalPerKg$Area.Code, faoid_and_kcalPerKg$kcalPerKg),
           ncol = 2)

  ## classify. Creates a raster with kcalPerKg for spesific crop
  r_kcalPerKg  <- cntry_raster %>%
    classify(rcl_mat_countries_to_kcalPerKg)

  ## protein production raster
  r_kcal <-
    # divide as production unit = mt and our desired unit = million
    (f_global_prod_mt(cropname_mapspam) / 1000) * r_kcalPerKg
  names(r_kcal) <- paste0(cropname_mapspam, "_kcal")

  return(r_kcal)
}



  ## lapply for all items
r_kcal_allcrops_MM <- lapply(unique(fbs_crops_wide$spamname),
                             f_crop_kcal_prod_MM) %>%
  rast()


  ##  sum: how much kcal (in million kcal) in cell total
r_kcal_allcrops_sum_MM <- sum(r_kcal_allcrops_MM, na.rm = T)
plot(r_kcal_allcrops_sum_MM, main = "21 crops sum of kcal MM") # google world maiz/whea/rice production -- looks similar


```







# Animal protein from pastures 

Calculate how much protein and kcal pastures (AGB) can produce. Different for different animal species

```{r}
# AGB. alueet joilla grasslandia joka vuosi 2001-2020
r_agb_kg_km2 <- 
  here("Data", "Input", "art2_in_E", 
       "agb_no_sim_neg_removed_where_past_01_20_biomass_kg_km2_5arcmin.tif") %>%  
  rast() 

r_agb_kg_km2_2010 <- r_agb_kg_km2$agb2010 
plot(r_agb_kg_km2_2010) # better plot in figures.Rmd

  ## use median instead? Will be different after simulation
r_agb_kg_km2_median_nosim <- median(r_agb_kg_km2, na.rm = T)
plot(r_agb_kg_km2_median_nosim)

  ## Middle Australia surprisingly high values? Check the input data after Gabriel simulation
# r_agb_kg_km2_2010 %>%
#   crop_and_mask(adm_10m_fao_id_simple %>% filter(ADMIN == "Australia")) %>%
#   qtm()
# kok <- r_agb_kg_km2_2010 %>%
#   crop_and_mask(adm_10m_fao_id_simple %>% filter(ADMIN == "Australia")) 
# kok[kok > 300000] <- 300000
# plot(kok)

 ## AGB per pixel without any cropland mask
r_agb_kg_perpix_median <-
  r_agb_kg_km2_median_nosim * 
  cellSize(r_agb_kg_km2_median_nosim, unit = "km") * 
  r_mcd_fraction


# -------------------  AGB in mapspam crop production areas
r_agb_kg_km2_median_allocated_to_crop_prod_areas <- 
  crop_and_mask(r_agb_kg_km2_median_nosim, 
                r_prot_allcrops_sum_mt_pasturemask) # corn belt not visible

plot(r_agb_kg_km2_median_allocated_to_crop_prod_areas,
     main = "AGB in mapspam crop production areas")


 ## amount of agb in cell in areas where crops are growing. Note that here fraction_pasture cannot be higher than fraction_crops
r_agb_kg_perpix_median_allocated_to_crop_prod_areas <-
  r_agb_kg_km2_median_allocated_to_crop_prod_areas * 
  cellSize(r_agb_kg_km2_median_allocated_to_crop_prod_areas, unit = "km") * 
  r_past_competing_with_crops_fraction

plot(r_agb_kg_perpix_median_allocated_to_crop_prod_areas, main = "AGB perpix in mapspam crop production areas")


 ## extra protein. Pasture based protein that could be produced in crop production areas. E.g fraction of pastureland in cell is 60% and crops are growing in 40% of the cell area, there is still 20% where animals can graze and produce protein (and they are not competing with crops)
r_extra_agb_kg_perpix_on_croplands <- 
  r_agb_kg_perpix_median_allocated_to_crop_prod_areas * 
  r_pasture_fract_extraprot #### change!! Nothing converted to protein so far!! No before we have even runned FCR

plot(r_extra_agb_kg_perpix_on_croplands, 
     main = "Extra AGB (perpix) that could be produced in mapspam crop production areas")




```

# FCR Food Conversion Ratios
Next we convert AGB to protein using FCR values reported in literature.


FCR calculated for following animal categories (no need for Pigs as they don't graze that much):
"Beef cattle"     "Dairy cattle"    "Pigs"            "Sheep and goats" ,


Production systems (only Grazing needed)
"Grazing"    "Industrial" "Mixed " 

```{r}
#------------------------------------------------ FCR created in livestock_fcr.R
fcr_complete <-
  read.csv(here("Data", "Input", "other", "fcr_comparison_countries.csv")) %>% 
  as_tibble() # "Area.Code" on sama kuin df_adm_10m_fao_id datan FAO_ID


  ## combine with fao geometries and select production system = Grazing, and drop Pigs 

## 
adm_10m_fao_id_simple_combined_with_fcr <-
  fcr_complete %>%
  filter(Animal.category != "Pigs",
         prod_sys_2 == "Grazing") %>%
 # left_join(adm_10m_fao_id_simple, ., by = c("FAO_ID" = "Area.Code"))
  left_join(adm10_simple_faoadded, ., 
             by = c("SOVEREIGNT" = "AreaName")) 
            #  by = c("FAO_ID" = "Area.Code")) # no South Sudan in fcr_complete




#------------------ Create FCR raster for spesific Animal.Category with function
f_FCR_raster <- function(animalcategory) {
  
  ## create reclassification matrix
  rcl_mat_countries_to_fcr <-
  adm_10m_fao_id_simple_combined_with_fcr %>% 
  filter(Animal.category == animalcategory) %>% 
  dplyr::select(FAO_ID, FCR_truncated_median) %>% 
  st_drop_geometry() %>% 
  as.matrix(., ncol = 2)


  ## classify. Creates a raster that shows FCR for different countries
  r_fcr  <- cntry_raster %>%
    classify(rcl_mat_countries_to_fcr)
  names(r_fcr) <- "FCR"

return(r_fcr)
}
  
#f_FCR_raster("Beef cattle")
plot(f_FCR_raster("Beef cattle"), 
     main = "FCR raster for Beef") # Sudan visible -- should get values 402 and 407
qtm(f_FCR_raster("Beef cattle"), title = "FCR raster for Beef cattle") 

  ##  "Dairy cattle"
qtm(f_FCR_raster("Dairy cattle"), title = "FCR raster for Dairy cattle -- check sudan") 
qtm(f_FCR_raster("Sheep and goats"), title = "FCR raster for Sheep and goats -- check sudan") 


# ----------- create average FCR raster based on mean of simulated FCRs of beef, cattle and sheepgoats
fcr_average <- (c(
  f_FCR_raster("Dairy cattle"),
  f_FCR_raster("Beef cattle"),
  f_FCR_raster("Sheep and goats")) %>% 
    mean() ) 


# --------------------------------------------------- use FCR calculated for an average animal
 ## test with this!
# fcr_average2 <-
#   read.csv(here("Data", "Input", "other", "fcr_for_an_average_animal_bycountry.csv")) %>% 
#   as_tibble()
# 
# 
# r_fcr_average2 <-
#   fcr_average %>%
#   left_join(adm10_simple_faoadded, ., by = c("FAO_ID" = "Area.Code")) %>% 
#   vect() %>% 
#   rasterize(., template_rast_5arcmin, field = "FCR_truncated_median")
# 
# qtm(r_fcr_average2)

# ----------------------------------------------- option 2: use rasterize instead of classify
# kok <- adm_10m_fao_id_simple_combined_with_fcr %>%
#   filter(Animal.category == "Beef cattle") %>%
#   vect() %>%
#   rasterize(., template_rast_5arcmin, field = "FCR_truncated_median")
# plot(kok)










  ## FCR herrero beef with webplot digitalizer ---- we'll use more harmonized dataset
# fcr_beef_herrero <- read.csv(here("Data", "Input", "webplotdigi", "herrero_beef.csv"),
#          sep = ";")  
# fcr_beef_herrero # vika arvo on maailman keskiarvo world: 240kg DM tarvitaan jotta saadaan kilo protskua
# 
# 
# # ------------------------------------------------------ region data
# reg_wgs_fcr <- reg_wgs |> 
#   mutate(fcr_beef_herr  = c(250.67, 389.33, 250.67, 218.67, 0,
#                             698.67, 389.33, 256.00, 256.00, 256.00,
#                             245.33,  424.00, 218.67))
# reg_wgs_fcr
# reg_wgs_fcr_vect <- vect(as(reg_wgs_fcr, "Spatial")) 
# 
# 
```


# Convert AGB to protein

```{r}
# define animal species we use in this analysis
mylist_animal_ctg <- c("Dairy cattle","Beef cattle", "Sheep and goats")


# create function that converts AGB to protein for different animal species 
f_convert_agb_to_animal_prot <- function(animalcategory) {
  
  r_protein_mt <-
    r_agb_kg_perpix_median /
    f_FCR_raster(animalcategory) / 
    1e3
  
  names(r_protein_mt) <- animalcategory
 #   paste0("prot_", animalcategory, "_mt")  %>%    gsub(" ", "", .)

  return(r_protein_mt)
}

#f_convert_agb_to_animal_prot("Beef cattle")

r_animalprot_fromAGB_mt <- 
  lapply(mylist_animal_ctg, f_convert_agb_to_animal_prot) %>% 
  rast()

  ## add prot prod layer calculated using average FCRs
r_animalprot_fromAGB_mt_average <-  
  r_agb_kg_perpix_median /
  fcr_average /
  1e3
names(r_animalprot_fromAGB_mt_average) <- "On_average"

add(r_animalprot_fromAGB_mt) <- r_animalprot_fromAGB_mt_average

plot(r_animalprot_fromAGB_mt) 




# -------------------------------------------------
# create function that converts AGB to protein similarly but in crop production areas
f_convert_agb_to_animal_prot_croplandmask <- function(animalcategory) {
  
  r_animal_protein_mt_in_crop_prod_areas <-
  r_agb_kg_perpix_median_allocated_to_crop_prod_areas / 
    f_FCR_raster(animalcategory) /
    1e3
  
   ## remove 0 values to prevent div 0 errors later
  r_animal_protein_mt_in_crop_prod_areas[r_animal_protein_mt_in_crop_prod_areas < 0.01] <- 0.01
  
  names(r_animal_protein_mt_in_crop_prod_areas) <- animalcategory
  #   paste0("prot_", animalcategory, "_mt")  %>%  
  # gsub(" ", "", .)
  
  return(r_animal_protein_mt_in_crop_prod_areas)
}


r_animalprot_fromAGB_mt_mapspam_areas <- 
    lapply(mylist_animal_ctg, f_convert_agb_to_animal_prot_croplandmask) %>% 
  rast()





  ## add prot prod layer calculated using average FCRs
r_animalprot_fromAGB_mt_mapspam_areas_average <-  
  r_agb_kg_perpix_median_allocated_to_crop_prod_areas /
  fcr_average / 1e3
r_animalprot_fromAGB_mt_mapspam_areas_average[r_animalprot_fromAGB_mt_mapspam_areas_average < 0.01] <- 0.01
names(r_animalprot_fromAGB_mt_mapspam_areas_average) <- "On_average"

add(r_animalprot_fromAGB_mt_mapspam_areas) <- 
  r_animalprot_fromAGB_mt_mapspam_areas_average


plot(r_animalprot_fromAGB_mt_mapspam_areas) 




# -------------------------------------------- create global beef protein raster
# r_beef_protein_mt <-
#   r_agb_kg_perpix_median /
#   f_FCR_raster("Beef cattle") / 1e3 # was #  r_agb_kg_perpix_2010 / r_fcr_beef / 1e3
# names(r_beef_protein_mt) <- "prot_beef"
# # r_beef_protein_mt[r_beef_protein_mt > 200] <- 200 # this makes plot nicer
# plot(r_beef_protein_mt, title = "Beef protein from AGB -- austr low FCR --> lot of protein")


# r_beef_protein_mt_allocated_to_crop_prod_areas <-
#   r_agb_kg_perpix_median_allocated_to_crop_prod_areas / f_FCR_raster("Beef cattle") /1e3
#  ## remove 0 values to prevent div 0 errors later
# r_beef_protein_mt_allocated_to_crop_prod_areas[r_beef_protein_mt_allocated_to_crop_prod_areas < 0.1] <- 0.1
# names(r_beef_protein_mt_allocated_to_crop_prod_areas) <- "prot_beef"




# ------------------- extra beef protein that could  be produced in mapspam area
# r_extra_beef_protein_mt <-
#   r_agb_kg_perpix_extraprotein/f_FCR_raster("Beef cattle")/1e3
# names(r_extra_beef_protein_mt) <- "prot_beef"
# 
# 
# 
# plot(r_beef_protein_mt, main = "Beef protein metric tons") # Can it be that much in Australia?
# plot(r_beef_protein_mt_allocated_to_crop_prod_areas, 
#      main = "Beef protein in crop production areas") # much less in these areas
# plot(r_extra_beef_protein_mt, main = "Extra beef protein in crop prod areas -- pasture protein not competing with crops") # small values


#--------------------------extra animal protein that could  be produced in mapspam area
# Title could be also "capacity to produce animal protein in current crop prod areas" 
# f_extra_prot <- function(animalcategory) {
#   
#   r_extra_protein_mt <-
#   r_agb_kg_perpix_extraprotein / 
#     f_FCR_raster(animalcategory)/ 
#     1e3
#   
#   names(r_extra_protein_mt) <- 
#     paste0("exprot_", animalcategory, "_mt")  %>%  
#   gsub(" ", "", .)
#   
#   return(r_extra_protein_mt)
# }
# 
# 
# r_extra_protein_mt_mapspam_areas <- 
#   lapply(mylist_animal_ctg, f_extra_prot) %>% 
#   rast()
# plot(r_extra_protein_mt_mapspam_areas) # --- only average needed


r_extra_protein_mt_mapspam_areas_average <-
  r_extra_agb_kg_perpix_on_croplands /
  fcr_average / 
  1e3
plot(r_extra_protein_mt_mapspam_areas_average)


# pastureland areas outside MapSPAM crop prod areas
r_animalprotein_from_AGB_mt_outside_mapspam_areas <- 
  mask(r_animalprot_fromAGB_mt_average,
       r_prot_allcrops_sum_mt_pasturemask,
      inverse = T) 

qtm(r_animalprotein_from_AGB_mt_outside_mapspam_areas)

# -------------------------------------------- beef protein to kcal
  ## do later, code in animals_prot_ANDkcal..
```
# Convert animal protein to kcal

```{r}

r_animalprot_fromAGB_mt_mapspam_areas # for dairy, beef and sheep and goats in metric tons

 ## Beef
r_beef_Mkcal <- 
  r_animalprot_fromAGB_mt_mapspam_areas$`Beef cattle` * 1000 * # kg of protein
  f_convert_animal_prot_to_kcal("Bovine Meat") / 1e6
plot(r_beef_Mkcal, main = "Amount of energy beef cattle can produce (millions of kcal, range 0-200)",
     range = c(0,200))


  ## kcal from AGB on pasturelands
r_animal_kcal_from_AGB_MM <-
  c(
    r_animalprot_fromAGB_mt$`Dairy cattle` * 
    f_convert_animal_prot_to_kcal("Bovine Meat") /1e3,     
    
    r_animalprot_fromAGB_mt$`Beef cattle` * 
    f_convert_animal_prot_to_kcal("Bovine Meat") /1e3, 
    
    r_animalprot_fromAGB_mt$`Sheep and goats` * 
    f_convert_animal_prot_to_kcal("Mutton & Goat Meat") /1e3,
    
    r_animalprot_fromAGB_mt$`On_average` * 
    f_convert_animal_prot_to_kcal("Meat") /1e3
  )
names(r_animal_kcal_from_AGB_MM) <-
  c("DairycatlOnPasture", "BeefcatlOnPasture", "SheepgoatOnPasture", "Meat_avg_Pasture")


  ## kcal from AGB on croplands
r_animal_kcal_from_AGB_on_croplands_MM <-
  c(
    r_animalprot_fromAGB_mt_mapspam_areas$`Dairy cattle` * 
    f_convert_animal_prot_to_kcal("Bovine Meat") /1e3, ## MapSPAM area
    
    r_animalprot_fromAGB_mt_mapspam_areas$`Beef cattle` * 
    f_convert_animal_prot_to_kcal("Bovine Meat") /1e3,
  
    r_animalprot_fromAGB_mt_mapspam_areas$`Sheep and goats` * 
    f_convert_animal_prot_to_kcal("Mutton & Goat Meat") /1e3,
    
    r_animalprot_fromAGB_mt_mapspam_areas$`On_average` * 
    f_convert_animal_prot_to_kcal("Meat") /1e3
  )
names(r_animal_kcal_from_AGB_on_croplands_MM) <- 
  c("DairycatlOnCropland", "BeefcatlOnCropland", "SheepgoatOnCropland", "Meat_avg_Cropland")

r_prod_from_AGB_Mkcal_on_croplands %>% plot(., range = c(0,200))

```


# Global sums 


```{r}
  ## Crop based protein from pasturelands
global(r_prot_allcrops_sum_mt_pasturemask, fun = "sum", na.rm = T)/1e6 # 1976 mmt
  ## Animal based protein from pasturelands. This is per pixel
global(r_animalprot_fromAGB_mt_average, fun = "sum", na.rm = T)/1e6 # 44 mmt, average refers to average fcr
  ## Animal based protein from pasturelands that overlay with croplands
  ## it seems that animals thrive when they can graze large areas, where no one else can go 
global(r_animalprot_fromAGB_mt_mapspam_areas_average, fun = "sum", na.rm = T)/1e6  # 3.5 mmt
  ## Extra protein animals could produce on cropland areas
global(r_extra_protein_mt_mapspam_areas_average, fun = "sum", na.rm = T)/1e6  # 1.4 mmt
  ## Animal based protein outside crop production areas
global(r_animalprotein_from_AGB_mt_outside_mapspam_areas, 
         fun = "sum", na.rm = T)/1e6 # 18 mmt



# Kcal
  ## Crop based energy from pasturelands (overlyy of MapSPAM crop areas and pasturelands)
global(r_kcal_allcrops_sum_MM*1e6, fun = "sum", na.rm = T)/1e12 # 8253 * 10^12 kcal from crops from pasturelands
  ## Animal based energy on pasturelands
global(r_animal_kcal_from_AGB_MM$Meat_avg_Pasture*1e6, fun = "sum", na.rm = T)/1e12 # 569 * 10^12 kcal on pasture
  ## Animal based energy on MapSPAM crop prduction areas
global(r_animal_kcal_from_AGB_on_croplands_MM$Meat_avg_Cropland*1e6, fun = "sum", na.rm = T)/1e12 # 48 * 10^12 kcal on croplands





# global area covered by pasturelands that are located outside mapspam areas
r_animalprotein_from_AGB_mt_outside_mapspam_areas_Area <-
  cellSize(r_animalprotein_from_AGB_mt_outside_mapspam_areas, unit = "km") *
  r_mcd_fraction 


global(r_animalprotein_from_AGB_mt_outside_mapspam_areas_Area,
       fun = "sum", na.rm = T) / # 36.12 million km2
(148940000 - 14200000) # 27%
```


