---
title: "Energy from crops"
author: "JP"
date: "`r Sys.Date()`"
output: html_document
---

SPAM crop yields converted to protein in script 6_protein_from_crops.Rmd

Run that first and then this one where we convert crop protein yields to kcal
! Note that we convert PROTEIN yield (not reported SPAM yields) to kcal for consistency because we did so also for ASF

```{r}


# First, change names in crop protein production raster
r_prot_allcrops_mt_perpix # WHEA_prot, RICE_prot
r_prot_allcrops_mt_perpix_namechange <- r_prot_allcrops_mt_perpix
# new_names <- sub("_prot$", "", names(r_prot_allcrops_mt_perpix_namechange)) # maybe would be easier to just use mylist_spamnames
names(r_prot_allcrops_mt_perpix_namechange) <- mylist_spamnames


f_crop_kcal_prod_MM_perpix <- function(cropname_mapspam) {

  ## get protein fraction for spesific crop species
  faoid_and_kcalPerKg <-
    fbs_crops_wide_filled %>%
    filter(spamname == cropname_mapspam) %>%
    dplyr::select(Area.Code, 
                  one_kg_prot_to_kcal) # this in amount of kcal within 1kg or protein

  ## reclassification matrix
  rcl_mat_countries_to_one_kg_prot_to_kcal <-
    matrix(c(faoid_and_kcalPerKg$Area.Code, 
             faoid_and_kcalPerKg$one_kg_prot_to_kcal),
           ncol = 2)

  ## classify. Creates a raster with one_kg_prot_to_kcal for spesific crop
  
      # first define values for others
  fbs_avg_one_kg_prot_to_kcal_of_a_crop <-
  fbs_crops_wide_filled %>%
  filter(spamname == cropname_mapspam, Area == "World") %>%
  pull(one_kg_prot_to_kcal)
  
  
  r_one_kg_prot_to_kcal  <- 
    cntry_raster %>%
    classify(rcl_mat_countries_to_one_kg_prot_to_kcal, 
             others = fbs_avg_one_kg_prot_to_kcal_of_a_crop)

  
    # protein production raster
  r_production_crop_protein_mt_perpix <-
    subset(r_prot_allcrops_mt_perpix_namechange, # Protein production raster names originally WHEA_prot etc
           cropname_mapspam) 
  
  
  ## kcal production raster
  
  r_kcal_MM_perpix <-
    # divide as production unit = mt and our desired unit = million
    (r_production_crop_protein_mt_perpix * 1000)/1e6 * r_one_kg_prot_to_kcal
  
  names(r_kcal_MM_perpix) <- paste0(cropname_mapspam, "_MMkcal")

  return(r_kcal_MM_perpix)
}

# test
f_crop_kcal_prod_MM_perpix("WHEA") |> plot()


# lapply for all crops
r_kcal_allcrops_MM_perpix <- 
  lapply(mylist_spamnames,
         f_crop_kcal_prod_MM_perpix) %>%
  rast()


r_kcal_allcrops_sum_MM_perpix <- sum(r_kcal_allcrops_MM_perpix, na.rm = T)

names(r_kcal_allcrops_sum_MM_perpix) <- "MM_kcal_perpix"

# Save
writeRaster(r_kcal_allcrops_sum_MM_perpix,
            here("Data", "Intermediate_input",
                 "kcal_production_of27crops_sum_MMkcal_perpix.tif"),
            overwrite =T)

# Get the file
r_kcal_allcrops_sum_MM_perpix <-
  here("Data", "Intermediate_input",
       "kcal_production_of27crops_sum_MMkcal_perpix.tif") |>
  rast()
```


# Global sums

```{r}
  ## total energy production
global(r_kcal_allcrops_sum_MM_perpix*1e6, fun = "sum", na.rm = T)/1e12 # 10466 trillion kcal


# broder context:
  # energy need adar based on FAO 2358 kcal/capita/d (https://www.fao.org/faostat/en/#data/FS)
# "Average dietary energy requirement (kcal/cap/day"
global(r_kcal_allcrops_sum_MM_perpix*1e6, fun = "sum", na.rm = T) /
  (2358*365)/1e9 # 12 billion people could be fed this energy intake


```


# convert to per ha

```{r}
# crop energy production per ha
r_kcal_allcrops_sum_MM_ha <-
  r_kcal_allcrops_sum_MM_perpix /
  (cellSize(r_kcal_allcrops_sum_MM_perpix, unit = "ha") *
     r_fraction_cl_0toNA)

names(r_kcal_allcrops_sum_MM_ha) <- "crop_kcal_MM_ha"

writeRaster(r_kcal_allcrops_sum_MM_ha,
            here("Data", "Intermediate_input",
                 "kcal_production_of27crops_sum_MMkcal_ha.tif"),
            overwrite =T)

# Get the file
r_kcal_allcrops_sum_MM_ha <-
  here("Data", "Intermediate_input",
       "kcal_production_of27crops_sum_MMkcal_ha.tif") |>
  rast()

```










# Convert SPAM reported production to kcal
Similar magnitude but decided to convert protein yields to kcal instead for consistency

```{r}
# # How kcalPerKg varies between countries
# fbs_crops_wide_filled %>%
#   filter(spamname == "SOYB") %>%
#   pull(one_kg_prot_to_kcal) |> 
#   hist(breaks = 20) # much more variation compared to "Meat", around 10000 or 12000
# 
# # fbs_crops_wide_filled %>%
# #   filter(spamname == "SOYB") %>%
# #   pull(kcalPerKg) |> 
# #   hist(breaks = 20) # much more variation compared to "Meat", around 4000
# 
# #------------------------------------------------------- crop energy production
# # multiply production raster by kcalPerKg values (those now by country)
# f_crop_kcal_prod_MM_perpix <- function(cropname_mapspam) {
# 
#   ## get protein fraction for spesific crop species
#   faoid_and_kcalPerKg <-
#     fbs_crops_wide_filled %>%
#     filter(spamname == cropname_mapspam) %>%
#     dplyr::select(Area.Code, 
#                   kcalPerKg) # this in kg of crop yield (not within crop protein)
# 
#   ## reclassification matrix
#   rcl_mat_countries_to_kcalPerKg <-
#     matrix(c(faoid_and_kcalPerKg$Area.Code, 
#              faoid_and_kcalPerKg$kcalPerKg),
#            ncol = 2)
# 
#   ## classify. Creates a raster with kcalPerKg for spesific crop
#   
#       # first define values for others
#   fbs_avg_kcalperKg_of_a_crop <-
#   fbs_crops_wide_filled %>%
#   filter(spamname == cropname_mapspam, Area == "World") %>%
#   pull(kcalPerKg)
#   
#   
#   r_kcalPerKg  <- 
#     cntry_raster %>%
#     classify(rcl_mat_countries_to_kcalPerKg, 
#              others = fbs_avg_kcalperKg_of_a_crop)
# 
#   
#     # production raster
#   r_production_crop <-
#     subset(r_global_prod_crops_mt, cropname_mapspam) 
#   
#   
#   ## kcal production raster --- check
#   r_kcal_MM_perpix <-
#     # divide as production unit = mt and our desired unit = million
#     (r_production_crop * 1000)/1e6 * r_kcalPerKg
#   
#   names(r_kcal_MM_perpix) <- paste0(cropname_mapspam, "_MMkcal")
# 
#   return(r_kcal_MM_perpix)
# }
# 
# 
# 
# 
# # lapply for all crops
# r_kcal_allcrops_MM_perpix <- 
#   lapply(mylist_spamnames,
#          f_crop_kcal_prod_MM_perpix) %>%
#   rast()
# 
# 
#   ##  sum: how many kcal (in million kcal) in cell total
# r_kcal_allcrops_sum_MM_perpix <- sum(r_kcal_allcrops_MM_perpix, na.rm = T)
# 
# plot(r_kcal_allcrops_sum_MM_perpix, range = c(0, 15000),
#      main = "27 crops sum of kcal MM") 





```




