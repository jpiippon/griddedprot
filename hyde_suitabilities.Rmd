---
title: "Suitabilities"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---


# 


```{r}
r_fraction_gl_NAto0 <- classify(r_fraction_gl, cbind(NA,0))
r_fraction_cl_NAto0 <- classify(r_fraction_cl, cbind(NA,0))


r_fraction_gl_cl_total <- r_fraction_gl_NAto0 + r_fraction_cl_NAto0
r_fraction_gl_cl_total_0toNA <- classify(r_fraction_gl_cl_total, cbind(0,NA))
plot(r_fraction_gl_cl_total) # tässä on kaikki mahdolliset alueet
plot(r_fraction_gl_cl_total_0toNA) # tässä on kaikki mahdolliset alueet
  ## production data
# r_global_prod_crops_mt <- 
#   here("Data", "Intermediate_input","production_raster_of_21_spamcrops.tif") %>%
#   rast() # WHEA RICE
# 
# r_global_prod_crops_sum_mt <- sum(r_global_prod_crops_mt, na.rm = T)


  ## SI data


  ## mask crop production data to areas where SI < 10
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1) 
```


# Explore suitability indices in MapSPAM crop production areas

To preven the expansion of ag land We must assume that 
r_fraction_SIover75 < r_fraction_gl + r_fraction_cl

```{r}
## SI
r_fraction_SIover75 <- 
  here("Data", "Input", "from_harddrive",
       "SI_over75_fraction_5arcmin.tif") %>% 
  rast()
plot(r_fraction_SIover75, main = "frac of land where SI > 75") # near corn belt SI very suitable almost everywhere


# maximum "very suitable" land area
r_fraction_SIover75_max <- ifel(r_fraction_SIover75 > r_fraction_gl_cl_total_0toNA,
                                r_fraction_gl_cl_total_0toNA, 
                                r_fraction_SIover75)


r_fraction_SIover75_max_0toNA <- classify(r_fraction_SIover75_max, cbind(0,NA))

(plt_r_share_SIover75max <- 
    create_index_map(r_index = r_fraction_SIover75_max_0toNA*100, # updated so 0 areas are white
                     tocrs = "ESRI:54030",
                     index_main_title = "Share of very suitable land area that could be used for crop production",
                     index_label = "% of cell",
                     colorpal = pal_share_nuuk,
                     breakvals = c(0, 10, 20, 40, 60, 80, 100),
                     breaknames = c("<10", "10-20", "20-40", "40-60","60-80", "80-100")))






# in hectares this potential "very suitable" cropland area could be
r_potential_cl_max_ha_perpix <- 
  r_fraction_SIover75_max *
  cellSize(r_fraction_SIover75_max, unit = "ha") 
global(r_potential_cl_max_ha_perpix, fun = "sum", na.rm = T)/1e6 #  585 m ha, whereas present cropland area is r_physical_areas_crops_sum_ha_perpix is 900 m ha
# Some of this area is already used in crop production!


  ## convert NA to 0 to make upcoming calculations easier
r_potential_cl_max_ha_perpix_NAto0 <- classify(r_potential_cl_max_ha_perpix, cbind(NA,0))
r_physical_areas_crops_sum_ha_perpix_NAto0 <- classify(r_physical_areas_crops_sum_ha_perpix, cbind(NA,0))

# Calculate how much more cropland there could be in cells (croplands already use a lot of very suitable  land)
# Thus cropland area could be expanded by this many hectares at most
r_potential_expansion_of_cl_ha_perpix <-
  r_potential_cl_max_ha_perpix_NAto0 - r_physical_areas_crops_sum_ha_perpix_NAto0 # positive = more cropland could exist in cell
r_potential_expansion_of_cl_ha_perpix_positive <- r_potential_expansion_of_cl_ha_perpix
r_potential_expansion_of_cl_ha_perpix_positive[r_potential_expansion_of_cl_ha_perpix_positive < 0] <- NA

global(r_potential_expansion_of_cl_ha_perpix_positive, fun = "sum", na.rm = T)/1e6 # 319 million hectares (total expansion potential) ---> trim!




# Cropland expansion on cell where SPAM crops are not growing
r_potential_cl_max_ha_perpix_outside_croplands <-
  mask(r_potential_cl_max_ha_perpix, r_physical_areas_crops_sum_ha_perpix, inverse = T)

global(r_potential_cl_max_ha_perpix_outside_croplands, fun = "sum", na.rm = T)/1e6 # 96 million hectares outside crop production areas




# Cropland expansion on cell where there is cropland
r_potential_cl_max_ha_perpix_croplandmask <-
  mask(r_potential_expansion_of_cl_ha_perpix_positive, r_physical_areas_crops_sum_ha_perpix)

global(r_potential_cl_max_ha_perpix_croplandmask, fun = "sum", na.rm = T)/1e6 # 222 m ha = 319-105




# 
# plot(r_fraction_of_crops_in_cell_maskedtoSIover75, main = "MapSPAM areas where SI > 75 ")
# plot(r_fraction_SIover75, main = "SI over 75 fraction")
# plot(r_fraction_cl, main = "fraction of MapSPAM crops in cell in 2010")

```

# explore what is protein production potential on these regions

Kuinka paljon enemmän voitaisiin tuottaa, jos solusta käytettäisiin suurempi osa viljantuotantoon kuin nyt?
Oletetaan, että cropland + grazing land = vakio
Jos lisää viljoja, se tarkoittaa vähemmän laitumia?

Esimerkki. Jos nykyinen vehnäsato on 4000 kg/ha, solun koko 81km2 ja siitä 30% on käytetty. Tällöin vehnää solussa 4000 * 100 * 81 * 0.30 = 9.72e6 kg
Jos voitaisiin viljellä 45% solusta, vehnää olisi 4000 * 100 * 81 * 0.45 = 14.58e6 eli 1.5 kertainen määrä
Huomaa että 45% / 30% = 1.5

 Sama protskulla. Jos proteiinisato 400 kg/ha, uusi sato olisi 1.46 M kg proteiinia solussa. 
 
 Kannattaa antaa prosenttiluku: kuinka monta prosenttia enemmän voitaisiin tuottaa



```{r}
#Mask fraction of crops to areas where land is very suitable for crop prod ---- mask because SI>75 lands exist also outside cl areas
# r_fraction_cl_maskedtoSIover75 <-
#   mask(r_fraction_cl, # create also raster that show production of all crops masked to very suitable areas
#        r_fraction_SIover75_max,
#        maskvalues = 0)
# 
# 
# r_fraction_SIover75_max_croplandmask <- 
#   mask(r_fraction_SIover75_max,
#        r_fraction_cl)

######################### etsi fraction jossa voitais tuottaa lisää -
r_fraction_SIover75_max_NAto0 <- classify(r_fraction_SIover75_max, cbind(NA,0))


r_SI75_minus_spamfrac_positiv_nomask <- # potential to produce more crops --> this is fraction!
  r_fraction_SIover75_max_NAto0 -
  r_fraction_cl_NAto0 

r_SI75_minus_spamfrac_positiv_nomask[r_SI75_minus_spamfrac_positiv_nomask<=0]<- NA
plot(r_SI75_minus_spamfrac_positiv_nomask)

global(r_SI75_minus_spamfrac_positiv_nomask *
         cellSize(r_SI75_minus_spamfrac_positiv_nomask, unit = "ha"),
         fun = "sum", na.rm = T)/1e6 # 319 m ha -- just a check: potential area increase correct



  ## ratio --
r_potential_share_larger_nomask <-  r_SI75_minus_spamfrac_positiv_nomask / # same as    r_fraction_SIover75_max_NAto0 - r_fraction_cl_NAto0 
  r_fraction_cl_NAto0 # NAto0 or basic cl frac?
# trimmed_value <-quantile(values(r_potential_share_larger_nomask), 0.95, na.rm = T)
# r_potential_share_larger_nomask[r_potential_share_larger_nomask>trimmed_value] <- trimmed_value 

 # !!!! same plot done bit differently below --- selvitä miksi erilainen
# (plt_r_potential_share_larger_percent_nomask<- 
#     create_index_map(r_index = 100 * r_potential_share_larger_nomask,
#                      tocrs = "ESRI:54030",
#                      index_main_title = "How much cropland area could increase at the cost of grazing lands",
#                      index_label = "[%]",
#                      colorpal = pal_share_nuuk,
#                      breakvals = c(0, 10, 20, 60, 80, 100, Inf),
#                      breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")))


# global increase


r_prod_potentially_larger <- r_global_production_crops_sum_mt * r_potential_share_larger_nomask 
#plot(r_prod_potentially_larger, main = "production could be this much more mt per pix")
global(r_prod_potentially_larger, fun = "sum", na.rm = T)/1e6 # 1182 mmt -- without trim 1190


 ## kuinka paljon enemmän kasviprotskua voitaisiin tuottaa
r_protein_prod_potentially_larger <- r_prot_allcrops_sum_mt_perpix * r_potential_share_larger_nomask 
#plot(r_protein_prod_potentially_larger, main = "crop protein production could be this much more per pix -- give in %")
global(r_protein_prod_potentially_larger, fun = "sum", na.rm = T)/1e6 # 91 -- Inf without trim








# ----- suhdeluku: kuinka paljon suuremmalta % alalta voitaisiin tuottaa kasveja?
# r_fraction_ratio_of_highSIareas_to_cl_fraction <- 
#   r_fraction_SIover75_max_croplandmask / r_fraction_of_crops_in_cell_maskedtoSIover75 



#-------------------------------------- plottaa tmapilla

# (plt_r_SI75_minus_spamfrac_positiv_ha <-
#       create_index_map(r_index = r_SI75_minus_spamfrac_positiv_ha, #
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Very suitable areas where we could produce more crops",
#                      index_label = "[ha]",
#                      colorpal = pal_agb,
#                      breakvals = c(0,1000,2000,4000, 6000, Inf),
#                      breaknames = c("0-1000","1000-2000", "2000-4000",
#                                   "4000-6000",">6000ha")))


# (plt_r_protein_prod_potentially_larger <-
#       create_index_map(r_index = r_protein_prod_potentially_larger,
#                      tocrs = "ESRI:54030",
#                      index_main_title = "crop protein production could be this much more per pix",
#                      index_label = "[tons PER PIXELl]",
#                      colorpal = pal_protein,
#                      breakvals = c(0,10,50,100, 500,1000, Inf),
#                      breaknames = c("0-10","10-50", "50-100",
#                                   "100-500","500-1000",  ">1000"))) 






```

# grazing & SI0ver75 kilpailu

Jos korkean soveltuvuuden alueet varataan viljanviljelyyn, tämä alue on pois jostain muualta. Ovatko nämä alueet laidunmailla? Kuinka paljon vähemmän proteiinia tuotetaan laidunmailta, jos korkean soveltuvuuden alueiden koko potentiaali käytetään?

Oletus: fraction_over75  =< fraction_grazingland + fraction_cropland. Eli ei laajenneta agr land areaa, mutta jos vilja-alaa halutaan lisätä, se voidaan tehdä nimenomaan gl kustannuksella


```{r}

# Etsi ne grazing land alueet joilla SI>75. Eli maskaa gl alueille joilla SI>75 
r_fraction_gl_masked_to_SIover75_areas <-
  mask(r_fraction_gl, r_fraction_SIover75_max_0toNA) # ei onnistu maskvalue = 0
plot(r_fraction_gl_masked_to_SIover75_areas, 
     main = "fraction of grazing land in regions where SI>75")


#---------------------------- explore Madagascar
# par(mfrow = c(2, 2))
# crop_and_mask(r_fraction_gl, (adm10_simple_faoadded %>% filter(NAME == "Madagascar"))) %>%
#   plot(main = "grazing land frac") # on selvästi olemassa laitumia, joilla SI>75 --> muunna ne kasvinviljelyalueiksi?
# 
# crop_and_mask(r_fraction_SIover75, (adm10_simple_faoadded %>% filter(NAME == "Madagascar"))) %>%
#   plot(main = "SI over 75 frac")
# 
# 
# 
# crop_and_mask(r_fraction_gl_masked_to_SIover75_areas, (adm10_simple_faoadded %>% filter(NAME == "Madagascar"))) %>%
#   plot(main = "fraction of grazing land where SI over 75")
######################################################


# Kuinka paljon gl alueet pienenevät jos SI+75 alueet valjastetaan viljanviljelyy
plot(r_fraction_cl)
r_fraction_cl_NAto0 %>% plot()

fraction_gl_declines <-  # this fraction must be in gl areas (cannot reduce gl if there is none)
  r_fraction_SIover75_max - # very suitable areas also outside gl or cl areas (if they are any)
  r_fraction_cl_NAto0
  ## Nykyisestä laitumesta vähennetään se osuus, jonka kasvintuotantoala voisi kasvaa. Se voisi kasvaa nykyisestä r_fraction_SIover75_max saakka, eli r_fraction_SIover75_max - r_fraction_of_crops_in_cell verran
  ## jos negatiivinen, nii tällä hetkellä solussa enemmän tuotantoa kuin mitä SI perusteella pitäis --> laitetaan nollaksi
  ## toisaalta neg arvo kertoo missä gl osuus voisi kasvaa! --> nämä parempi löytää etsimällä alueet, joilla SI pieni
fraction_gl_declines[fraction_gl_declines < 0] <- 0



fraction_gl_declines_masked_to_gl <- mask(fraction_gl_declines, r_fraction_gl, maskvalues = 0)
plot(fraction_gl_declines_masked_to_gl, main = "fraction of cell that will be taken away from grazing") # mask to grazing lands 
  ## this should be expressed as percents: how much less grazing based protein should be produced
r_how_many_percent_gl_should_decline <- 100*fraction_gl_declines_masked_to_gl / r_fraction_gl
r_how_many_percent_gl_should_decline_0toNA <- classify(r_how_many_percent_gl_should_decline, cbind(0,NA))

plot(r_how_many_percent_gl_should_decline_0toNA, 
     main = "how many % of current grazinl land area should be taken away from grazing -- diff than how many % cl should +")


  ## tarkista meneekö oikein esim corn beltillä
# par(mfrow = c(2, 2))
# crop(r_fraction_SIover75_max, ext(-100, -75, 25,52)) %>% plot(., main = "fraction of SIover75max")
# crop(r_fraction_cl, ext(-100, -75, 25,52)) %>% plot(., main = "fraction of croplands")
# crop(r_fraction_gl, ext(-100, -75, 25,52)) %>% plot(., main = "fraction of grazing lands")
# crop(fraction_gl_declines_masked_to_gl, ext(-100, -75, 25,52)) %>% plot(., main = "fraction - how much grazing lands should decline --> all gl")




# ----------------------------------- tästä parempi plotti tmap avulla -- hyde_figuresiin siirrä
# (plt_fraction_of_cell_gl_should_decline <- 
#     create_index_map(r_index = fraction_gl_declines_masked_to_gl, 
#                      tocrs = "ESRI:54030",
#                      index_main_title = "Fraction of cell area in which cropland area could grow (and grazing land area decline)",
#                      index_label = "[0,1]",
#                      colorpal = pal_share_nuuk,
#                      breakvals = c(0, 0.10, 0.20, 0.40, 0.60, 0.80, 1),
#                      breaknames = c("<0.1", "0.1-0.2", "0.2-0.4","0.4-0.6","0.6-0.8", ">0.8")))


(plt_percent_gl_should_decline <- 
    create_index_map(r_index = r_how_many_percent_gl_should_decline_0toNA, 
                     tocrs = "ESRI:54030",
                     index_main_title = "How much grazing lands area should decline (to make space for crops)",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(0, 10, 20, 60, 80, 100, Inf),
                     breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")))




#--------------------------------------------------------------- sama kasveille
fraction_cl_increases <- fraction_gl_declines # same as   r_fraction_SIover75_max - r_fraction_cl_NAto0
#fraction_cl_increases_masked_to_cl <- mask(fraction_cl_increases, r_fraction_cl) # this is probably not needed!


# Kuinka monta % enemmän viljaa voitaisiin tuottaa ---------- laskettu yllä ---- miksi maskattu vain cl alueille? Voi kai laajentua niiden ulkopuolelle
# cl area can increase in areas outside current cl areas, hoiwever, we don't know what would be the crop yield there
  ## therefore concentrate only on current cl areas for now ---- !! use average crops yields outside those areas
r_how_many_percent_cl_should_increase <- 
  100*(fraction_cl_increases) / r_fraction_cl_NAto0

r_how_many_percent_cl_should_increase <- classify(r_how_many_percent_cl_should_increase, cbind(0,NA))
# this is bit different than above
(plt_percent_cl_should_increase <- 
    create_index_map(r_index = r_how_many_percent_cl_should_increase, 
                     tocrs = "ESRI:54030",
                     index_main_title = "How much cropland area could increase (at the cost of grazing lands)",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals = c(0, 10, 20, 60, 80, 100, Inf),
                     breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")))




```





# How much the efficiency changes?

Original protein from livestock and crops  = r_protein_combined_kg_perpix   ---> this set the base level
Optimized protein from livestock and crops = 
  increased protein from crops - decreased protein from livestock (different species) =
  new optimized protein yield of crops - new optimized protein yield of livestock

Then,
100 * (Optimized_prot - Original_prot) / Original_prot
tells how much more could be produced in %

- Consider areas where grazing land (gl can be converted to cl)
- Consider areas outside current cl areas


Example calculations:
Eläimet käyttävät 40% solusta ja tuottavat proteiinia solussa alun perin noin 35 kg/ha. Solun koko 8100ha. Eläimet tuottavat siis alun perin 113400 kg/pix
Kuten yllä, kasvit käyttävät 30% solusta, mutta SI mukaan voisivat käyttää 45%. Näin ollen 15% solun koosta pitäisi ottaa pois eläimiltä ja siirtää kasveille.

Viljojen uusi sato on siis alkuperäinen sato * (0.30 + (0.45-0.30))/0.30 ja 
eläinproteiinin uusi sato  alkuperäinen sato * (0.40 - (0.45-0.30))/0.40, jossa
(0.45-0.30) = fraction_gl_decrease

```{r}
r_fraction_gl_0toNA <- classify(r_fraction_gl, cbind(0,NA)) # not sure if needed
r_fraction_cl_0toNA <- classify(r_fraction_cl, cbind(0,NA))


# ------------------------------------------------------ optimized livestock
# gl area can decrease only in areas where there is some gl. Therefore mask to areas where there is gl 
r_optimized_protein_yield_livestock_kg_perpix <- # check the a4 notebook for this
  ((r_fraction_gl_0toNA - fraction_gl_declines_masked_to_gl) / r_fraction_gl_0toNA) * # if this row gets value = 1, then no changes
  r_protein_from_AGB_kg_perpix

names(r_optimized_protein_yield_livestock_kg_perpix) <- 
  names(r_protein_from_AGB_kg_perpix)


# ! calculate somewhere how much livestock produced protein decreases in grid cell !! ! !

global(r_optimized_protein_yield_livestock_kg_perpix, "sum", na.rm = T)/1e9 # 44 mmt, 9 mmt, 9 mmt --> was 49, 11 and 11 so not much diff
f_global_sum_without_outliers(r_optimized_protein_yield_livestock_kg_perpix$dairy)/1e9 # 36 8 8






# ------------------------------------------------------ optimized crops
# cl area can increase in areas outside current cl areas. We assume the median yield for the places where cl could expand.
# these areas can be found as follows: if r_fraction_cl_NAto0 == 0 but fraction_gl_declines_masked_to_gl > 0, there can be new cl.
# on these areas we use median yield to approximate potential yield
protein_yield_crops_median_kg_ha <- median(values(r_prot_allcrops_sum_kg_ha), na.rm = T) # 216



r_optimized_protein_yield_crops_mt_perpix <- 
  ifel(test = r_fraction_cl_NAto0 == 0  &  fraction_gl_declines_masked_to_gl > 0, # if there is possibility to expand cl on gl areas
       yes = (protein_yield_crops_median_kg_ha/1000) * fraction_gl_declines_masked_to_gl * # approximate yield to these areas
         cellSize(fraction_gl_declines_masked_to_gl, unit = "ha"),
       no = ((r_fraction_cl_NAto0 + fraction_gl_declines_masked_to_gl) / r_fraction_cl_NAto0) * r_prot_allcrops_sum_mt_perpix) # if cl > 0, then simply calculate the potential production on these areas

names(r_optimized_protein_yield_crops_mt_perpix) <- "crop_protein_mt"

global(r_optimized_protein_yield_crops_mt_perpix, "sum", na.rm = T)/1e6 # 485 mmt
f_global_sum_without_outliers(r_optimized_protein_yield_crops_mt_perpix)/1e6 # 307

# outliers need to be removed from r_optimized_protein_yield_crops_mt_perpix before plotting?




# test
 mask(fraction_gl_declines_masked_to_gl, r_fraction_cl_0toNA, inverse = T) %>% 
   plot(., main = "there are areas outside cl where crop prod could increase")
 
 
 

 
 # ------------------------------------------------- compare original yield to optimized yield
r_original_protein_yield_combined_kg_perpix <-
  r_protein_from_AGB_kg_perpix +
  1000 * r_prot_allcrops_sum_mt_perpix
 
r_optimized_protein_yield_combined_kg_perpix <-
   r_optimized_protein_yield_livestock_kg_perpix +
   1000*r_optimized_protein_yield_crops_mt_perpix


r_optimized_protein_yield_larger <-
  100*(r_optimized_protein_yield_combined_kg_perpix - r_original_protein_yield_combined_kg_perpix)/
  r_original_protein_yield_combined_kg_perpix



f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$dairy)/1e9 # 258 dairy
f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$beef)/1e9 # 236 beef
f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$sheep_and_goats)/1e9 # 236 sheep goat


f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$dairy)/1e9 # 330 dairy
f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$beef)/1e9 # 311 beef
f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$sheep_and_goats)/1e9 # 311 sheep goat



(plt_r_optimized_protein_yield_larger <-
      create_index_map(r_index = r_optimized_protein_yield_larger$dairy, 
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised protein production compared to original combined protein production \n (here dairy + crops considered)",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, 1, 20, 50, 1000, Inf),
                     breaknames = c("No change", "<20", "20-50", "50-100", ">100")))

 
```


#
