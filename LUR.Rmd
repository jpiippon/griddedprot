---
title: "LUR"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---

Present the results using LUR approach developed by Hannah van Zanten:
https://link.springer.com/article/10.1007/s11367-015-0944-1


# LUR in 2010 (current production considered)

```{r}
# ----------------------------------------------------------------------- LO
r_protein_from_065xAGB_kg_ha_forLUR <- r_protein_from_065xAGB_kg_ha$current_herd_str
  # first remove 0 values as they lead to Inf values
r_protein_from_065xAGB_kg_ha_forLUR[r_protein_from_065xAGB_kg_ha_forLUR < 0.001] <- 0.001

LO_i_current <- 1 / r_protein_from_065xAGB_kg_ha_forLUR # no digestibility needed
  # convert NA to 0 to make multiplication easier
LO_i_current_NAto0 <- classify(LO_i_current, cbind(NA, 0))
plot(LO_i_current_NAto0, main = "Lot of land needed to produce 1kg of protein in arid areas")



# ----------------------------------------------------------------------- HDP
HDP_i_current <- r_prot_allcrops_sum_kg_ha * 0.85 # !!!!!!!!!!!!!!!!!!!!!!!!!! edit 0.85
  # convert NA to 0 to make multiplication easier
HDP_i_current_NAto0 <- classify(HDP_i_current, cbind(NA, 0))
# How much crop protein from area that is needed to produce 1kg animalprot from AGB =  LO_i_current * HDP_i_current # unit is kg



# ----------------------------------------------------------------- denominator
  # "how much human digestible protein in 1 kg of animal protein
HDP_animal_prot_i_current <- 1 * 0.95 # !!!!!!!!!!!!!!!!!!!!!!!!!! edit 0.95


# ----------------------------------------------------------------- LUR
LUR_i_current <- 
  (LO_i_current_NAto0 * HDP_i_current_NAto0) /  # unit is kg
  HDP_animal_prot_i_current

  # mask to agricultural areas
LUR_i_current <-
  mask(LUR_i_current, r_fraction_gl_cl_total_0toNA)
names(LUR_i_current) <- "LUR"

# ----------------------------------------------------------------- LUR croplandmask
LUR_i_current_croplandmask <-
  mask(LUR_i_current, r_fraction_cl_0toNA)

LUR_i_current_outside_croplands <-
  mask(LUR_i_current, r_fraction_cl_0toNA, inverse = T)

# For Figures mask LUR to croplands with SI < 10
LUR_i_current_SIbelow10mask_croplandmask <-
  mask(LUR_i_current, SI_5arcmin_below10_croplandmask) # from comparisons.Rmd

# combine LUR rasters
LUR_current_combined <- 
  c(LUR_i_current,
    LUR_i_current_croplandmask,
    LUR_i_current_outside_croplands,
    LUR_i_current_SIbelow10mask_croplandmask)
names(LUR_current_combined) <- c("LUR", "LUR_cl_mask", "LUR_outside_cl", "LUR_SIbelow10clmask")




global(LUR_current_combined, fun = "mean", na.rm = T) # 5300, 9000, 0 respectively

df_LUR_current_combined <- 
  as.data.frame(LUR_current_combined, xy = T)
median(df_LUR_current_combined$LUR, na.rm = T) # 0
median(df_LUR_current_combined$LUR_cl_mask, na.rm = T) # 37
median(df_LUR_current_combined$LUR_SIbelow10clmask, na.rm = T) # 75

pal_protein_lajolla <- scico(n = 6, palette = "lajolla", end = 0.85) 

  # figures should be in Figures.Rmd
(plt_LUR_current <- # works when LUR layers have different names
  create_index_map(r_index = LUR_current_combined, 
                   tocrs = "ESRI:54030",
                   index_main_title = "Current LUR",
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                   breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100"))) 
  # high LUR near Sahara, in Saudi-Arabia -- checked that there's crop production




# LUR cons -- no significant difference to protein crops / protein animals
# r_protein_ratio <- 
#   classify(1000*r_prot_allcrops_sum_mt_perpix, cbind(NA,0)) /
#   classify(r_protein_from_065xAGB_kg_perpix$current_herd_str, cbind(NA,0)) 
# 
# (plt_r_protein_ratio <- 
#   create_index_map(r_index = r_protein_ratio, 
#                    tocrs = "ESRI:54030",
#                    index_main_title = "Just a protein ratio (calculated perpix)",
#                    index_label = "[LUR]",
#                    colorpal = pal_protein_lajolla,
                   # breakvals = c(0, 1, 10, 100, 250, 5000, Inf),
                   # breaknames = c("0-1","1-10","10-100",
                   #                "100-250","250-5000",  ">5000")))
# looks pretty similar when masked to correct areas
```



# LUR with different SI

Get data from suitabilities.Rmd

```{r}
# -------------------------------------------------------------- numerator
  # LO = land area needed to produce 1 kg of animal protein
  # = the same as with current production. Amount of AGB is the same regardless of out optimisation. Moreover, protein production capacity depends only on AGB and FCR of given cell. Therefore, LO is not affected by optimisation
LO_i_current_NAto0




# ----------------------------------------------------------------------- HDP
  # HDP = human-digestible protein that could be produced from the same area with direct cultivation of food crops
  # (e.g., 200 kg of protein per hectare). This is calculated using crop protein yields (in different SI classes) multiplied by their digestibility
r_optimised_protein_crops_mt_perpix <- 
  here("Data", "Intermediate_input", "r_optimised_protein_crops_mt_perpix.tif") %>%
  rast()


  


# Convert to kg per ha --> 
r_optimised_protein_crops_kg_ha <-
  (r_optimised_protein_crops_mt_perpix * 1000) /
  (cellSize(r_optimised_protein_crops_mt_perpix[[1]], unit = "ha") * 
     r_SIbased_restricted_max_cropland_fraction)

# convert negative values to zeros
rclmat_neg_to_zeros <- matrix(c(-Inf, 0, 0), ncol = 3, byrow = TRUE)

r_optimised_protein_crops_kg_ha <-
  classify(r_optimised_protein_crops_kg_ha,
           rclmat_neg_to_zeros, right = FALSE) # 

# convert Inf values to zeros (Inf values if r_SIbased_restricted_max_cropland_fraction_NAto0 = 0)
r_optimised_protein_crops_kg_ha <- classify(r_optimised_protein_crops_kg_ha, cbind(Inf, 0))

HDP_i_SI_based <- r_optimised_protein_crops_kg_ha * 0.85





# ----------------------------------------------------------------- denominator
  # should be different for different cells -- check fbs_animals_wide_filled$protein_fraction %>% hist()
HDP_animal_prot_i_current




# ---------------------------------------------------------------------- LUR
LUR_SI_based <- 
  (LO_i_current_NAto0 * HDP_i_SI_based) / 
  HDP_animal_prot_i_current


# now croplands are NA if SI increases. Those NA cells in agricultural land areas should get value 0 as LUR = 0 if crops cannot be produced
LUR_SI_based_NAto0 <- classify(LUR_SI_based, cbind(NA,0))
  # mask to procution areas
LUR_SI_based_NAto0 <- 
  mask(LUR_SI_based_NAto0, r_fraction_gl_cl_total_0toNA)


# writeRaster(LUR_SI_based_NAto0, 
#             here("Data", "Intermediate_input", "LUR_SI_based_NAto0.tif"),
#             overwrite = T)

################################### get the file
LUR_SI_based_NAto0 <-
  here("Data", "Intermediate_input", "LUR_SI_based_NAto0.tif") %>% 
  rast()
```

# Plot LUR

Find just ratios < 1 and maybe 1-10 and 100 and Inf?

```{r}
# maybe use bam?

# pal_test_bam <- scico(n =11, palette = "bam", inverse = T)
# pal_test_bam <- pal_test_bam[c(3,7,11)] # this to get light red, light and dark green values

(plt_LUR10 <- 
  create_index_map(r_index = LUR_SI_based_NAto0[[10]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>10 areas could be converted to croplands",
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                   breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100"))) 



(plt_LUR33 <- 
  create_index_map(r_index = LUR_SI_based_NAto0[[33]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>33 areas could be converted to croplands",
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                   breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100"))) 

(plt_LUR75 <- 
  create_index_map(r_index = LUR_SI_based_NAto0[[75]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>75 areas could be converted to croplands",
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                   breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100"))) 


(plt_LUR98 <- 
  create_index_map(r_index = LUR_SI_based_NAto0[[98]], 
                   tocrs = "ESRI:54030",
                   index_main_title = "LUR when SI>98 areas could be converted to croplands",
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                   breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100"))) 


plts_lur <-
  tmap_arrange(plt_LUR10, plt_LUR33, plt_LUR75, plt_LUR98, ncol = 2)
plts_lur

tmap_save(plts_lur, filename = here("Figures", "LUR_test_digest.pdf"))


# testaa animaatiota
LUR_SI_based_NAto0_rob <- project(LUR_SI_based_NAto0, "ESRI:54030") # 10 min



plts_lur_list <-
  lapply(1:nlyr(LUR_SI_based_NAto0_rob), function(i) {
    create_index_map(r_index = LUR_SI_based_NAto0_rob[[i]],
                   index_main_title = paste("LUR when SI >", i),
                   index_label = "[LUR]",
                   colorpal = pal_lur,
                  breakvals = c(0, 1, 10, 100,  Inf),
                    breaknames = c("0-1","1-10","10-100",">100")) # 1h

})


tmap_animation(plts_lur_list, width = 1200, height = 1000, delay = 20,dpi = 300,
               filename = here("Figures", "LUR_animation.gif"))

```


