---
title: "Supplementary"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---

# Raster showing abobeground fraction of the NPP
Based on Sun et al. https://link.springer.com/article/10.1007/s11427-020-1837-9



```{r}
#--------------------------- 5arcmin data created in E:input_data_processing.Rmd
data_all_but_animals_5arcmin <-
  here("Data", "Input", "art2_in_E",
       "data_all_but_animals_masked_where_pasture_every_year_2001_2020_5arcmin.tif") %>% 
  rast()

MAP <- data_all_but_animals_5arcmin$MAP
MAT <- data_all_but_animals_5arcmin$MAT

f_ANPP_fraction <-  (1 - (0.000000114*MAP^2 - 0.000307*MAP - 0.00665*MAT + 0.786))
  ## delete some negative values (somewhere in East Asia where it rains a lot)
ANPP_fraction <- f_ANPP_fraction
ANPP_fraction[ANPP_fraction < 0] <- NA ### !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! NOT NA ---> use 0 instead
plot(ANPP_fraction)

#writeRaster(ANPP_fraction, here("Data", "Supplementary", "fraction_of_NPP_aboveground.tif"))
global(ANPP_fraction, fun = "mean", na.rm = T) # 0.39

 ## average ANPP_fraction for Australia
ANPP_fraction %>% 
  crop_and_mask(adm10_simple_faoadded %>% filter(ADMIN == "Australia")) %>% 
  global(., fun = "mean", na.rm = T) # 0.47


# ------------------------------------------------------------ plot
pal_ANPP_fraction<-  scico(n = 7, palette = "hawaii", begin = 0.1, end = 0.8)


(plt_ANPP_fraction <- 
    create_index_map(r_index = ANPP_fraction,
                     tocrs = "ESRI:54030",
                     index_main_title = "Fraction of NPP allocated aboveground",
                     index_label = "",
                     colorpal = pal_ANPP_fraction,
                     breakvals = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, Inf),
                     breaknames = c("<0.1", "0.1-0.2","0.2-0.3",
                                    "0.3-0.4","0.4-0.5", "0.5-0.6", ">0.6"))) 
```


# Share of croplands and pasturelands in cell


```{r}


r_fractions_cl_gl_and_total <- c(
  r_fraction_gl_0toNA,
  r_fraction_cl_0toNA,
  r_fraction_gl_cl_total_0toNA
)

names(r_fractions_cl_gl_and_total) <- c(
  "Share of HYDE grazing lands in cell",
  "Share of cropland in cell", 
  "Share of grazing land and cropland combined (i.e. agricultural land) in cell")
  





  ## for supplementary fig, convert zeros to NA  ----> why?
#r_fractions_crops_and_grazing_lands[r_fractions_crops_and_grazing_lands == 0] <- NA

  ## combine fractions of crops in 5arcmin cells with fractions of pastures





pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1) 

(plt_shares_of_croplands_and_pasturelands <- 
    create_index_map(r_index = r_fractions_cl_gl_and_total*100,
                     tocrs = "ESRI:54030",
                     index_main_title = "Shares of croplands and grazing lands in 5 arc-minutes cells",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals =  c(0,10,20,40,60,80, Inf),
                     breaknames = c("0-10", "10-20","20-40","40-60","60-80", "80-100")) )





tmap_save(plt_shares_of_croplands_and_pasturelands,
          here("Figures", "Supplementary",
               "Shares of croplands and pasturelands in 5 arc-minutes cells.pdf"),
          width = 180, height = 150, units = "mm")
```



# Selected SPAM crops -Table S1

```{r}
#------------------------------------------------------ selected crops to data frame
library(flextable)

df_appendix_27crops <- fbs_crops_wide_filled %>% 
  filter(Area == "World") %>% 
  dplyr::select(Item, spamname) %>% 
  as_tibble() %>% 
  flextable(., cwidth = 2)
  

#save_as_image(df_appendix_27crops, path = here("Figures", "Supplementary", "selected_crops.png"))
save_as_docx(df_appendix_27crops, path = here("Figures", "Supplementary", "selected_crops.docx"))


```

