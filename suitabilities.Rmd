---
title: "Suitabilities"
author: "Johannes Piipponen"
date: "`r Sys.Date()`"
output: html_document
---
# Plot function chunk

```{r}



create_dynamic_index_map <- function(myraster, layer_num, main_title, 
                                     diff_breakvals = c(0, 10, 20, 60, 80, 100, Inf)) {
  
  plt_dynamic_map <- 
    create_index_map(r_index = myraster[[layer_num]], 
                     tocrs = "ESRI:54030",
                     index_main_title = sprintf(main_title, layer_num),
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals = diff_breakvals,
                     breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100"))
  return(plt_dynamic_map)
}





```


# Chunk1 Calculate total agricultural land area (grazing land (gl) and cropland (cl))
Grazing land gl + cropland cl


```{r}
# Crop production raster
  ## convert NA to 0 to make upcoming calculations easier
r_physical_areas_crops_sum_ha_perpix_NAto0 <- 
  classify(r_physical_areas_crops_sum_ha_perpix, cbind(NA,0))




  # gl and cl converted to 0 if NA vals -- otherwise there would be empty areas
r_fraction_gl_cl_total <- r_fraction_gl_NAto0 + r_fraction_cl_NAto0 # cannot be over 1!
r_fraction_gl_cl_total[r_fraction_gl_cl_total>1] <- 1
r_fraction_gl_cl_total_NAto0 <- classify(r_fraction_gl_cl_total, cbind(NA,0)) # totally same as above!
r_fraction_gl_cl_total_0toNA <- classify(r_fraction_gl_cl_total, cbind(0,NA))



# Plot these rasters
plot(r_fraction_cl, main = "cl frac")
plot(r_fraction_gl, main = "gl frac")
plot(r_fraction_gl_cl_total, main = "gl +cl frac") # tässä on kaikki mahdolliset alueet
plot(r_fraction_gl_cl_total_NAto0, main = "gl + cl frac NA to 0") # tässä on kaikki mahdolliset alueet
plot(r_fraction_gl_cl_total_0toNA, main = "gl + cl frac 0 to NA") # tässä on kaikki mahdolliset alueet


# # Defining a color palette for the plots
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1) 
```


# Chunk 2 Examine Zabel 2022 SI data

In this chunk, we are analyzing the Zabel 2022 SI data, specifically looking at version 3.0, overall suitability for the years 1980-2009 with current irrigation areas applied. The goal is to classify, aggregate, and resample the raster based on a threshold value.


```{r}
# Load SI data (requires .hdr file with the same name in the folder)
  # overall_suitability_hist1980_2009_all_rainfed.hdr
SI_30arcsec <- 
  here("Data", "Input", "Zabel22_SI", 
       "overall_suitability_hist1980_2009_current_irr_areas_applied.bil") %>% 
  rast()
plot(SI_30arcsec)

# Aggregate and resample the SI data to 5 arcmin resolution
SI_5arcmin <- aggregate(SI_30arcsec, fact = 10) %>% 
  resample(., template_rast_5arcmin)
names(SI_5arcmin) <- "overall_suitability"

# writeRaster(SI_5arcmin, filename = here("Data", "Input", "Zabel22_SI",
#                    "SI_5arcmin_overall_suitability_hist1980_2009_current_irr_areas_applied.tif"))







# !! Add here a short example showing what the function does


# function that produces raster that show how large fraction of a cell belongs to a spesific SI class

# Define a function to classify, aggregate, and resample the raster based on a threshold
f_classify_and_aggregate_resample <- function(threshold) {
  # Create a reclassification matrix with the given threshold
  rclmat <- matrix(c(threshold, Inf, 1), ncol = 3, byrow = TRUE)
  
  # Classify the raster using the reclassification matrix
  classified_raster <- classify(SI_30arcsec, rclmat, include.lowest = FALSE, others = 0)
  
  # Aggregate the classified raster by a factor of 10
  aggregated_raster <- aggregate(classified_raster, fact = 10, na.rm = TRUE)
  
  # Resample the aggregated raster using the template raster (5 arcmin resolution)
  resampled_raster <- resample(aggregated_raster, template_rast_5arcmin)
  
  # Return the resampled raster
  return(resampled_raster)
}

# Create a vector of threshold values from 1 to 100
threshold_values <- 1:100

# Apply the function for each threshold value and store the results in a list
result_list_SI_function <- 
  lapply(threshold_values,f_classify_and_aggregate_resample) # 1.5 hours

# Create a raster stack from the result list
r_SI_class_fraction <- rast(result_list_SI_function) 
names(r_SI_class_fraction) <- paste0("FracOfCellOvr", threshold_values)

r_SI_class_fraction


# writeRaster(r_SI_class_fraction, 
#             here("Data", "Intermediate_input", "Fract_of_cell_over_threshold_1to100_currentIrrig.tif"))
```




Chunk 3: Investigate how much more cropland could be available based on SI

In this chunk, we analyze how much more cropland area could be available within the different Suitability Index (SI) classes, under the assumption that the combined share of grazing lands and croplands within a cell must remain constant.

Mandatory assumption:
r_fraction_agrland_max <= r_fraction_gl + r_fraction_cl 
r_fraction_agrland_max <= r_fraction_gl_cl_total_0toNA

"To avoid the expansion of agricultural land we assumed that the combined share of grazing lands and croplands within a cell must remain constant. For instance, if a cell initially contains 40% grazing lands and 20% croplands, only 60% of the land area can be allocated for agricultural purposes (e.g., 50% crops and 10% grazing lands, if that is what the suitability indices suggest)."


```{r}
# example
# r_fraction_agrland_max1 <- 
#   ifel(r_SI_class_fraction[[1]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SI_class_fraction[[1]])


# do this for all the rasters
# Function to apply the ifel() operation on each raster layer
f_limit_agrland <- function(raster_layer) {
  ifel(raster_layer > r_fraction_gl_cl_total,
       r_fraction_gl_cl_total, 
       raster_layer)
}



# Apply the function to all 100 raster layers in r_SI_class_fraction
r_fraction_agrland_max <- lapply(r_SI_class_fraction, f_limit_agrland) %>% 
  rast() # takes 30min if r_SI_class_fractionnot in RAM
names(r_fraction_agrland_max) <- paste0("MaxFracOfCellOvr", threshold_values) 

# 
# writeRaster(r_fraction_agrland_max,
#             here("Data", "Intermediate_input", "Fraction_of_cropland_max_with_diff_SI.tif"),
#             overwrite = T)




r_fraction_agrland_max[[5]] %>% plot()

# convert NA to 0 to make upcoming calculations easier --- check if this is needed
r_fraction_agrland_max_NAto0 <- 
  classify(r_fraction_agrland_max, cbind(NA,0), filename =
             here("Data", "Intermediate_input", "Fraction_of_cropland_max_with_diff_SI_NAto0.tif"),
           overwrite = T)



  # alternative function
# f_fraction_agrland_max_i <- function(i) {
#   r_fraction_agrland_max_i <- 
#   ifel(r_SI_class_fraction[[i]] > r_fraction_gl_cl_total_0toNA,
#        r_fraction_gl_cl_total_0toNA, 
#        r_SI_class_fraction[[i]])
#   return(r_fraction_agrland_max_i)
# }
# 
# r_fraction_agrland_max_i <- lapply(threshold_values, f_fraction_agrland_max_i)
# names(r_fraction_agrland_max_i) <- paste0("MaxFracOfCellOvr", threshold_values)

r_SI_class_fraction[[10]] %>% plot()
r_fraction_agrland_max[[10]] %>% plot()

r_SI_class_fraction[[75]] %>% plot()
r_fraction_agrland_max[[75]] %>% plot()


# ---------------------------------------- Calculate how much this potential cropland area would be in hectares  
 # saadaanko laskettua summa joka eri luokalle? Eli kuinka paljon voisi olla sellaista croplandia, jonka SI on 10, kuinka paljon sellaista jonka SI 20 jne
  # cellsize with one layer
r_fraction_agrland_max_cellsize <- 
  cellSize(r_fraction_agrland_max$MaxFracOfCellOvr1,
           unit = "ha")


r_agrland_max_ha_perpix <-
  r_fraction_agrland_max *
  r_fraction_agrland_max_cellsize # Cellsize constant 

r_agrland_max_ha_perpix_NAto0 <- classify(r_agrland_max_ha_perpix, cbind(NA,0)) # maybe save this as well?


df_SI <-
  tibble(
    SI_class = threshold_values,
    agrLandMaxMha = pull(global(r_agrland_max_ha_perpix, fun = "sum", na.rm = T)/1e6),
    agrLandMax_fracMean = pull(global(r_fraction_agrland_max, fun = "mean", na.rm = T)/1e6)) 


ggplot(df_SI, aes(x = SI_class, y = agrLandMaxMha)) + geom_line() +
  labs(title = "Agricultural Land Within SI Class (mha)", x = "SI Class", y = "Total Sum (mha)")

ggplot(df_SI, aes(x = SI_class, y = agrLandMax_fracMean)) +
  geom_line() + labs(title = "Agricultural Land Within SI Class (mean fraction)", x = "SI Class", y = "Mean frac per class")


```



# Tutki luotuja rastereita
Rasteri siis näyttää kuinka suuri osuus solusta on kussakin kategoriassa
"fraction of cells where SI over 10" --> large area
"fraction of cells where SI over 75" --> small area



```{r}
# get rasters we created above
r_SI_class_fraction <- 
  here("Data", "Intermediate_input", "Fract_of_cell_over_threshold_1to100_currentIrrig.tif") %>% 
  rast()

r_fraction_agrland_max <- 
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_with_diff_SI.tif") %>% rast()


r_fraction_agrland_max_NAto0 <-
  here("Data", "Intermediate_input", "Fraction_of_cropland_max_with_diff_SI_NAto0.tif") %>% 
  rast()





selected_layers <- seq(10, 100, by = 20)
selected_rasters <- r_SI_class_fraction[[selected_layers]]
selected_rasters1 <- r_fraction_agrland_max[[selected_layers]]
selected_rasters2 <- r_agrland_max_ha_perpix[[selected_layers]]


plot(selected_rasters, main = "Unrestrcited fraction of suitable land in a cell")
plot(selected_rasters1, main = "Max fraction of agricultural land in a cell")
plot(selected_rasters2, main = "Ha of agricultural land in a cell")

# which.max(values(r_agrland_max_ha_perpix[[1]]))
# xyFromCell(r_agrland_max_ha_perpix[[1]], 4663878)


# ---------------- some more rasters
# r_potential_cropland_expansion_ha_perpix _positive <-
#   here("Data", "Intermediate_input", "r_potential_cropland_expansion_ha_perpix _positive.tif") %>% rast()
```


# Chunk 4 Potential cropland expansion in current production areas and beyond 
Hectares per pix and fractions of cell here

r_potential_cropland_expansion_ha_perpix 
-  rasteri kuvaa potentiaalista viljelymaan laajentumista hehtaareina jokaiselle pikselille laskettuna maksimaalisen viljelysmaan ja nykyisen viljelysmaan välisenä erona.


r_potential_cropland_expansion_fraction 
 -rasteri kuvaa potentiaalista viljelymaan laajentumista suhteessa nykyiseen viljelysmaan osuuteen (fraktioina). Laskettu maksimaalinen viljelysmaan - nykyisen viljelysmaan välisenä erona.


```{r}
# Calculate how much more cropland there could be in cells (croplands already use a lot of very suitable  land). Thus cropland area could be expanded by this many hectares at most (per pixel)
r_potential_cropland_expansion_ha_perpix  <-
  r_agrland_max_ha_perpix_NAto0  - r_physical_areas_crops_sum_ha_perpix_NAto0 

 

  # create reclassification matrix
rclmat_delete_negative <- matrix(c(-Inf, 0, NA), ncol = 3, byrow = TRUE)  

r_potential_cropland_expansion_ha_perpix <- 
  classify(r_potential_cropland_expansion_ha_perpix ,
           rclmat_delete_negative, right = FALSE)

# same as the slower option (5x more time)
# r_potential_cropland_expansion_ha_perpix _positive2 <- r_potential_cropland_expansion_ha_perpix 
# r_potential_cropland_expansion_ha_perpix _positive2[r_potential_cropland_expansion_ha_perpix _positive2 < 0] <- NA



# ------------------------------------------------------------------------- mask 
# Cropland expansion on cells where SPAM crops are not growing
r_potential_cropland_expansion_outside_croplands_ha_perpix  <-
  mask(r_potential_cropland_expansion_ha_perpix, 
       r_physical_areas_crops_sum_ha_perpix, inverse = T)


# Cropland expansion on cells where there is cropland
r_potential_cropland_expansion_croplandmask_ha_perpix <-
  mask(r_potential_cropland_expansion_ha_perpix, 
       r_physical_areas_crops_sum_ha_perpix)











# --------------------------------------------------------- fractions (was ha above)
# Etsi fraction jossa voitais tuottaa lisää. Eli potentiaalinen - nykyinen ala. 
# Äsken laskettiin hehtaarit
# r_fraction_agrland_max_NAto0 vai r_fraction_agrland_max?
r_potential_cropland_expansion_fraction  <-
  r_fraction_agrland_max_NAto0 - r_fraction_cl_NAto0 # jos pos voitaisiin tuottaa lisää. Jos neg nyt tuotetaan jo enemmän kuin SI puitteissa ehkä kannattaisi
  

  # del neg vals
  # note! When SI + + this potential fraction - - 
r_potential_cropland_expansion_fraction <- 
  classify(r_potential_cropland_expansion_fraction,
           rclmat_delete_negative, right = FALSE)

plot(r_potential_cropland_expansion_fraction[[75]])







# ----------------------------------Global sums -- 975.4735 Mha of cl originally
df_SI <- df_SI %>% 
  mutate(cl_potExpMha = 
           pull(global(r_potential_cropland_expansion_ha_perpix, 
                                    fun = "sum", na.rm = T)/1e6),
         cl_potExpMha_outside_cl = 
           pull(global(r_potential_cropland_expansion_outside_croplands_ha_perpix ,
                                              fun = "sum", na.rm = T)/1e6 ),
         cl_potExpMha_clMask = 
           pull(global(r_potential_cropland_expansion_croplandmask_ha_perpix ,
                                              fun = "sum", na.rm = T)/1e6),
         cl_PotExp_fracMean = 
           pull(global(r_potential_cropland_expansion_fraction, "mean", na.rm = T)))


```




# Chunk 5 Potential for increased agricultural production and cropland expansion



```{r}

# ---------------------------------------------------------------------- ratio
 # note that r_potential_cropland_expansion_fraction = r_fraction_agrland_max_NAto0 - r_fraction_cl_NAto0 
r_potential_cropland_expansion_ratio <-  
  r_potential_cropland_expansion_fraction / # = r_fraction_agrland_max_NAto0 - r_fraction_cl_NAto0
  r_fraction_cl_NAto0 


r_potential_cropland_expansion_ratio_croplandmask <- 
  mask(r_potential_cropland_expansion_ratio,
       r_physical_areas_crops_sum_ha_perpix)


r_potential_cropland_expansion_ratio_outside_croplands <- 
  mask(r_potential_cropland_expansion_ratio,
       r_physical_areas_crops_sum_ha_perpix, inverse = T)


# Calculate the percentage of cropland expansion ------------------- tarkista ettei jaeta kahteen kertaan





# ----------------------------------------------------------- plot
(plt_cl_incshare_nomask <- 
    create_dynamic_index_map(myraster = r_potential_cropland_expansion_ratio,
                             layer_num = 75,
                             main_title = "How much cl area could inc at cost of gl if all gl where SI > %d 'd be converted to cl",
                          diff_breakvals = c(0, 0.10, 0.20, 0.60, 0.80, 1.00, Inf)   ))




(plt_cl_incshare_croplandmask <-
    create_dynamic_index_map(myraster = r_potential_cropland_expansion_ratio_croplandmask,
                             layer_num = 75,
                             main_title = "same but cl mask",
                          diff_breakvals = c(0, 0.10, 0.20, 0.60, 0.80, 1.00, Inf)   ))


(plt_cl_incshare_outside_cl <-
    create_dynamic_index_map(myraster = r_potential_cropland_expansion_ratio_outside_croplands,
                             layer_num = 75,
                             main_title = "same but outside cl ",
                          diff_breakvals = c(0, 0.10, 0.20, 0.60, 0.80, 1.00, Inf)   ))







 ## kuinka paljon enemmän kasviprotskua voitaisiin tuottaa ----- ei järkevä koska näyttää cl alueet vain
  ## global() tätytyy laskea trim funktion avulla
# r_protein_prod_potentially_larger_on_croplands <- r_prot_allcrops_sum_mt_perpix * 
#   r_potential_cropland_expansion_ratio_croplandmask



```




# Chunk 6: Impact of cropland expansion on grazing land and protein production

If high suitability areas are allocated for crop cultivation, these areas will be taken away from some other land use. Are these areas currently used as grazing land? How much less protein would be produced from grazing lands if the full potential of high suitability areas is utilized for crop cultivation?



```{r}
# Calculate the fraction of grazing land decline by subtracting the current cropland fraction from the maximum allowable cropland fraction
##### r_fraction_gl_declines <- r_potential_cropland_expansion_fraction
# r_fraction_gl_declines <-  
#   r_fraction_agrland_max_NAto0 - 
#   r_fraction_cl_NAto0 # !! note that r_potential_cropland_expansion_fraction  <-  r_fraction_agrland_max_NAto0 - r_fraction_cl_NAto0 # eli ihan sama

  ## Nykyisestä laitumesta vähennetään se osuus, jonka kasvintuotantoala voisi kasvaa. Se voisi kasvaa nykyisestä r_fraction_agrland_max_NAto0 saakka, eli r_fraction_agrland_max_NAto0 - r_fraction_cl_NAto0 verran
  ## jos negatiivinen, nii tällä hetkellä solussa enemmän tuotantoa kuin mitä SI perusteella pitäis --> laitetaan nollaksi
  ## toisaalta neg arvo kertoo missä gl osuus voisi kasvaa! --> nämä parempi löytää etsimällä alueet, joilla SI pieni

# Remove negative values to set any areas where the current production is already higher than suggested by the suitability index to zero
##### r_fraction_gl_declines <- r_potential_cropland_expansion_fraction
# r_fraction_gl_declines <- classify(
#   r_fraction_gl_declines,
#   rclmat_delete_negative,
#   right = FALSE)

r_potential_grazingland_reduction_fraction <- r_potential_cropland_expansion_fraction # only pos vals


# Mask the grazing land declines to only areas with grazing land
  # global sum of this  is the same with r_potential_cropland_expansion_fraction
  # also plot is similar - just NA vals is different
r_potential_grazingland_reduction_fraction_glmask <- 
  mask(r_potential_grazingland_reduction_fraction,
       r_fraction_gl_0toNA)




# Calculate the ratio of grazing land reduction
r_potential_grazingland_reduction_ratio <- 
  r_potential_grazingland_reduction_fraction_masked_to_gl /
  r_fraction_gl_NAto0



# Calculate the percentage of grazing land decline
r_how_many_percent_gl_should_decline <- 
  100*r_potential_grazingland_reduction_fraction_masked_to_gl /
  r_fraction_gl_0toNA # !!!!!!!!!!!!!!!!!!! meneekö nyt pieleen jos jaetaan liian monta kertaa tällä?
#r_how_many_percent_gl_should_decline_0toNA <- classify(r_how_many_percent_gl_should_decline, cbind(0,NA)) # why?


# -------------------------------------------------Plot (this is now in figures)


# ex plot -- raster was r_how_many_percent_gl_should_decline_0toNA but then it masks out many important gl areas
(plt_gl_decline_example <- create_dynamic_index_map(r_how_many_percent_gl_should_decline, 75,
"How much gl area should decline (to make space for crops) - when areas where SI>%d'd be converted to cl"))





# ---------------------------------------------------------- same for the crops
r_how_many_percent_cl_should_increase <- 
  100*(r_potential_cropland_expansion_fraction) / r_fraction_cl_NAto0 # if this would be 0toNA, only cl areas here
#r_how_many_percent_cl_should_increase_0toNA <- classify(r_how_many_percent_cl_should_increase, cbind(0,NA))

# same but cl mask
r_how_many_percent_cl_should_increase_croplandmask <- 
  100*(r_potential_cropland_expansion_fraction) / r_fraction_cl_0toNA





# plot ex. Raster was r_how_many_percent_cl_should_increase_0toNA but that is not needed
(plt_cl_increase <- create_dynamic_index_map(r_how_many_percent_cl_should_increase, 75,
"How much cl area could inc at cost of gl if all gl where SI > %d 'd be converted to cl"))


(plt_cl_increase_clmask <- create_dynamic_index_map(r_how_many_percent_cl_should_increase_croplandmask, 75,
"How much cl area could inc at cost of gl if gl on croplands where SI > %d 'd be converted to cl"))


df_SI <- df_SI %>% 
  mutate(gl_PotDec_fracMean_glmask  = pull(global(r_fraction_gl_declines_masked_to_gl, "mean", na.rm = T)),
         gl_areaPercent_decMean = pull(global(r_how_many_percent_gl_should_decline, "mean", na.rm = T)),
         cl_areaPercent_incMean = pull(global(r_how_many_percent_cl_should_increase, "mean", na.rm = T)))


```


# How much the efficiency changes?

Original protein from livestock and crops  = r_protein_combined_kg_perpix   ---> this set the base level
Optimized protein from livestock and crops = 
  increased protein from crops - decreased protein from livestock (different species) =
  new optimized protein yield of crops - new optimized protein yield of livestock
  
Then,
100 * (Optimized_prot - Original_prot) / Original_prot
tells how much more could be produced in %

- Consider areas where grazing land (gl can be converted to cl)
- Consider areas outside current cl areas


Example calculations:
Eläimet käyttävät 40% solusta ja tuottavat proteiinia solussa alun perin noin 35 kg/ha. Solun koko 8100ha. Eläimet tuottavat siis alun perin 113400 kg/pix
Kuten yllä, kasvit käyttävät 30% solusta, mutta SI mukaan voisivat käyttää 45%. Näin ollen 15% solun koosta pitäisi ottaa pois eläimiltä ja siirtää kasveille.

Viljojen uusi sato on siis alkuperäinen sato * (0.30 + (0.45-0.30))/0.30 ja 
eläinproteiinin uusi sato  alkuperäinen sato * (0.40 - (0.45-0.30))/0.40, jossa
(0.45-0.30) = fraction_gl_decrease

```{r}
# ------------------------------------------------------ optimized livestock
# gl area can decrease only in areas where there is some gl. Therefore mask to areas where there is gl 
r_optimized_protein_yield_dairy_kg_perpix <- # check the a4 notebook for this
  ((r_fraction_gl_0toNA - r_fraction_gl_declines_masked_to_gl) / r_fraction_gl_0toNA) * # if this row gets value = 1, then no changes
  r_protein_from_065xAGB_kg_perpix$dairy

## del neg
r_optimized_protein_yield_dairy_kg_perpix <- 
  classify(r_optimized_protein_yield_dairy_kg_perpix,
           rclmat_delete_negative, right = FALSE)


names(r_optimized_protein_yield_dairy_kg_perpix) <- paste0("dprot_kgpix_SI", threshold_values)
# Calculate global sums somewhere
  # check
r_optimized_protein_yield_dairy_kg_perpix$dprot_kgpix_SI5 %>% plot(., main = "when SI>5 vals 'd be used for cl, much less asf as ")
r_optimized_protein_yield_dairy_kg_perpix$dprot_kgpix_SI95 %>% plot(., main = "when SI>95 vals 'd be used for cl, not much gl to be converted cl")
r_protein_from_065xAGB_kg_perpix$dairy %>% plot(., main = "original dairy prot raster")

global(r_optimized_protein_yield_dairy_kg_perpix$dprot_kgpix_SI5, fun = "sum", na.rm = T)/1e6
global(r_optimized_protein_yield_dairy_kg_perpix$dprot_kgpix_SI95, fun = "sum", na.rm = T)/1e6
global(r_protein_from_065xAGB_kg_perpix$dairy, fun = "sum", na.rm = T)/1e6



# ------------------------------------------------------ optimized crops
# cl area can increase in areas outside current cl areas. 
# these areas can be found as follows: if r_fraction_cl_NAto0 == 0 but r_fraction_gl_declines_masked_to_gl > 0, there can be new cl.
# We assume that crop yield on those areas can be predicted using linear regression where crop protein yield is explained with SI.
r_suitability_filled <- 
  rasterize(updated_regression_results, r_fraction_gl_declines_masked_to_gl, field="estimate_suitability_filled")

r_intercept_filled <- 
  rasterize(updated_regression_results, r_fraction_gl_declines_masked_to_gl, field="estimate_intercept_filled")



r_optimized_protein_yield_crops_mt_perpix <-
  ifel(test = r_fraction_cl_NAto0 == 0  &  r_fraction_gl_declines_masked_to_gl > 0, # if there is possibility to expand cl on gl areas
       yes = (r_intercept_filled + r_suitability_filled * SI_5arcmin), # approximate yield to these areas
       no = ((r_fraction_cl_NAto0 + r_fraction_gl_declines_masked_to_gl) / r_fraction_cl_NAto0) * r_prot_allcrops_sum_mt_perpix)
# if cl > 0, then simply calculate the potential production on these areas


# laske sadot tän esimerkin mukaan
# global(r_optimized_protein_yield_crops_mt_perpix, "sum", na.rm = T)/1e6 # 485 mmt
# f_global_sum_without_outliers(r_optimized_protein_yield_crops_mt_perpix)/1e6 # 307

```


# ---------------------------------------------------------- vahnaa
# grazing & SI0ver75 kilpailu
```{r}
fraction_cl_increases <- fraction_gl_declines # same as   r_fraction_SIover75_max - r_fraction_cl_NAto0
#fraction_cl_increases_masked_to_cl <- mask(fraction_cl_increases, r_fraction_cl) # this is probably not needed!


# Kuinka monta % enemmän viljaa voitaisiin tuottaa ---------- laskettu yllä ---- miksi maskattu vain cl alueille? Voi kai laajentua niiden ulkopuolelle
# cl area can increase in areas outside current cl areas, hoiwever, we don't know what would be the crop yield there
  ## therefore concentrate only on current cl areas for now ---- !! use average crops yields outside those areas
r_how_many_percent_cl_should_increase <- 
  100*(fraction_cl_increases) / r_fraction_cl_NAto0

r_how_many_percent_cl_should_increase <- classify(r_how_many_percent_cl_should_increase, cbind(0,NA))
# this is bit different than above
(plt_percent_cl_should_increase <- 
    create_index_map(r_index = r_how_many_percent_cl_should_increase, 
                     tocrs = "ESRI:54030",
                     index_main_title = "How much cropland area could increase (at the cost of grazing lands)",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals = c(0, 10, 20, 60, 80, 100, Inf),
                     breaknames = c("<10", "10-20", "20-60", "60-80", "80-100", ">100")))




```

# How much the efficiency changes?

```{r}

# ------------------------------------------------------ optimized livestock
# gl area can decrease only in areas where there is some gl. Therefore mask to areas where there is gl 
r_optimized_protein_yield_livestock_kg_perpix <- # check the a4 notebook for this
  ((r_fraction_gl_0toNA - fraction_gl_declines_masked_to_gl) / r_fraction_gl_0toNA) * # if this row gets value = 1, then no changes
  r_protein_from_AGB_kg_perpix

names(r_optimized_protein_yield_livestock_kg_perpix) <- 
  names(r_protein_from_AGB_kg_perpix)


# ! calculate somewhere how much livestock produced protein decreases in grid cell !! ! !

global(r_optimized_protein_yield_livestock_kg_perpix, "sum", na.rm = T)/1e9 # 44 mmt, 9 mmt, 9 mmt --> was 49, 11 and 11 so not much diff
f_global_sum_without_outliers(r_optimized_protein_yield_livestock_kg_perpix$dairy)/1e9 # 36 8 8






# ------------------------------------------------------ optimized crops
# cl area can increase in areas outside current cl areas. We assume the median yield for the places where cl could expand.
# these areas can be found as follows: if r_fraction_cl_NAto0 == 0 but fraction_gl_declines_masked_to_gl > 0, there can be new cl.
# on these areas we use median yield to approximate potential yield
protein_yield_crops_median_kg_ha <- median(values(r_prot_allcrops_sum_kg_ha), na.rm = T) # 216



r_optimized_protein_yield_crops_mt_perpix <- 
  ifel(test = r_fraction_cl_NAto0 == 0  &  fraction_gl_declines_masked_to_gl > 0, # if there is possibility to expand cl on gl areas
       yes = (protein_yield_crops_median_kg_ha/1000) * fraction_gl_declines_masked_to_gl * # approximate yield to these areas
         cellSize(fraction_gl_declines_masked_to_gl, unit = "ha"),
       no = ((r_fraction_cl_NAto0 + fraction_gl_declines_masked_to_gl) / r_fraction_cl_NAto0) * r_prot_allcrops_sum_mt_perpix) # if cl > 0, then simply calculate the potential production on these areas

names(r_optimized_protein_yield_crops_mt_perpix) <- "crop_protein_mt"

global(r_optimized_protein_yield_crops_mt_perpix, "sum", na.rm = T)/1e6 # 485 mmt
f_global_sum_without_outliers(r_optimized_protein_yield_crops_mt_perpix)/1e6 # 307

# outliers need to be removed from r_optimized_protein_yield_crops_mt_perpix before plotting?




# test
 mask(fraction_gl_declines_masked_to_gl, r_fraction_cl_0toNA, inverse = T) %>% 
   plot(., main = "there are areas outside cl where crop prod could increase")
 
 
 

 
 # ------------------------------------------------- compare original yield to optimized yield
r_original_protein_yield_combined_kg_perpix <-
  r_protein_from_AGB_kg_perpix +
  1000 * r_prot_allcrops_sum_mt_perpix
 
r_optimized_protein_yield_combined_kg_perpix <-
   r_optimized_protein_yield_livestock_kg_perpix +
   1000*r_optimized_protein_yield_crops_mt_perpix


r_optimized_protein_yield_larger <-
  100*(r_optimized_protein_yield_combined_kg_perpix - r_original_protein_yield_combined_kg_perpix)/
  r_original_protein_yield_combined_kg_perpix



f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$dairy)/1e9 # 258 dairy
f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$beef)/1e9 # 236 beef
f_global_sum_without_outliers(r_original_protein_yield_combined_kg_perpix$sheep_and_goats)/1e9 # 236 sheep goat


f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$dairy)/1e9 # 330 dairy
f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$beef)/1e9 # 311 beef
f_global_sum_without_outliers(r_optimized_protein_yield_combined_kg_perpix$sheep_and_goats)/1e9 # 311 sheep goat



(plt_r_optimized_protein_yield_larger <-
      create_index_map(r_index = r_optimized_protein_yield_larger$dairy, 
                     tocrs = "ESRI:54030",
                     index_main_title = "Optimised protein production compared to original combined protein production \n (here dairy + crops considered)",
                     index_label = "%",
                     colorpal = pal_share_nuuk,
                     breakvals = c(-Inf, 1, 20, 50, 1000, Inf),
                     breaknames = c("No change", "<20", "20-50", "50-100", ">100")))

 
```



# Ggplot

```{r}
df_SI_long <- pivot_longer(df_SI, cols = -SI_class, names_to = "Variable", values_to = "Value")


ggplot(df_SI_long, aes(x = SI_class, y = Value, color = Variable)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(0, 100, 5), name = "SI Class") +
  scale_y_continuous(name = "Million of ha") +
  labs(title = "Comparison of Different SI Classes",
       subtitle = "AgrLandMax, Cl PotExpMha, Cl PotExpMha OutsideCl, and Cl PotExpMha ClMask") +
  theme_classic() 
```

