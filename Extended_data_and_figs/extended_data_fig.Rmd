# Extended data

## Palettes and functions

```{r}
pal_npp <- scico(n = 5,begin = 0.6, end = 1, palette = "corkO")
pal_agb <- scico(n = 6, palette = "bamako", direction = -1)
pal_protein_lajolla <- scico(n = 6, palette = "lajolla", begin = 0.15, end = 1, direction = -1)
pal_share_nuuk <- scico(n = 7, palette = "nuuk",  direction = -1) 
pal_share <-  scico(n = 6, palette = "roma", begin = 0.1, end = 0.9, direction = -1) 
pal_fcr <- scico(n = 6, palette = "tokyo", direction = -1)
pal_fcr <-c("#C6DBEF", "#6BAED6", "#4292C6", "#2171B5", "#08519C", "#08306B") # maybe more clear
pal_lur <- scico(n =4, palette = "imola", direction = -1) 
pal_cv <-  scico(n = 6, palette = "nuuk", direction = -1)

# test
pal_protein_test <- 
  c("#66c2a5", "#a6d854", "#fee08b", "#fdae61", "#f46d43", "#d53e4f")



# function for plotting -- raster downsample = F
create_index_map <- function(r_index, index_label,index_main_title,
                             colorpal, breakvals,
                             breaknames = NULL,
                             color_midpoint = NULL, tocrs = NA, colorNA = NULL){
  if (!is.na(tocrs)){
    r_index <- project(r_index, tocrs, mask = TRUE)
  }
  index_map <- tm_shape(r_index,
                        raster.downsample = FALSE) + ###### or 0 instead?
    tm_raster(palette = colorpal, # try style = "fixed", 
              breaks = breakvals,
              labels = breaknames,
              title = index_label,
              midpoint = color_midpoint,
              colorNA = colorNA,
              legend.is.portrait = FALSE) + # added 9.8.22
            #  legend.reverse = TRUE) + # deleted 9.8.22
    tm_layout(main.title = index_main_title,
              main.title.position = "center",
              main.title.size = 1,
              legend.bg.color = TRUE,
              legend.outside = TRUE,
              legend.title.size = 1,
              legend.text.size = 1,
              legend.outside.size = 0.2,
              legend.outside.position = "bottom", # added 9,8
              frame = FALSE)+
    tm_shape(adm10_simple_faoadded_rob) + # was reg_rob_simple
    tm_borders(col = NA,  lwd = 0.33)  # lwd was 0.33, col was "grey30",
  
  return (index_map)
} 



f_save_pngs_extended_figs <- function(i, fig_folder) {
  
  # Create the directory if it doesn't exist
  if (!dir.exists(here("Extended_data_and_figs", "extended_figs", fig_folder))) {
    dir.create(here("Extended_data_and_figs", "extended_figs", fig_folder), recursive = TRUE)
  }
  
  # Generate the plot and save it
  p_fig <- layers[[i]] + tm_layout(legend.show = FALSE)
  tmap_save(p_fig, 
            filename = here("Extended_data_and_figs", "extended_figs", fig_folder, paste0('Extfig_', nameLayers[i], '.png')), 
            width = 110, units = 'mm', dpi = 450)
}


```




## Extended Data Fig. 1 

- FCR, SI, gl_fraction, cl_fraction at least


```{r}
# Ext fig 1 - FCR
(plt_fcrs <- 
    create_index_map(r_index =  r_fcr, # or mask to the study area?
                     tocrs = "ESRI:54030",
                     index_main_title = "Grass-feed based feed conversion ratios (FCR)",
                     index_label = "[kg AGB / kg protein]",
                     colorpal = pal_fcr, # try blues here?
                     breakvals = c(-Inf,100,200, 300,400,500,Inf),
                     breaknames = c("<100","100-200","200-300","300-400","400-500", ">500"))) 


# Ext fig 2 - SI
SI_5arcmin <- 
  here("Data", "Input", "from_harddrive",
       "SI_5arcmin_overall_suitability_subset1to17_2010-2039_rcp8p5_rainfed.tif") |> 
  rast()

SI_5arcmin_0_toNA <- classify(SI_5arcmin, cbind(0, NA)) # because we dont want to plot no-suitable land
# pal_SI <- scico(n =3, palette = "bam", begin = 0.6)
# pal_SI <- scico(n =11, palette = "bam")
# pal_SI <- pal_SI[c(3,7,11)] # this to get light red, light and dark green values

(plt_SI_v3.0 <- create_index_map(r_index = SI_5arcmin_0_toNA, tocrs = "ESRI:54030",
                     index_main_title = "Overall suitability indices (SI) for food crops 2010-2039 rcp8pv",
                     index_label = "",
                     colorpal = pal_agb,
                     breakvals =  c(1, 33, 75, Inf),
                     breaknames = c("Marginally suitable (1 < SI < 33 )", 
                                    "Moderately suitable (33 <= SI <= 75 )", "Highly suitable (SI > 75)")) )



# Ext fig 2 - fractions

r_fraction_gl_HYDE <-
  here("Data", "Input", "from_harddrive",
       "fraction_of_cell_that_is_hyde_grazingland2020_0toNA.tif") %>%   #### changed
  rast() # includes corn belt as this is HYDE based gl
r_fraction_gl_HYDE_0toNA <- 
  classify(r_fraction_gl_HYDE, cbind(0,NA))



  

(plt_share_of_HYDE_gl_2020 <- 
    create_index_map(r_index = r_fraction_gl_HYDE_0toNA*100,
                     tocrs = "ESRI:54030",
                     index_main_title = "Share of HYDE 3.3. grazing land in a cell in 2020",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals =  c(0,10,20,40,60,80, Inf),
                     breaknames = c("0-10", "10-20","20-40","40-60","60-80", "80-100")) )


(plt_share_of_cl_2020 <- 
    create_index_map(r_index = r_fraction_cl_0toNA*100,
                     tocrs = "ESRI:54030",
                     index_main_title = "Share of cropland (27 SPAM crops) in a cell in 2020",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals =  c(0,10,20,40,60,80, Inf),
                     breaknames = c("0-10", "10-20","20-40","40-60","60-80", "80-100")) )



(plt_share_of_gl_this_study <- 
    create_index_map(r_index = r_fraction_gl_HYDE_0toNA*100,
                     tocrs = "ESRI:54030",
                     index_main_title = "Share of grazing land in this study",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals =  c(0,10,20,40,60,80, Inf),
                     breaknames = c("0-10", "10-20","20-40","40-60","60-80", "80-100")) )


(plt_share_of_agricultural_land_2020 <-
    create_index_map(r_index = r_fraction_gl_cl_total_0toNA*100,
                     tocrs = "ESRI:54030",
                     index_main_title = "Share of agricultural land (gl and cl combined) in a cell in 2020",
                     index_label = "",
                     colorpal = pal_share_nuuk,
                     breakvals =  c(0,10,20,40,60,80, Inf),
                     breaknames = c("0-10", "10-20","20-40","40-60","60-80", "80-100")) )





# --------------------------------------------------------- combine plots
plt_extended_data_fig1 <- tmap_arrange(
  plt_fcrs, 
  plt_SI_v3.0, 
  plt_share_of_HYDE_gl_2020,
  plt_share_of_cl_2020,
  plt_share_of_gl_this_study, 
  plt_share_of_agricultural_land_2020,
  ncol = 2)

plt_extended_data_fig1

tmap_save(plt_extended_data_fig1, 
          filename = here("Extended_data_and_figs", "extended_figs", "Extended_data_fig1.png"))

tmap_save(plt_extended_data_fig1, 
          filename = here("Extended_data_and_figs", "extended_figs", "Extended_data_fig1.pdf"), dpi = 600)




```



## Extended Data Fig. 2  - uncertainty

```{r}
# Get simulated AGB data
AGB_simulated <- 
  here("Data", "Input", "from_harddrive", 
       "simulation_results_where_igbp6to10or16gl_every_year_2001_2020_5arcmin_AGBunit_kg_ha_n1000.tif") %>% 
  rast() ### this was in 4TB disk


  # convert to df
df_sim <-   AGB_simulated %>%
  as.data.frame(., xy = T) %>%
  as_tibble()

# calculate Interannual variability for AGB --> done for all years
agb_iv <- df_sim %>%
  dplyr::select(contains("agb_med")) %>%
  mutate(iv_agb = 100* as.matrix(.) %>% rowcvs()) %>%
  bind_cols(df_sim %>% dplyr::select(x,y)) %>%  # get the coordinates
  dplyr::select(x,y, iv_agb) %>%
  rast(., type = "xyz", crs = "EPSG:4326") %>%
  resample(., template_rast_5arcmin)


  ## calculate CV for AGB --> done for all years
agb_cv_vars <- df_sim %>%
  #dplyr::select(agb_cv_2008,agb_cv_2009,agb_cv_2010, agb_cv_2011,agb_cv_2012)
   dplyr::select(contains("agb_cv")) 

agb_cv_2001_2020 <- agb_cv_vars %>%
  mutate(agb_cv_average = rowMedians(as.matrix(agb_cv_vars),na.rm = TRUE)) %>%
  bind_cols(df_sim %>% dplyr::select(x,y)) %>%
  dplyr::select(x,y, agb_cv_average) %>%
  rast(., type = "xyz", crs = "EPSG:4326") %>%
  resample(., template_rast_5arcmin)


# Plot
  ## Interannual variability
(plt_agb_iv <- 
  create_index_map(r_index = agb_iv,
                   tocrs = "ESRI:54030",
                   index_main_title = "Interannual variability in aboveground biomass (AGB ) over 2001âˆ’2020 [%]",
                   index_label = "Interannual variability in % (median 21%)",
                   colorpal = pal_cv,
                   breakvals = c(0,10,20,30,40,50,Inf),
                   breaknames = c("< 10",
                                  "10-20",
                                  "20-30",
                                  "30-40",
                                  "40-50",
                                  "> 50"))) 


(plt_agb_cv<-
  create_index_map(r_index = agb_cv_2001_2020*100,
                   tocrs = "ESRI:54030",
                   index_main_title = "Uncertainty related to median AGB\n over 2001-2020 measured with coefficient of variation (CV)",
                   index_label = "CV in % (median 41%)",
                   colorpal = pal_cv,
                   breakvals = c(0,10,20,30,40,50,Inf),
                   breaknames = c("< 10",
                                  "10-20",
                                  "20-30",
                                  "30-40",
                                  "40-50",
                                  "> 50"))) 




plts_agbIV_agbCV <- tmap_arrange(
  plt_agb_iv,
  plt_agb_cv,
  ncol = 2
)
plts_agbIV_agbCV

tmap_save(plts_agbIV_agbCV, 
          here("Extended_data_and_figs", "extended_figs", "agbIV_agbCV_in_IGBP_areas.pdf"))

tmap_save(plts_agbIV_agbCV, 
          here("Extended_data_and_figs", "extended_figs", "agbIV_agbCV_in_IGBP_areas.png"))



# Median values for IV and CV
median(values(agb_iv, na.rm = TRUE)) # 21
median(values(agb_cv_2001_2020, na.rm = TRUE)) # 41



```


## Extended Data Fig. 3  - 21 / 27 nutrients & priority conservation areas

see "supplementary_plot_nutrients.Rmd"

Additionally, we targeted areas where changes would not significantly harm the production of other nutrients, focusing on regions where the production of 21 out of 27 other nutrients remained stable or increased following the land use change 


```{r}
plot(r_nutrient_yield_change_between_existing_to_AlltoGL_recoded_sum_gte21)
plot(r_nutrient_yield_change_between_existing_to_AlltoCL_recoded_sum_gte21)

test <- 
  classify(r_nutrient_yield_change_between_existing_to_AlltoGL_recoded_sum_gte21, cbind(NA,0)) +
  classify(r_nutrient_yield_change_between_existing_to_AlltoCL_recoded_sum_gte21, cbind(NA,0)) 
plot(test, main = "Areas where 21 out of 27 nutrients remain stable or increase after land use change")

breaknames_updated <- c("No potential", 
                        "Moderate potential", 
                        "High potential", 
                        "Very high potential") 


pal_AlltoCL <- c("#e0e0e0", "#9CE2D5", "#6DCBD6", "#3B567A")
pal_AlltoGL <- c("#e0e0e0", "#eae8a4", "#eac324", "#cc6633")


# All to CL
(plt_AlltoCL_plus21nutrients_not_decreasing <-
  create_index_map(r_index = protein_and_kcal_AlltoCL_recoded_fixed_21nutrients_not_decreasing,
                   tocrs = "ESRI:54030",
                   index_main_title = "", # Land use shifts for increased protein and energy under scenario 'All to cropland' (All to CL), while maintaining nutrient balance
                   index_label = "",
                   colorpal = pal_AlltoCL,
                    breakvals = c(-Inf, -554, 2, 778, Inf),
                   breaknames = breaknames_updated))

# All to GL
(plt_AlltoGL_plus21nutrients_not_decreasing <-
  create_index_map(r_index = protein_and_kcal_AlltoGL_recoded_fixed_21nutrients_not_decreasing,
                   tocrs = "ESRI:54030",
                   index_main_title = "", # Land use shifts for increased protein and energy under scenario 'All to grazing land' (All to GL), while maintaining nutrient balance
                   index_label = "",
                   colorpal = pal_AlltoGL,
                   breakvals = c(-Inf, 6, 8, 12, Inf),
                   breaknames = breaknames_updated))



# Priority conservation regions (now in 11_reality_check_map)
r_areas_where_conversion_not_realistic_combined_5arcmin_NAto0 <- 
  ifel(is.na(r_areas_where_conversion_not_realistic_combined_5arcmin), 
       0,
       r_areas_where_conversion_not_realistic_combined_5arcmin) |> 
  mask(r_fraction_gl_cl_total_0toNA)



(plt_priority_conservation_areas <- 
    create_index_map(r_index = r_areas_where_conversion_not_realistic_combined_5arcmin_NAto0, 
                     tocrs = "ESRI:54030",
                     index_main_title = "", #Conservation priority regions within our study area
                     index_label = "",
                     colorpal = c("#3B567A", "#e0e0e0"), # option c("#436D81", "#FEFEB2"), 
                     breakvals =  c(-Inf, 0.1, Inf ), 
                     breaknames = c("Other areas", "Priority area")))



# Combine plots
plts_ext_data_fig_3 <-
  tmap_arrange(
    plt_AlltoCL_plus21nutrients_not_decreasing,
    plt_AlltoGL_plus21nutrients_not_decreasing,
    plt_priority_conservation_areas,
    ncol = 3
  )

tmap_save(plts_ext_data_fig_3, 
          here("Extended_data_and_figs", "extended_figs", "Extended Data Fig 3.pdf"))



# Link to Illustrator
layers <- list(
  plt_AlltoCL_plus21nutrients_not_decreasing, 
  plt_AlltoGL_plus21nutrients_not_decreasing, 
  plt_priority_conservation_areas
)

nameLayers <- c(
  "AlltoCL_plus21nutrients_not_decreasing",
  "AlltoGL_plus21nutrients_not_decreasing",
  "priority_conservation_areas"
)

map(1:length(layers), ~f_save_pngs_extended_figs(.x, "Ext_Fig3")) 

```



